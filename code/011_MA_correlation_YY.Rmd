---
title: "Untitled"
author: "Yingjie"
date: "`r Sys.Date()`"
output: html_document
---
```{r}
# install.packages("openxlsx")
```



# Setup 
```{r, include=FALSE}
### To clear your environment
# remove(list = ls())

# load the metafor package
library(metafor)
library(googlesheets4)
library(rprojroot)
library(tidyverse)
library(stringr)
library(splitstackshape) ## `cSplit()`
library(Hmisc)
library(rworldmap)
library(ggpubr)
library(openxlsx)
library(metafor)


today <- format(Sys.time(), "%Y%m%d"); today ## "%Y%m%d%H%M"

# setwd(dir.root)
getwd()
# path in my own laptop
# dir.raw   <- "E:/R/meta_mental wellbeing/source/"
dir_share <- './data/YY/'
dir.fig   <- dir_share
# dir.report <- paste0('E:/R/meta_mental wellbeing/meta-analysis-nature-health-main/figures');
dir.report <- dir.fig
dir.MA.output <- paste0(dir_share, 'MA_output/')

# path in the desktop of office room
# dir.raw   <- "C:/Users/maoy1/OneDrive - Universiteit Leiden/maoy1_Pdisk/R/meta_mental wellbeing/source/"
# dir_share <- 'C:/Users/maoy1/OneDrive - Universiteit Leiden/maoy1_Pdisk/R/meta_mental wellbeing/result/'
# dir.fig <- "C:/Users/maoy1/OneDrive - Universiteit Leiden/maoy1_Pdisk/R/meta_mental wellbeing/meta-analysis-nature-health-main (1)/meta-analysis-nature-health-main/code/figures"
```


```{r - imported}
#df_exp_all_model <- read.csv(file = paste0(dir_share, 'exp_all_model_op1.CSV'))

df_op1 <- read.csv(file = paste0(dir_share, 'exp_all_model_op1.CSV'))
# df_op2 <- read.csv(file = paste0(dir_share, 'exp_all_model_op2.CSV'))

```

# Meta-analysis

## Correlation

  Correlations are restricted in their range, and it can introduce bias when we estimate the standard error for studies with a small sample size (Alexander, Scozzaro, and Borodkin 1989).
  
  The (Pearson or product-moment) correlation coefficient quantifies the direction and strength of the (linear) relationship between two quantitative variables and is therefore frequently used as the outcome measure for meta-analyses. Two alternative measures are a bias-corrected version of the correlation coefficient and Fisher's r-to-z transformed correlation coefficient.



### metafor 
  * ri, the vector with the raw correlation coefficients
  * ni, the corresponding sample sizes. 

The options for the measure argument are then:
  * "COR" for the raw correlation coefficient,
  * "UCOR" for the raw correlation coefficient corrected for its slight negative bias (based on equation 2.3 in Olkin & Pratt, 1958),
  * "ZCOR" for Fisher's r-to-z transformed correlation coefficient (Fisher, 1921).

# option1
```{r - L1}
df_op1_L1 <- df_op1 %>%
  dplyr::filter(!is.na(exp_SD)) %>%
  dplyr::filter(!grepl("Categorical|^$", exp_SD, ignore.case = TRUE)) %>%
  dplyr::filter(!is.na(range_exp)) %>%
  dplyr::filter(grepl("^1$|^2$|^100$", range_exp)) %>%
  distinct(id, Mean, .keep_all = TRUE) %>%
  dplyr::mutate(MH_direction = ifelse(MH_tool == "PSS", "-1", MH_direction)) %>% 

  as.data.frame()

f <- paste0(dir_share, 'meta_op1_L1.CSV')
readr::write_csv(x = df_op1_L1, file = f)


df_op1_L1_regr <- df_op1_L1 %>%
  
  dplyr::mutate(
    MH_direction = as.numeric(MH_direction),
    mean_adjusted = Mean * MH_direction / range_MH  ,
    mean_adjusted = ifelse(grepl("100", range_exp), Mean/range_MH * MH_direction /100, mean_adjusted),
    mean_adjusted = as.numeric(mean_adjusted),
   nature_quantity = ifelse(grepl("frequency", nature_quantity.1), "visit frequency",
                       ifelse(grepl("duration|Time in greenspace|time spent on visiting green space close to home", nature_quantity.1), "visit duration",
                       ifelse(grepl("Distance", nature_quantity.1), "distance to nature",
                       ifelse(grepl("access", nature_quantity.1), "access to nature",
                       ifelse(grepl("view", nature_quantity.1), "nature view",
                       ifelse(grepl("view|Visible greenery from home", nature_quantity.1), "nature view",
                       ifelse(grepl("SVG|Streetscape greenery", nature_quantity.1), "SVG",
                        nature_quantity.1
                                   ))))))),
   nature_quantity = ifelse(is.na(nature_quantity), "percentage of greenspace", nature_quantity),
   nature_quantity = gsub("Blue space coverage","percentage of bluespace", nature_quantity),
   nature_quantity = gsub("Green space coverage","percentage of greenspace",nature_quantity),
   nature_quantity = gsub("Home\\s+Year\\s+Vegetation", "percentage of greenspace", nature_quantity),
   nature_quantity = gsub("access to nature","access", nature_quantity),
   nature_quantity = gsub("Per capita green area","percentage of greenspace",nature_quantity),
   nature_quantity = gsub("proportion of water area","percentage of bluespace",nature_quantity),
   nature_quantity = gsub("Tree cover","percentage of greenspace",nature_quantity),
   nature_quantity = gsub("Percentage of greenspace","percentage of greenspace",nature_quantity),
   buffer = ifelse(id == "#465", "3000", buffer), # buffer of 465 is city
   buffer = ifelse(id == "102", "500", buffer),
   buffer = ifelse(id == "2661" & Notes == "city", 10000,
                   ifelse(id == "2661" & Notes == "local", 100, buffer)),
    buffer = gsub("1080","1000",buffer),
    #buffer = gsub("^50$","100",buffer),
    buffer = gsub("1600|2000|3000|10000","1500", buffer),
    # regroup
    #buffer = gsub("^1500$","1600",buffer)
    
   #MH_tool = gsub("SF-36|SF-12", "SF", MH_tool)
  ) %>%
  
  dplyr::filter(!is.na(mean_adjusted)) %>%
  
  as.data.frame()

f <- paste0(dir_share, 'meta_op1_L1_regr.CSV')
readr::write_csv(x = df_op1_L1_regr, file = f)


type_count_op1_L1 <-  df_op1_L1_regr %>%
                        group_by(nature_type.1) %>%
                        count()
paper_coun_op1_L1 <- df_op1_L1_regr %>%
                        group_by(id) %>%
                        count()

  

dat_op1_L1_regr <- escalc(data= df_op1_L1_regr, measure="ZCOR", ri=mean_adjusted, ni=N)

# study_label_L1 <- paste(dat_op1_L1_regr$id)

study_label_L1 <- paste(dat_op1_L1_regr$id, dat_op1_L1_regr$model_id, sep = '_')

dat_op1_L1_regr <- dat_op1_L1_regr %>%
  dplyr::mutate(study_label_L1 = gsub("#", "", study_label_L1))
#study_label <- paste(dat$id, dat$model_id, sep = '_')

res_op1_L1_regr <- metafor::rma(yi, vi, data=dat_op1_L1_regr, slab = study_label_L1)
res_op1_L1_regr
predict(res_op1_L1_regr, transf=transf.ztor) ## ztor: z to r


# outlier/influence diagnostics
par(mar=c(5,6,4,2))
plot(influence(res_op1_L1_regr), cex=0.8, las=1)

```



```{r - L1L3}
# for op1 in L1 and L3 exposures
df_op1_L1L3 <- df_op1 %>%
  dplyr::filter(!is.na(exp_SD)) %>%
  #dplyr::filter(!grepl("Categorical|^$", exp_SD, ignore.case = TRUE)) %>%
  dplyr::filter(!is.na(range_exp)) %>%
  dplyr::filter(grepl("^1$|^2$|^100$|^4$", range_exp)) %>%
  dplyr::mutate(
    buffer = ifelse(exposure == "L3 - view of nature from window", "50", buffer),
    buffer = ifelse(id == "#465", "3000", buffer) # buffer of 465 is city
    ) %>% 
  distinct(id, Mean, .keep_all = TRUE) %>%
  as.data.frame()

f <- paste0(dir_share, 'meta_op1_L1L3.CSV')
readr::write_csv(x = df_op1_L1L3, file = f)


df_op1_L1L3_regr <- df_op1_L1L3 %>%
  dplyr::mutate(
    mean_adjusted = Mean * MH_direction / range_MH  ,
    mean_adjusted = ifelse(grepl("100", range_exp), Mean/range_MH * MH_direction /100, mean_adjusted),
    mean_adjusted = ifelse(grepl("4", range_exp), Mean/range_MH * MH_direction /4, mean_adjusted),
    mean_adjusted = as.numeric(mean_adjusted),
   nature_quantity = ifelse(grepl("frequency", nature_quantity.1), "visit frequency",
                       ifelse(grepl("duration|Time in greenspace|time spent on visiting green space close to home", nature_quantity.1), "visit duration",
                       ifelse(grepl("Distance", nature_quantity.1), "distance to nature",
                       ifelse(grepl("access", nature_quantity.1), "access to nature",
                       ifelse(grepl("view", nature_quantity.1), "nature view",
                       ifelse(grepl("view|Visible greenery from home", nature_quantity.1), "nature view",
                       ifelse(grepl("SVG|Streetscape greenery", nature_quantity.1), "SVG",
                        nature_quantity.1
                                   ))))))),
   nature_quantity = ifelse(is.na(nature_quantity), "percentage of greenspace", nature_quantity),
   nature_quantity = gsub("Blue space coverage","percentage of bluespace", nature_quantity),
   nature_quantity = gsub("Green space coverage","percentage of greenspace",nature_quantity),
   nature_quantity = gsub("Home\\s+Year\\s+Vegetation", "percentage of greenspace", nature_quantity),
   nature_quantity = gsub("access to nature","access", nature_quantity),
   nature_quantity = gsub("Per capita green area","percentage of greenspace",nature_quantity),
   nature_quantity = gsub("proportion of water area","percentage of bluespace",nature_quantity),
   nature_quantity = gsub("Tree cover","percentage of greenspace",nature_quantity),
   nature_quantity = gsub("Percentage of greenspace","percentage of greenspace",nature_quantity),
   buffer = ifelse(id == "102", "500", buffer),
   buffer = ifelse(id == "2661" & Notes == "city", 10000,
                   ifelse(id == "2661" & Notes == "local", 50, buffer)),
    buffer = gsub("1080","1000",buffer),
    # buffer = gsub("1600","1500",buffer),
    buffer = gsub("1600|2000|3000|10000","1500", buffer),
   # regroup
   #buffer = gsub("^50$","100",buffer),
    # nature_type.1 = gsub("Greenspace - Shrub/scrub|Greenspace - Farmland|Greenspace - Grassland", "Greenspace - Lower vegetation", nature_type.1),
   nature_type.1 = gsub("^Bluespace - Open water \\(river/lake/canal\\)$","Bluespace - General", nature_type.1),
    #MH_tool = gsub("SF-36|SF-12", "SF", MH_tool)
   
  ) %>%
  
  dplyr::filter(!is.na(mean_adjusted)) %>%
  as.data.frame()

f <- paste0(dir_share, 'meta_op1_L1L3_regr.CSV')
readr::write_csv(x = df_op1_L1L3_regr, file = f)


type_count_op1_L1L3 <-  df_op1_L1L3_regr %>%
                        group_by(nature_type.1) %>%
                        count()
paper_coun_op1_L1L3 <- df_op1_L1L3_regr %>%
                        group_by(id) %>%
                        count()

  

dat_op1_L1L3_regr <- escalc(data= df_op1_L1L3_regr, measure="ZCOR", ri=mean_adjusted, ni=N)
study_label_L1L3 <- paste(dat_op1_L1L3_regr$id)
#study_label <- paste(dat$id, dat$model_id, sep = '_')

res_op1_L1L3_regr <- metafor::rma(yi, vi, data=dat_op1_L1L3_regr, slab = study_label_L1L3)
res_op1_L1L3_regr
predict(res_op1_L1L3_regr, transf=transf.ztor) ## ztor: z to r

par(mar=c(5,6,4,2))
plot(influence(res_op1_L1L3_regr), cex=0.8, las=1)
```




```{r - auto-report, eval=FALSE, include=FALSE}
### reporter() function

metafor::reporter(res_op1_L1_regr, dir = dir.report)

metafor::reporter(res_op1_L1L3_regr, dir = dir.report)

# reporter(res, format="pdf", 
#          dir = paste0(dir.root, '/figures/'), 
#          filename = 'report_metafor.PDF')
#          
# reporter(res, format="word")

### add an outlier
# dat$yi[6] <- 2.5
# res <- rma(yi, vi, data=dat)
# reporter(res)
```


## L1 - meta forest
```{r warning=FALSE}
xlim_custmize = c(-1,1)


f <- paste0(dir.report, 'plot_forest_cor_', today ,'.png'); f
png(file=f, 
    # width = 3.5, height = 4, units = 'in', 
    width = 1000, height = 1000, units = "px", pointsize = 22,
    # res = 200
    ) 
meta::forest(res_op1_L1_regr, 
             addpred=TRUE, header=TRUE, 
             digits=2, 
             print.I2 = T,
             layout = "RevMan5",
             xlim=xlim_custmize, slab = study_label_L1, shade=TRUE)
dev.off() 


# forest(res_op1_L1_regr, addpred=TRUE, header=TRUE, xlim=xlim_custmize, slab = study_label_L1) # showweights=TRUE
# forest(res_op1_L1_regr, addpred=TRUE, header=TRUE, xlim=xlim_custmize, atransf=exp)
#' optional argument to specify a function to transform the x-axis labels and annotations (e.g., atransf=exp)
# forest(res_op1_L1_regr, addpred=TRUE, header=TRUE, xlim=xlim_custmize, atransf=exp, at=log(c(.6, .8, 1, 1.2, 1.4)))
```


### subgroup

```{r}
width_forestPlot = 40
height_cm <- nrow(df_op1_L1_regr)/1.1


add_subgroup_analysis <- T

subgroup_select_type <- 'nature_type.1'
subgroup_select_quantity <- 'nature_quantity.1'
subgroup_select_buffer <- 'buffer'
subgroup_select_tool <- 'MH_tool'
# subgroup_select <- 'nature_type.1'
# subgroup_select <- 'nature_quantity.1'


## list all the tools in the data
unique(dat_op1_L1_regr$Tools)
unique(dat_op1_L1_regr$MH_tool)


ma_cor_op1_L1 <- dat_op1_L1_regr %>%
  dplyr::mutate(nature_type.1 = str_to_sentence(nature_type.1),
                buffer = str_to_sentence(buffer),
                nature_quantity.1 = case_when(
                  nature_quantity.1 %in% c("Streetscape greenery", 'SVG-quantity',
                                        "SVG-grass", "SVG-tree") ~ "SVG",
                  # nature_type_o1 == "Home/ courtyard garden" ~ "Greenspace",
                  # nature_type_o1 == "Community private green space" ~ "Greenspace",
                T ~ nature_quantity.1
                )) %>%
  dplyr::mutate(subgroup_selected_type = !!sym(subgroup_select_type))%>%
  dplyr::mutate(subgroup_selected_quantity = !!sym(subgroup_select_quantity))%>%
  dplyr::mutate(subgroup_selected_buffer = !!sym(subgroup_select_buffer)) %>% 
  dplyr::mutate(subgroup_selected_tool = !!sym(subgroup_select_tool))

  

unique(ma_cor_op1_L1$nature_type.1)
unique(ma_cor_op1_L1$nature_quantity.1)
unique(ma_cor_op1_L1$buffer)
unique(ma_cor_op1_L1$MH_tool)


ma_cor_L1 <- meta::metacor(
  data = ma_cor_op1_L1,
  cor = mean_adjusted, 
  n = N,
  studlab = study_label_L1,
  fixed = FALSE,
  random = TRUE,
  method.tau = "REML",
  hakn = TRUE,
  title = "Mental health_op1_L1")
summary(ma_cor_L1)

# length(ma_cor_op1_L1)
# length(subgroup_selected_type)
```


```{r - subgroup - type}

subgroup_select_type <- 'nature_type.1'
subgroup_selected_type <- subgroup_select_type

if (add_subgroup_analysis == T) {
  ma_cor_L1_type <- update(ma_cor_L1, subgroup = subgroup_selected_type)
  #ma_cor_L1_type <- rma(yi, vi, mods = ~ subgroup_selected_type, data = ma_cor_op1_L1)
  
  test.effect.subgroup.random_para = TRUE
  postfix_subgroup_type <- paste0("subgroup_", subgroup_select_type)
  height_cm <- height_cm
    
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup_type <- ""
  }
  
  

f <- paste0(dir.fig, 'forest_op1_L1_',postfix_subgroup_type,  '_', today, '.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm/1.2, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_L1_type, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label_L1, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()
```


```{r - subgroup - buffer}

subgroup_select_buffer <- 'buffer'
subgroup_selected_type <- subgroup_select_type

if (add_subgroup_analysis == TRUE) {
  ma_cor_L1_buffer <- update(ma_cor_L1, subgroup = subgroup_selected_buffer, control = list(maxiter = 1000, stepadj = 0.5, reltol = 1e-8))
  test.effect.subgroup.random_para <- TRUE
  postfix_subgroup_buffer <- paste0("subgroup_", subgroup_select_buffer)
  height_cm <- height_cm
} else {
  test.effect.subgroup.random_para <- FALSE
  postfix_subgroup_buffer <- ""
}


f <- paste0(dir.fig, 'forest_op1_L1_', postfix_subgroup_buffer, today, '.png')


png(filename = f, 
    width = width_forestPlot/2, height = height_cm/1.2, units = "cm", res = 100)


p_forest <- meta::forest(
  ma_cor_L1_buffer, 
  addpred = TRUE, 
  header = TRUE, 
  digits = 2, 
  print.I2 = TRUE,
  pooled.totals = TRUE,
  overall = TRUE,
  overall.hetstat = TRUE,
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade = TRUE,
  layout = "RevMan5",
  slab = study_label_L1,
  leftlabs = c("Study ID", "g", "SE")
)
print(p_forest)

dev.off()


# if (add_subgroup_analysis == T) {
#   ma_cor_L1_buffer <- update(ma_cor_L1, subgroup = subgroup_selected_buffer)
#   #ma_cor_L1_type <- rma(yi, vi, mods = ~ subgroup_selected_type, data = ma_cor_op1_L1)
#   
#   test.effect.subgroup.random_para = TRUE
#   postfix_subgroup_buffer <- paste0("subgroup_", subgroup_select_buffer)
#   height_cm <- height_cm
#     
#   } else {
#     test.effect.subgroup.random_para = F
#     postfix_subgroup_buffer <- ""
#   }
# 
# f <- paste0('./figures/', 'forest_op1_L1_',postfix_subgroup_buffer,  today, '.png'); f
# png(filename = f, 
#     # width = 3000, height = 3000, units = "px", pointsize = 22,
#     width = width_forestPlot/2, height = height_cm/1.2, units = "cm", res = 100)
# 
# p_forest <- meta::forest(
#   ma_cor_L1_buffer, 
#   # sortvar = TE,
#   # prediction = TRUE, 
#   # print.tau2 = T,
#   addpred=TRUE, 
#   header=TRUE, 
#   digits=2, 
#   print.I2 = T,
#   pooled.totals=T,
#   overall = T,
#   overall.hetstat = T,
#   
#   col.by = "black",
#   col.square = "black",
#   col.inside = "black",
#   col.square.lines = "black",
#   shade=TRUE,
#   layout = "RevMan5",
#   slab = study_label_L1, shade=TRUE,
#   leftlabs = c("Study ID", "g", "SE"))
# p_forest
# 
# dev.off()
```


```{r - subgroup - tools}

subgroup_select_tool <- 'MH_tool'
subgroup_selected_type <- subgroup_select_type

if (add_subgroup_analysis == T) {
  ma_cor_L1_tool <- update(ma_cor_L1, subgroup = subgroup_selected_tool)
  #ma_cor_L1_type <- rma(yi, vi, mods = ~ subgroup_selected_type, data = ma_cor_op1_L1)
  
  test.effect.subgroup.random_para = TRUE
  postfix_subgroup_tool <- paste0("subgroup_", subgroup_select_tool)
  height_cm <- height_cm
    
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup_tool <- ""
  }

f <- paste0(dir.fig, 'forest_op1_L1_',postfix_subgroup_tool,  today, '.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm/1.2, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_L1_tool, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label_L1, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()

```


### prep for viz

```{r - prep for the plot}

print(paste("Length of mean_adjusted:", length(ma_cor_op1_L1$mean_adjusted)))
print(paste("Length of study_label_L1:", length(ma_cor_op1_L1$study_label_L1)))



# 变量设置
add_subgroup_analysis <- T

#subgroup_select <- 'buffer'
subgroup_select <- 'nature_type.1';  subgroup_label = 'Nature type'


mh_tools <- c('GHQ-12', 'WEMWBS', 'SF-36', 'SF-12', 'WHO-5', 'PSS')
subgroups <- c('nature_type.1', 'buffer')


# table(dat_op1_L1_regr$MH_tool)

# 外层循环遍历每个工具
for (tool in mh_tools) {
  
  print(paste("Processing tool:", tool))
  
  # 针对每个工具，循环遍历子组
  for (subgroup_select in subgroups) {
    
    print(paste("Processing subgroup:", subgroup_select))
    
    # 数据处理
    ma_cor_op1_L1 <- dat_op1_L1_regr %>%
      dplyr::filter(MH_tool == tool) %>%  # 筛选当前工具的数据
      dplyr::mutate(subgroup_selected = !!sym(subgroup_select))  # 添加子组选择列
    print(paste("Number of rows for", tool, ":", nrow(ma_cor_op1_L1)))
    
    # 获取唯一的子组和指标名称
    ind_name <- unique(ma_cor_op1_L1$MH_indicator)
    
    # 执行元分析
    ma_cor_L1 <- meta::metacor(
      data = ma_cor_op1_L1,
      cor = mean_adjusted, 
      n = N,
      studlab = study_label_L1,
      fixed = FALSE,
      random = TRUE,
      method.tau = "REML",
      hakn = TRUE,
      title = paste("Mental health_op1_L1", tool)
    )
    
    h_just <- nrow(ma_cor_op1_L1) / 50
    h_just <- if_else(h_just > 1, h_just, 2)
    
    # 添加子组分析
    if (add_subgroup_analysis == T) {
      ma_cor_L1 <- update(ma_cor_L1, subgroup = subgroup_selected)
      
      test.effect.subgroup.random_para <- TRUE
      postfix_subgroup <- paste0("subgroup_", subgroup_select)
      
    } else {
      test.effect.subgroup.random_para <- F
      postfix_subgroup <- ""
    }
    
   
    # 提取总体效应结果
    ma_result.L1 <- data.frame()
    
    ma_cor_L1.df <- data.frame(
      tool = tool, 
      # ind_sub = paste(ind_name, collapse = ";"),
      group_name = '',
      es.mean = ma_cor_L1$TE.random,
      es.lower = ma_cor_L1$lower.random,
      es.upper = ma_cor_L1$upper.random,
      pval = ma_cor_L1$pval.random %>% round(., digits = 10),
      I2 = as.numeric(ma_cor_L1$I2) %>% round(., digits = 2),
      p_subgroup = NA,
      n_study = ma_cor_L1$k.all,
      n_obs = sum(ma_cor_L1$n, na.rm = T)
    ) %>%
      dplyr::mutate(
        p.star = case_when(
          pval < 0.001 ~ '***',
          pval < 0.01 ~ '**',
          pval < 0.05 ~ '*',
          TRUE ~ ''
        )
      )
    ma_result.L1 <- rbind(ma_result.L1, ma_cor_L1.df)
    
    
    # 如果进行了子组分析，提取子组效应结果
    if (add_subgroup_analysis == T) {
      ma_result.L1.subgroup <- data.frame()
      ma_cor_L1.df.subgroup <- data.frame(
        tool = tool, 
        ind_sub = paste(ind_name, collapse = ";"), 
        group_name = subgroup_select,
        subgroup = names(ma_cor_L1$TE.common.w),
        es.mean = as.numeric(ma_cor_L1$TE.random.w),
        es.lower = as.numeric(ma_cor_L1$lower.random.w),
        es.upper = as.numeric(ma_cor_L1$upper.random.w),
        pval = as.numeric(ma_cor_L1$pval.random.w) %>% round(., digits = 10),
        I2 = as.numeric(ma_cor_L1$I2.w) %>% round(., digits = 2),
        p_subgroup = as.numeric(ma_cor_L1$pval.Q.b.random) %>% round(., digits = 10),
        n_study = as.numeric(ma_cor_L1$k.all.w),
        n_obs = NA
      ) %>%
        dplyr::mutate(
          p.star = case_when(
            pval < 0.001 ~ '***',
            pval < 0.01 ~ '**',
            pval < 0.05 ~ '*',
            TRUE ~ ''
          )
        )
      ma_result.L1.subgroup <- rbind(ma_result.L1.subgroup, ma_cor_L1.df.subgroup)
    }
    
    # 保存结果
    fname <- paste0(dir.MA.output, 
                    paste('ma_result.L1', tool, '.rds', sep = '_'))
    saveRDS(ma_result.L1, file = fname)
    
    if (add_subgroup_analysis == T) {
      fname <- paste0(dir.MA.output, 
                      paste('ma_result.L1.subgroup', tool, subgroup_select, '.rds', sep = '_'))
      print(basename(fname))
      saveRDS(ma_result.L1.subgroup, file = fname)
    }
    
  }
}


```








```{r - load data}

fs <- list.files(path = dir.MA.output, 
                 pattern = '^ma_result.L1.subgroup_', ## if opt to include selected ones
                 full.names = T);
cat('\n This', length(fs), 'files will be included:\n')
print(fs)

ma_result_all_ <- data.frame()
for (f in fs) {
  # print(f)
  d <- readRDS(file = f) 
  ma_result_all_ <- rbind(ma_result_all_, d)
}


```


```{r - plot by group}
source('./code/func_plot_ma.R')
source('./code/func_color_bygroup.R')

## figure version
vv <- ''

subgroups <- c('nature_type.1', 'buffer')

##' Pick one for viz ---------------------------------------------------------------------

subgroup_select <- 'nature_type.1';  


## indicators to be included in the combined sub-group analysis plots
unique(ma_result_all$tool) %>% sort()
ind_sub_levels <- unique(ma_result_all$tool)


##' as you want to plot by `tool`, instead of `indicator`, we need to rename the column name
##' so that you can use the function I created directly 
ma_result_all <- ma_result_all_ %>%
  dplyr::rename('ind_sub_raw' = 'ind_sub') %>%
  dplyr::mutate(ind_sub = tool) %>%
  dplyr::select(tool, ind_sub, everything())


##' get the unique list of buffer size
# buf_v <- ma_result_all %>%
#   dplyr::filter(group_name == 'buffer') %>%
#   select(subgroup) %>%
#   unique(.) %>% unlist() %>% as.vector()
# ##' order the list, and use it for plotting (in the same order) 
# buf_v_order <- as.numeric(buf_v) %>% sort() %>% as.character()


for (subgroup_select in subgroups) {
  
  ## subset data
  ma_result_all_sub <- ma_result %>%
    dplyr::filter(subgroup != 'Overall', 
                  group_name == subgroup_select) %>%
    dplyr::filter(tool %in% tool_sub_levels)
  
  ## postfix to be added to figure names
  postfix_group <- paste0("_subgroup_", subgroup_select); postfix_group
  
  ## decide color scheme 
  if(subgroup_select == 'nature_type_o2'){
    group_title = str_to_sentence(gsub('_|_o2', ' ', subgroup_select)) %>% trimws()
    color_bygroup = nature_type_color; 
    group_list = nature_type_list
  } else if(subgroup_select == 'age_group'){
    group_title = str_to_sentence(gsub('_', ' ', subgroup_select))
    color_bygroup = age_group_color; 
    group_list = age_group_list
  } else if(subgroup_select == 'gender_group'){
    group_title = str_to_sentence(gsub('_', ' ', subgroup_select))
    color_bygroup = gender_group_color; 
    group_list = gender_group_list
  } else if(subgroup_select == 'duration_group'){
    group_title = 'Duration in nature'
    color_bygroup = duration_group_color; 
    group_list = duration_group_list
  } else if(subgroup_select == 'Region'){
    group_title = subgroup_select
    color_bygroup = region_color; 
    group_list = region_list
  } else if(subgroup_select == 'buffer'){
    group_title = str_to_sentence(gsub('_|_o2', ' ', subgroup_select)) %>% trimws()
    group_list = unique(ma_result_all_sub$subgroup)
    color_bygroup = func_color_bygroup(df = ma_result_all_sub, column_name = 'subgroup')
    # ma_result_all_sub$subgroup <- factor(ma_result_all_sub$subgroup, levels = buf_v_order)
  } else {
    # next
    group_title = str_to_sentence(gsub('_|_o2', ' ', subgroup_select)) %>% trimws()
    group_list = unique(ma_result_all_sub$subgroup)
    color_bygroup = func_color_bygroup(df = ma_result_all_sub, column_name = 'subgroup')
  }
  
  
  ##' run sourced code 
  ##' 
  ##' 1. plot by tool and combine plots
  # source('./code/020s1_subgroup_loop_source_code.R')
  
  ##' 2. pool all tools together and plot
  source('./code/020s2_subgroup_loop_source_code.R')
  
}


```





















```{r - original code without "for" recycle}

add_subgroup_analysis <- T
subgroup_select <- c('GHQ-12', 'WEMWBS', 'SF-36', 'SF-12', 'WHO-5', 'PSS'); subgroup_label = 'MH tool'
MH_tool_list <- unique(ma_cor_op1_L1$MH_tool); MH_tool_list


subgroups <- 'nature_type.1'
  

for (subgroup_select in subgroups) {
  
  print(subgroup_select)
  
  ma_cor_op1_L1 <- df_op1_L1_regr %>%
    #dplyr::filter(!is.na(exposure_o1)) %>%
    dplyr::mutate(subgroup_selected = !!sym(subgroup_select)) 
  
  # unique(ma_cor_data$exposure_o1)
  unique(ma_cor_op1_L1$nature_type.1)
  ind_name <- unique(ma_cor_op1_L1$MH_indicator); ind_name
  
  
  ma_cor_L1 <- meta::metacor(
  data = ma_cor_op1_L1,
  cor = mean_adjusted, 
  n = N,
  studlab = study_label_L1,
  fixed = FALSE,
  random = TRUE,
  method.tau = "REML",
  hakn = TRUE,
  title = "Mental health_op1_L1")
  
  
  h_just <- nrow(ma_cor_op1_L1)/50
  h_just <- if_else(h_just>1, h_just, 2)
  
  
   ## update the MA by adding subgroup analysis ---------------------------------------------
  if (add_subgroup_analysis == T) {
    ma_cor_L1 <- ma_cor_L1 %>%
      # dplyr::mutate(subgroup_selected = !!sym(subgroup_select)) %>%
      # dplyr::filter(!is.na(subgroup_selected)) %>%
      update(., subgroup = subgroup_selected)
    
    test.effect.subgroup.random_para = TRUE
    postfix_subgroup <- paste0("subgroup_", subgroup_select)
    height_cm <- height_cm
      
    } else {
      test.effect.subgroup.random_para = F
      postfix_subgroup <- ""
    }


  ## extract the overall effect size data to a dataframe ===================================
  ma_result.L1 <- data.frame()
  ma_result.L1.subgroup <- data.frame()



  ### 1. L1 model data ----------------------------------------------------------------

  ma_cor_L1.df <- data.frame(
    tool = paste(MH_tool_list, collapse = ";"), 
    ind_sub = paste(ind_name, collapse = ";"),
    group_name = '',
    #subgroup = 'Overall',
    es.mean = ma_cor_L1$TE.random,
    es.lower= ma_cor_L1$lower.random,
    es.upper= ma_cor_L1$upper.random,
    pval    = ma_cor_L1$pval.random %>% round(., digits = 10),
    I2      = as.numeric(ma_cor_L1$I2) %>% round(., digits = 2),
    p_subgroup = NA,
    ## Number of studies
    n_study = ma_cor_L1$k.all,
    ## Number of observations
    n_obs   = sum(ma_cor_L1$n, na.rm = T)
  ) %>%
    dplyr::mutate(
      p.star  = case_when(pval < 0.001 ~ '***',
                        pval < 0.01 ~ '**',
                        pval < 0.05 ~ '*',
                        T ~ ''),
    )
  ma_result.L1 <- rbind(ma_result.L1, ma_cor_L1.df)
  

  
### 2. L1 - subgroup model data (tool sub) ---------------------------------------------------------------
  if (add_subgroup_analysis == T) {
    ma_cor_L1.df.subgroup <- data.frame(
      tool = paste(MH_tool_list, collapse = ";"), 
      ind_sub = paste(ind_name, collapse = ";"), 
      group_name = subgroup_select,
      subgroup = names(ma_cor_L1$TE.common.w),
      es.mean = as.numeric(ma_cor_L1$TE.random.w),
      es.lower= as.numeric(ma_cor_L1$lower.random.w),
      es.upper= as.numeric(ma_cor_L1$upper.random.w),
      pval    = as.numeric(ma_cor_L1$pval.random.w) %>% round(., digits = 10),
      I2      = as.numeric(ma_cor_L1$I2.w) %>% round(., digits = 2),
      p_subgroup = as.numeric(ma_cor_L1$pval.Q.b.random) %>% round(., digits = 10),
      ## Number of studies
      n_study = as.numeric(ma_cor_L1$k.all.w),
      ## Number of observations
      n_obs   = NA
    ) %>%
      dplyr::mutate(
        p.star  = case_when(pval < 0.001 ~ '***',
                          pval < 0.01 ~ '**',
                          pval < 0.05 ~ '*',
                          T ~ ''),
      )
    ma_result.L1.subgroup <- rbind(ma_result.L1.subgroup, ma_cor_L1.df.subgroup)
  }
  
  
  ## save MA result 
  cat('\n')
  fname <- paste0('./data/0302-MA-output/', 
                  paste('ma_result.L1', paste(MH_tool_list, collapse = "_"), '.rds', sep = '')); fname
  saveRDS(ma_result.L1, file = fname)
  
  if (add_subgroup_analysis == T) {
    
    
    fname <- paste0('./data/0302-MA-output/', 
                    paste('ma_result.L1.subgroup', paste(MH_tool_list, collapse = "_"), subgroup_select, '.rds', sep = '_')); 
    print(basename(fname))
    saveRDS(ma_result.L1.subgroup, file = fname)
  }
  
}
  
```



```{r - L1 subgroup plot - detail}
## forest plot ---------------------------------------------------------------------------

f <- paste0('./figures/', 'forest_cor/', paste(MH_tool_o1_list, collapse = "_"), '_', postfix_subgroup, '_',  today, '_meta.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm*h_just, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
# p_forest

dev.off()
```

## L1L3 - meta forest
```{r}
xlim_custmize = c(-1,1)


f <- paste0(dir.report, 'plot_forest_cor_', today ,'.png'); f
png(file=f, 
    # width = 3.5, height = 4, units = 'in', 
    width = 1000, height = 1000, units = "px", pointsize = 22,
    # res = 200
    ) 
meta::forest(res_op1_L1L3_regr, 
             addpred=TRUE, header=TRUE, 
             digits=2, 
             print.I2 = T,
             layout = "RevMan5",
             xlim=xlim_custmize, slab = study_label_L1L3, shade=TRUE)
dev.off() 


width_forestPlot = 40
height_cm <- nrow(df_op1_L1L3_regr)/1.1

# forest(res_op1_L1_regr, addpred=TRUE, header=TRUE, xlim=xlim_custmize, slab = study_label_L1) # showweights=TRUE
# forest(res_op1_L1_regr, addpred=TRUE, header=TRUE, xlim=xlim_custmize, atransf=exp)
#' optional argument to specify a function to transform the x-axis labels and annotations (e.g., atransf=exp)
# forest(res_op1_L1_regr, addpred=TRUE, header=TRUE, xlim=xlim_custmize, atransf=exp, at=log(c(.6, .8, 1, 1.2, 1.4)))
```



```{r - plot subgroup}
add_subgroup_analysis <- T

subgroup_select_type <- 'nature_type.1'
subgroup_select_quantity <- 'nature_quantity.1'
subgroup_select_buffer <- 'buffer'
subgroup_select_tool <- 'MH_tool'
# subgroup_select <- 'nature_type.1'
# subgroup_select <- 'nature_quantity.1'

ma_cor_op1_L1L3 <- df_op1_L1L3_regr %>%
  dplyr::mutate(nature_type.1 = str_to_sentence(nature_type.1),
                buffer = str_to_sentence(buffer),
                nature_quantity.1 = case_when(
                  nature_quantity.1 %in% c("Streetscape greenery", 'SVG-quantity',
                                        "SVG-grass", "SVG-tree") ~ "SVG",
                  # nature_type_o1 == "Home/ courtyard garden" ~ "Greenspace",
                  # nature_type_o1 == "Community private green space" ~ "Greenspace",
                T ~ nature_quantity.1
                )) %>%
  #dplyr::filter(!is.na(nature_type.1)) %>%
  #dplyr::filter(!is.na(nature_quantity.1)) %>%
  #dplyr::filter(!is.na(buffer)) %>%
  dplyr::mutate(subgroup_selected_type = !!sym(subgroup_select_type))%>%
  dplyr::mutate(subgroup_selected_quantity = !!sym(subgroup_select_quantity))%>%
  dplyr::mutate(subgroup_selected_buffer = !!sym(subgroup_select_buffer)) %>% 
  dplyr::mutate(subgroup_selected_tool = !!sym(subgroup_select_tool))
  

unique(ma_cor_op1_L1L3$nature_type.1)
unique(ma_cor_op1_L1L3$nature_quantity.1)
unique(ma_cor_op1_L1L3$buffer)
unique(ma_cor_op1_L1L3$MH_tool)


ma_cor_L1L3 <- meta::metacor(
  data = ma_cor_op1_L1L3,
  cor = mean_adjusted, 
  n = N,
  studlab = study_label_L1L3,
  fixed = FALSE,
  random = TRUE,
  method.tau = "REML",
  hakn = TRUE,
  title = "Mental health_op1_L1")
summary(ma_cor_L1L3)



# length(ma_cor_op1_L1)
# length(subgroup_selected_type)


##  subgroup analysis - type
if (add_subgroup_analysis == T) {
  ma_cor_L1L3_type <- update(ma_cor_L1L3, subgroup = subgroup_selected_type)
  #ma_cor_L1_type <- rma(yi, vi, mods = ~ subgroup_selected_type, data = ma_cor_op1_L1)
  
  test.effect.subgroup.random_para = TRUE
  postfix_subgroup_type <- paste0("subgroup_", subgroup_select_type)
  height_cm <- height_cm
    
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup_type <- ""
  }

f <- paste0('./figures/', 'forest_op1_L1L3_',postfix_subgroup_type,  today, '.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm/1.2, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_L1L3_type, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label_L1L3, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()


## subgroup - buffer

if (add_subgroup_analysis == TRUE) {
  ma_cor_L1L3_buffer <- update(ma_cor_L1L3, subgroup = subgroup_selected_buffer, control = list(maxiter = 1000, stepadj = 0.5, reltol = 1e-8))
  test.effect.subgroup.random_para <- TRUE
  postfix_subgroup_buffer <- paste0("subgroup_", subgroup_select_buffer)
  height_cm <- height_cm
} else {
  test.effect.subgroup.random_para <- FALSE
  postfix_subgroup_buffer <- ""
}


f <- paste0('./figures/', 'forest_op1_L1L3_', postfix_subgroup_buffer, today, '.png')


png(filename = f, 
    width = width_forestPlot/2, height = height_cm/1.2, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_L1L3_buffer, 
  addpred = TRUE, 
  header = TRUE, 
  digits = 2, 
  print.I2 = TRUE,
  pooled.totals = TRUE,
  overall = TRUE,
  overall.hetstat = TRUE,
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade = TRUE,
  layout = "RevMan5",
  slab = study_label_L1L3,
  leftlabs = c("Study ID", "g", "SE")
)
print(p_forest)

dev.off()


# if (add_subgroup_analysis == T) {
#   ma_cor_L1L3_buffer <- update(ma_cor_L1L3, subgroup = subgroup_selected_buffer)
#   #ma_cor_L1_type <- rma(yi, vi, mods = ~ subgroup_selected_type, data = ma_cor_op1_L1)
#   
#   test.effect.subgroup.random_para = TRUE
#   postfix_subgroup_buffer <- paste0("subgroup_", subgroup_select_buffer)
#   height_cm <- height_cm
#     
#   } else {
#     test.effect.subgroup.random_para = F
#     postfix_subgroup_buffer <- ""
#   }
# 
# f <- paste0('./figures/', 'forest_op1_L1L3_',postfix_subgroup_buffer,  today, '.png'); f
# png(filename = f, 
#     # width = 3000, height = 3000, units = "px", pointsize = 22,
#     width = width_forestPlot/2, height = height_cm/1.2, units = "cm", res = 100)
# 
# p_forest <- meta::forest(
#   ma_cor_L1L3_buffer, 
#   # sortvar = TE,
#   # prediction = TRUE, 
#   # print.tau2 = T,
#   addpred=TRUE, 
#   header=TRUE, 
#   digits=2, 
#   print.I2 = T,
#   pooled.totals=T,
#   overall = T,
#   overall.hetstat = T,
#   
#   col.by = "black",
#   col.square = "black",
#   col.inside = "black",
#   col.square.lines = "black",
#   shade=TRUE,
#   layout = "RevMan5",
#   slab = study_label_L1L3, shade=TRUE,
#   leftlabs = c("Study ID", "g", "SE"))
# p_forest
# 
# dev.off()


# subgroup - tools
if (add_subgroup_analysis == T) {
  ma_cor_L1L3_tool <- update(ma_cor_L1L3, subgroup = subgroup_selected_tool)
  #ma_cor_L1_type <- rma(yi, vi, mods = ~ subgroup_selected_type, data = ma_cor_op1_L1)
  
  test.effect.subgroup.random_para = TRUE
  postfix_subgroup_tool <- paste0("subgroup_", subgroup_select_tool)
  height_cm <- height_cm
    
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup_tool <- ""
  }

f <- paste0('./figures/', 'forest_op1_L1L3_',postfix_subgroup_tool,  today, '.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm/1.2, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_L1L3_tool, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label_L1L3, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()

```


# op1 - L3 view
```{r}
df_op1_L3 <- df_op1 %>%
  dplyr::filter(grepl("L3 - view of nature from window", exposure, ignore.case = TRUE)) %>%
  dplyr::filter(!is.na(range_exp)) %>%
  distinct(id, Mean, .keep_all = TRUE) %>%
  dplyr::mutate(MH_direction = ifelse(MH_tool == "PSS", "-1", MH_direction)) %>% 
  as.data.frame()

f <- paste0(dir_share, 'meta_op1_L3.CSV')
readr::write_csv(x = df_op1_L3, file = f)



df_op1_L3_regr <- df_op1_L3 %>%
  dplyr::mutate(
    nature_quantity.1 = gsub("", "how much", nature_quantity.1),
    mean_adjusted = Mean * MH_direction / range_MH  ,
    mean_adjusted = ifelse(grepl("100", range_exp), Mean/range_MH * MH_direction /100, mean_adjusted),
    mean_adjusted = as.numeric(mean_adjusted)
    ) %>%
  as.data.frame()

f <- paste0(dir_share, 'meta_op1_L3_regr.CSV')
readr::write_csv(x = df_op1_L3_regr, file = f)


type_count_op1_L3 <-  df_op1_L3_regr %>%
                        group_by(nature_type.1) %>%
                        count()
paper_coun_op1_L3 <- df_op1_L3_regr %>%
                        group_by(id) %>%
                        count()

  

dat_op1_L3_regr <- escalc(data= df_op1_L3_regr, measure="ZCOR", ri=mean_adjusted, ni=N)
study_label_L3 <- paste(dat_op1_L3_regr$id)
#study_label <- paste(dat$id, dat$model_id, sep = '_')

res_op1_L3_regr <- metafor::rma(yi, vi, data=dat_op1_L3_regr, slab = study_label_L3)
res_op1_L3_regr
predict(res_op1_L3_regr, transf=transf.ztor) ## ztor: z to r


# outlier/influence diagnostics
par(mar=c(5,6,4,2))
plot(influence(res_op1_L3_regr), cex=0.8, las=1)




metafor::reporter(res_op1_L3_regr, dir = dir.report)

xlim_custmize = c(-1,1)


f <- paste0(dir.report, 'plot_forest_cor_', today ,'.png'); f
png(file=f, 
    # width = 3.5, height = 4, units = 'in', 
    width = 1000, height = 1000, units = "px", pointsize = 22,
    # res = 200
    ) 
meta::forest(res_op1_L3_regr, 
             addpred=TRUE, header=TRUE, 
             digits=2, 
             print.I2 = T,
             layout = "RevMan5",
             xlim=xlim_custmize, slab = study_label_L3, shade=TRUE)
dev.off() 


width_forestPlot = 40
height_cm <- nrow(df_op1_L3_regr)/1.1




add_subgroup_analysis <- T


ma_cor_op1_L3 <- df_op1_L3_regr %>%
  dplyr::mutate(nature_type.1 = str_to_sentence(nature_type.1)
                
                 
                ) %>%
  #dplyr::filter(!is.na(nature_type.1)) %>%
  #dplyr::filter(!is.na(nature_quantity.1)) %>%
  #dplyr::filter(!is.na(buffer)) %>%
  dplyr::mutate(subgroup_selected_type = !!sym(subgroup_select_type))
 
  

unique(ma_cor_op1_L3$nature_type.1)


ma_cor_L3 <- meta::metacor(
  data = ma_cor_op1_L3,
  cor = mean_adjusted, 
  n = N,
  studlab = study_label_L3,
  fixed = FALSE,
  random = TRUE,
  method.tau = "REML",
  hakn = TRUE,
  title = "Mental health_op1_L3")
summary(ma_cor_L3)


##  subgroup analysis - type
if (add_subgroup_analysis == T) {
  ma_cor_L3_type <- update(ma_cor_L3, subgroup = subgroup_selected_type)
  #ma_cor_L1_type <- rma(yi, vi, mods = ~ subgroup_selected_type, data = ma_cor_op1_L1)
  
  test.effect.subgroup.random_para = TRUE
  postfix_subgroup_type <- paste0("subgroup_", subgroup_select_type)
  height_cm <- height_cm
    
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup_type <- ""
  }

f <- paste0('./figures/', 'forest_op1_L3_',postfix_subgroup_type,  today, '.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm/0.5, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_L3_type, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label_L3, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()


```



# op2 - presence
```{r}
df_op2_presence <- df_op2 %>%
  filter(grepl("^presence", nature_quantity.2) | nature_quantity.2 == "Gardening (yes/no)") %>% 
  filter(!grepl("^coef_MLR_standardized$", Notes.1)) %>% 
  distinct(id, Treatment_Mean, .keep_all = TRUE) %>%
  
  as.data.frame()

f <- paste0(dir_share, 'meta_op2_presence.CSV')
readr::write_csv(x = df_op2_presence, file = f)



df_op2_presence_regr <- df_op2_presence %>%
  dplyr::mutate(
    # range_MH = ifelse(MH_tool.1 == "SF-12", "36", range_MH),
    # range_MH = ifelse(MH_tool.1 == "WHO-5", "25", range_MH),
    # range_MH = ifelse(MH_tool.1 == "WEMWBS", "28", range_MH),
    MH_direction.1 = as.numeric(MH_direction.1),
    range_MH = as.numeric(range_MH),
    MH_direction.1 = ifelse(MH_tool.1 == "PSS", -1, MH_direction.1),
    MH_direction.1 = ifelse(id == "#465", -MH_direction.1, MH_direction.1),
    mean_adjusted = as.numeric(Treatment_Mean) * MH_direction.1 / range_MH
    
    ) %>%
  
  as.data.frame()

f <- paste0(dir_share, 'meta_op2_presence_regr.CSV')
readr::write_csv(x = df_op2_presence_regr, file = f)


type_count_op2_presen <-  df_op2_presence_regr %>%
                        group_by(nature_type.2) %>%
                        count()
paper_coun_op2_presen <- df_op2_presence_regr %>%
                        group_by(id) %>%
                        count()

  

dat_op2_presence_regr <- escalc(data= df_op2_presence_regr, measure="ZCOR", ri=mean_adjusted, ni=Treatment_N)
study_label_op2_pre <- paste(dat_op2_presence_regr$id)
#study_label <- paste(dat$id, dat$model_id, sep = '_')

res_op2_presen_regr <- metafor::rma(yi, vi, data=dat_op2_presence_regr, slab = study_label_op2_pre)
res_op2_presen_regr
predict(res_op2_presen_regr, transf=transf.ztor) ## ztor: z to r


# outlier/influence diagnostics
par(mar=c(5,6,4,2))
plot(influence(res_op2_presen_regr), cex=0.8, las=1)




metafor::reporter(res_op2_presen_regr, dir = dir.report)

xlim_custmize = c(-1,1)


subgroup_select_type.op2 <- 'nature_type.2'


f <- paste0(dir.report, 'plot_forest_cor_', today ,'.png'); f
png(file=f, 
    # width = 3.5, height = 4, units = 'in', 
    width = 1000, height = 1000, units = "px", pointsize = 22,
    # res = 200
    ) 
meta::forest(res_op2_presen_regr, 
             addpred=TRUE, header=TRUE, 
             digits=2, 
             print.I2 = T,
             layout = "RevMan5",
             xlim=xlim_custmize, slab = study_label_op2_pre, shade=TRUE)
dev.off() 


width_forestPlot = 40
height_cm <- nrow(df_op2_presence_regr)/1.1



add_subgroup_analysis <- T


ma_cor_op2_presen <- df_op2_presence_regr %>%
  dplyr::mutate(nature_type.2 = str_to_sentence(nature_type.2)
                
                ) %>%

  dplyr::mutate(subgroup_selected_type.op2 = !!sym(subgroup_select_type.op2))
 
  

unique(ma_cor_op2_presen$nature_type.2)


ma_cor_op2_pre <- meta::metacor(
  data = ma_cor_op2_presen,
  cor = mean_adjusted, 
  n = Treatment_N,
  studlab = study_label_op2_pre,
  fixed = FALSE,
  random = TRUE,
  method.tau = "REML",
  hakn = TRUE,
  title = "Mental health_op2_presence")
summary(ma_cor_op2_pre)


##  subgroup analysis - type
if (add_subgroup_analysis == T) {
  ma_cor_op2_pre_type <- update(ma_cor_op2_pre, subgroup = subgroup_selected_type.op2)
  #ma_cor_L1_type <- rma(yi, vi, mods = ~ subgroup_selected_type, data = ma_cor_op1_L1)
  
  test.effect.subgroup.random_para = TRUE
  postfix_subgroup_type <- paste0("subgroup_", subgroup_select_type.op2)
  height_cm <- height_cm
    
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup_type <- ""
  }

f <- paste0('./figures/', 'forest_op2_pre_',postfix_subgroup_type,  today, '.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm/0.5, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_op2_pre_type, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label_op2_pre, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()
```




## all data included
```{r - all clean} 
# import the database
#df_new <- read.xlsx( "P:/R/meta_mental wellbeing/result/exp_all_model_short2.xlsx", sheet = "try")
#df_exp_all_model <- read.xlsx( "P:/R/meta_mental wellbeing/result/exp_all_model_short.xlsx") #This is for the xlsx, but not the csv

df_exp_all_model <- read.csv(file = paste0(dir_share, 'exp_all_model_short.CSV'))

count_or_pear <- sum(grepl("^or$|corr_pear", df_exp_all_model$effect_size_indices))
print(count_or_pear)
count_linear_unstandard1 <-  sum(grepl("^coefficients$", df_exp_all_model$effect_size_indices))
print(count_linear_unstandard1)
count_linear_unstandard2 <-  sum(grepl("^Unstandardized coefficientss (or b)$", df_exp_all_model$effect_size_indices))
print(count_linear_unstandard2)
count_linear_standard <-  sum(grepl("^Standardized coefficientss (or β)$", df_exp_all_model$effect_size_indices))
print(count_linear_standard)
count_mixed <- sum(grepl(";", df_exp_all_model$effect_size_indices))
print(count_mixed)

unique_values <- unique(df_all_incl$effect_size)

## [] need to fix data that are out of range later ... 
df_all_incl <- df_exp_all_model %>%
  dplyr::filter(!is.na(Mean)) %>%
  dplyr::filter(!grepl("163", id)) %>%
  #dplyr::filter(!grepl("^or$|corr_pear", effect_size_indices)) %>%
  dplyr::filter(!grepl("Longitudinal", Study)) %>%
  #dplyr::filter(!grepl("Yes", Unstandardized_coef)) %>%
  dplyr::mutate(across(everything(), as.character), # Ensure all data is character before gsub
                 across(everything(), trimws),      # Trim whitespace for all columns
    effect_size = ifelse(is.na(subgroup_other), effect_size_indices, 
                   ifelse(grepl("^raw", subgroup_other), "linear_unstandardized", 
                          ifelse(grepl("^beta", subgroup_other), "linear_standardized", 
                                 ifelse(grepl("^linear", subgroup_other), "linear",
                                        ifelse(grepl("^pearson", subgroup_other), "pearson",effect_size_indices))))),
    effect_size = gsub("^Unstandardized coefficientss (or b)$","linear_unstandardized",effect_size),
    effect_size = gsub("^coefficients$","linear_unstandardized",effect_size),
    #effect_size = gsub("\\* \\(* or b\\)", "", effect_size),
    Mean = as.numeric(Mean),
    N = as.numeric(N),
    # mean_adjusted = Mean*MH_direction/range_MH,
    # mean_adjusted = as.numeric(mean_adjusted),
    Nature = gsub("Greenspace - Garden","Greenspace - low vegetation",Nature)
  ) %>%
  #dplyr::filter(!grepl("unstandardized", standardized,ignore.case = TRUE)) %>%


  # dplyr::filter(!is.na(mean_adjusted)) %>%
  as.data.frame()

unique_values <- unique(df_all_incl$effect_size)
print(unique_values)

type_count_all_incl <-  df_all_incl %>%
                        group_by(nature_type.1) %>%
                        count()
print(type_count)

paper_count_all_incl <-  df_all_incl %>%
                        group_by(id) %>%
                        count()

# 定义函数将OR转换为Pearson相关系数
convert_OR_to_pearson <- function(or, n) {
  or_numeric <- as.numeric(or)
  n_numeric <- as.numeric(n)
  pearson <- cos(pi/(1+sqrt(or_numeric))) 
  # which is from the chatgpt
  # log_odds <- log(or_numeric)
  # se_log_odds <- sqrt(1 / (n_numeric * (or_numeric^2)))
  # z <- log_odds / se_log_odds
  # pearson <- 2 *z/sqrt(n_numeric-3)
  return(pearson)
}

# 定义函数将OR转换为Fisher's z相关系数
# convert_OR_to_r <- function(or, n) {
#   convert_OR_to_d <- log(or)*sqrt(3)/pi
#   convert_d_to_r <- convert_OR_to_d / sqrt(convert_OR_to_d^2 + 4)
# }
# 定义函数将线性回归系数转换为Pearson相关系数
convert_linear_regression_to_pearson <- function(coef, n) {
  z <- coef * sqrt(n)
  pearson <- z / sqrt(1 + (z^2))
  return(pearson)
}

convert_linear_regression_to_standardized <- function(coef, SD_x, SD_y) {
  
  standardized <- coef * SD_y / SD_x
  return(standardized)
}

# A text for the convert from OR to pearson
OR <- c("0.88", "0.91", "0.790", "1.320", "5.14", "1.913")
N <- c("3145", "2367", "8793", "3461", "933", "3055")
pearson_cor <- convert_OR_to_pearson(OR, N)
print(pearson_cor)

df_all_incl$pearson_correlation <- ifelse(df_all_incl$effect_size == "or",
                                    convert_OR_to_pearson(df_all_incl$Mean, df_all_incl$N),df_all_incl$Mean)

#!!!*** Figure out how to convert the linear coef to pearson
# df_all_incl$pearson_correlation <- ifelse(df_all_incl$effect_size == "or",
#                                     convert_OR_to_pearson(df_all_incl$Mean, df_all_incl$N),
#                                     ifelse(df_all_incl$effect_size == "linear_unstandardized",
#                                            convert_linear_regression_to_standardized(df_all_incl$Mean, df_all_incl$MH_SD,df_all_incl$exp_SD),
#                                            ifelse(df_all_incl$effect_size == "linear",
#                                            convert_linear_regression_to_pearson(df_all_incl$Mean, df_all_incl$N),
#                                            ifelse(df_all_incl$effect_size == "Unstandardized coefficientss (or b)",
#                                            convert_linear_regression_to_pearson(df_all_incl$Mean, df_all_incl$N),
#                                            df_all_incl$Mean))))

  

dat_all_incl <- escalc(data=df_all_incl, measure="ZCOR", ri= pearson_correlation, ni=N)

study_label <- paste(dat_all_incl$id)
#study_label <- paste(dat$id, dat$model_id, sep = '_')

res_all_incl <- metafor::rma(yi, vi, data=dat_all_incl, slab = study_label)
res_all_incl
predict(res_all_incl, transf=transf.ztor) ## ztor: z to r


# outlier/influence diagnostics
par(mar=c(5,6,4,2))
plot(influence(res_all_incl), cex=0.8, las=1)
```


```{r - auto-report, eval=FALSE, include=FALSE}
### reporter() function
dir.report <- paste0('P:/R/meta_mental wellbeing/meta-analysis-nature-health-main/figures'); dir.report
metafor::reporter(res_all_incl, dir = dir.report)

# reporter(res, format="pdf", 
#          dir = paste0(dir.root, '/figures/'), 
#          filename = 'report_metafor.PDF')
#          
# reporter(res, format="word")

### add an outlier
# dat$yi[6] <- 2.5
# res <- rma(yi, vi, data=dat)
# reporter(res)
```


### meta_all_included
```{r}
m.cor.all.incl <- meta::metacor(
  data = df_all_incl,
  cor = pearson_correlation, 
  n = N,
  studlab = study_label,
  fixed = FALSE,
  random = TRUE,
  method.tau = "REML",
  hakn = TRUE,
  title = "Mental Wellbeing_all included")
summary(m.cor.all.incl)


# m.cor <- meta::metacor(
#   data = df_new_coef,
#   cor = mean, 
#   n = n,
#   studlab = study_label,
#   fixed = FALSE,
#   random = TRUE,
#   method.tau = "REML",
#   hakn = TRUE,
#   title = "Mental Wellbeing")
# summary(m.cor)

```



## Original binary meta which cares nothing, just for a test
```{r - binary clean} 
# import the database
#df_new <- read.xlsx( "P:/R/meta_mental wellbeing/result/exp_all_model_short2.xlsx", sheet = "try")
#df_exp_all_model <- read.xlsx( "P:/R/meta_mental wellbeing/result/exp_all_model_short.xlsx") #This is for the xlsx, but not the csv

df_exp_all_model <- read.csv(file = paste0(dir_share, 'exp_all_model_short.CSV'))

count_or_pear <- sum(grepl("^or$|corr_pear", df_exp_all_model$effect_size_indices))
print(count_or_pear)
## [] need to fix data that are out of range later ... 
df_binary <- df_exp_all_model %>%
  dplyr::filter(!is.na(Mean)) %>%
  dplyr::filter(!grepl("^or$|corr_pear", effect_size_indices)) %>%
  dplyr::filter(!grepl("Longitudinal", Study)) %>%
  dplyr::filter(!grepl("Yes", Unstandardized_coef)) %>%
  dplyr::mutate(
    mean_adjusted = Mean*MH_direction/range_MH,
    mean_adjusted = as.numeric(mean_adjusted),
    Nature = gsub("Greenspace - Garden","Greenspace - low vegetation",Nature)
  ) %>%
  dplyr::filter(!is.na(mean_adjusted)) %>%
  as.data.frame()

  

dat_binary <- escalc(data=df_binary, measure="ZCOR", ri= mean_adjusted, ni=N)

study_label <- paste(dat_binary$id)
#study_label <- paste(dat$id, dat$model_id, sep = '_')

res_binary <- metafor::rma(yi, vi, data=dat_binary, slab = study_label)
res_binary
predict(res_binary, transf=transf.ztor) ## ztor: z to r


# outlier/influence diagnostics
par(mar=c(5,6,4,2))
plot(influence(res_binary), cex=0.8, las=1)
```

```{r - auto-report, eval=FALSE, include=FALSE}
### reporter() function
dir.report <- paste0('P:/R/meta_mental wellbeing/meta-analysis-nature-health-main/figures'); dir.report
metafor::reporter(res_binary, dir = dir.report)

# reporter(res, format="pdf", 
#          dir = paste0(dir.root, '/figures/'), 
#          filename = 'report_metafor.PDF')
#          
# reporter(res, format="word")

### add an outlier
# dat$yi[6] <- 2.5
# res <- rma(yi, vi, data=dat)
# reporter(res)
```



### meta_binary
```{r}
m.cor.binary <- meta::metacor(
  data = df_binary,
  cor = mean_adjusted, 
  n = N,
  studlab = study_label,
  fixed = FALSE,
  random = TRUE,
  method.tau = "REML",
  hakn = TRUE,
  title = "Mental Wellbeing_binary")
summary(m.cor.binary)


# m.cor <- meta::metacor(
#   data = df_new_coef,
#   cor = mean, 
#   n = n,
#   studlab = study_label,
#   fixed = FALSE,
#   random = TRUE,
#   method.tau = "REML",
#   hakn = TRUE,
#   title = "Mental Wellbeing")
# summary(m.cor)

```




## Continuous clean
```{r - continuous}

# df_continuous <- df_exp_all_model %>%
#   dplyr::filter(!is.na(Mean)) %>%
#   dplyr::filter(!grepl("^or$|corr_pear", effect_size_indices)) %>%
#   dplyr::filter(!grepl("Categorical", exp_SD)) %>%
#   dplyr::filter(!is.na(range_exp)) %>%
#   dplyr::filter(grepl("^1$|^2$|^100$", range_exp))%>%
#   dplyr::mutate(
#     mean_adjusted = Mean*MH_direction/100,
#     mean_adjusted = as.numeric(mean_adjusted),
#     mean_adjusted = ifelse(grepl("100", range_exp),Mean*MH_direction/10000, "range_exp"),
#     nature_quantity = ifelse(grepl("frequency", nature_quantity.1), "visit frequency",
#                         ifelse(grepl("duration|Time in greenspace|time spent on visiting green space close to home", nature_quantity.1), "visit duration",
#                         ifelse(grepl("Distance", nature_quantity.1), "distance to nature",
#                         ifelse(grepl("access", nature_quantity.1), "access to nature",
#                         ifelse(grepl("view", nature_quantity.1), "nature view",
#                         ifelse(grepl("view|Visible greenery from home", nature_quantity.1), "nature view",
#                         ifelse(grepl("SVG|Streetscape greenery", nature_quantity.1), "SVG",
#                                     nature_quantity.1)))))))
#   ) %>%
#   dplyr::filter(!is.na(mean_adjusted)) %>%
#   
#   #dplyr::select(-nature_quantity.1) %>%
#   as.data.frame()

df_continuous <- df_exp_all_model %>%
  dplyr::filter(!is.na(Mean)) %>%
  dplyr::filter(!grepl("^or$|corr_pear", effect_size_indices)) %>%
  dplyr::filter(!grepl("Categorical", exp_SD)) %>%
  dplyr::filter(!is.na(range_exp)) %>%
  dplyr::filter(grepl("^1$|^2$|^100$", range_exp)) %>%
  dplyr::filter(!grepl("Yes", Unstandardized_coef)) %>%
  dplyr::mutate(
    mean_adjusted = Mean * MH_direction /range_MH ,
    mean_adjusted = as.numeric(mean_adjusted),
   #mean_adjusted = ifelse(grepl("100", range_exp), Mean * MH_direction / 10000, range_exp),
    nature_quantity = ifelse(grepl("frequency", nature_quantity.1), "visit frequency",
                        ifelse(grepl("duration|Time in greenspace|time spent on visiting green space close to home", nature_quantity.1), "visit duration",
                        ifelse(grepl("Distance", nature_quantity.1), "distance to nature",
                        ifelse(grepl("access", nature_quantity.1), "access to nature",
                        ifelse(grepl("view", nature_quantity.1), "nature view",
                        ifelse(grepl("view|Visible greenery from home", nature_quantity.1), "nature view",
                        ifelse(grepl("SVG|Streetscape greenery", nature_quantity.1), "SVG",
                                    nature_quantity.1)))))))
  ) %>%
  dplyr::filter(!is.na(mean_adjusted)) %>%
  as.data.frame()

type_count_conti <-  df_continuous %>%
                        group_by(nature_type.1) %>%
                        count()
paper_count_conti <-  df_continuous %>%
                        group_by(id) %>%
                        count()

dat_continuous <- escalc(data=df_continuous, measure="ZCOR", ri=mean_adjusted, ni=N)
study_label <- paste(dat_continuous$id)
#study_label <- paste(dat$id, dat$model_id, sep = '_')

res_continuous <- metafor::rma(yi, vi, data=dat_continuous, slab = study_label)
res_continuous
predict(res_continuous, transf=transf.ztor) ## ztor: z to r



# outlier/influence diagnostics
par(mar=c(5,6,4,2))
plot(influence(res_continuous), cex=0.8, las=1)

```


```{r - auto-report, eval=FALSE, include=FALSE}
### reporter() function
dir.report <- paste0('P:/R/meta_mental wellbeing/meta-analysis-nature-health-main/figures'); dir.report
metafor::reporter(res_continuous, dir = dir.report)

# reporter(res, format="pdf", 
#          dir = paste0(dir.root, '/figures/'), 
#          filename = 'report_metafor.PDF')
#          
# reporter(res, format="word")

### add an outlier
# dat$yi[6] <- 2.5
# res <- rma(yi, vi, data=dat)
# reporter(res)
```


### meta_continuous
```{r}
m.cor.continuous <- meta::metacor(
  data = df_continuous,
  cor = mean_adjusted, 
  n = N,
  studlab = study_label,
  fixed = FALSE,
  random = TRUE,
  method.tau = "REML",
  hakn = TRUE,
  title = "Mental Wellbeing_continuous")
summary(m.cor.continuous)
```

# group1 - Regression clean
```{r - regression}

# df_continuous <- df_exp_all_model %>%
#   dplyr::filter(!is.na(Mean)) %>%
#   dplyr::filter(!grepl("^or$|corr_pear", effect_size_indices)) %>%
#   dplyr::filter(!grepl("Categorical", exp_SD)) %>%
#   dplyr::filter(!is.na(range_exp)) %>%
#   dplyr::filter(grepl("^1$|^2$|^100$", range_exp))%>%
#   dplyr::mutate(
#     mean_adjusted = Mean*MH_direction/100,
#     mean_adjusted = as.numeric(mean_adjusted),
#     mean_adjusted = ifelse(grepl("100", range_exp),Mean*MH_direction/10000, "range_exp"),
#     nature_quantity = ifelse(grepl("frequency", nature_quantity.1), "visit frequency",
#                         ifelse(grepl("duration|Time in greenspace|time spent on visiting green space close to home", nature_quantity.1), "visit duration",
#                         ifelse(grepl("Distance", nature_quantity.1), "distance to nature",
#                         ifelse(grepl("access", nature_quantity.1), "access to nature",
#                         ifelse(grepl("view", nature_quantity.1), "nature view",
#                         ifelse(grepl("view|Visible greenery from home", nature_quantity.1), "nature view",
#                         ifelse(grepl("SVG|Streetscape greenery", nature_quantity.1), "SVG",
#                                     nature_quantity.1)))))))
#   ) %>%
#   dplyr::filter(!is.na(mean_adjusted)) %>%
#   
#   #dplyr::select(-nature_quantity.1) %>%
#   as.data.frame()


df_exp_all_model_noncross <- df_exp_all_model %>%
  filter(!grepl("cross sectional study", Study, ignore.case = TRUE)) %>%
  group_by(id) %>%
  # dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  tally() %>%
  ungroup() %>%
  #arrange(Tools) %>%
  as.data.frame()
  

df_exp_all_model_cross_cont <- df_exp_all_model %>%
  dplyr::filter(grepl("cross sectional study", Study, ignore.case = TRUE)) %>%
  dplyr::filter(!is.na(exp_SD)) %>%
  dplyr::filter(!grepl("Categorical|^$", exp_SD, ignore.case = TRUE)) %>%
  as.data.frame()
  
df_exp_all_model_cross_cont_regr <- df_exp_all_model_cross_cont %>%
  dplyr::filter(!grepl("D (Raw or unstandardized mean difference)|corr_Pearson|coef_MLR_standardized", effect_size_indice, ignore.case = TRUE)) %>%
  as.data.frame()


# df_exp_all_model_orpear <- df_exp_all_model_noncross %>%
#   filter(!grepl("^or$|corr_pear", indice, ignore.case = TRUE)) %>%
#   nrow()
#   # group_by(id) %>%
#   # dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
#   #arrange(Tools) %>%
# print(df_exp_all_model_noncross)


df_include <- df_exp_all_model %>%
  dplyr::filter(!is.na(Mean)) %>%
  dplyr::filter(!grepl("163", id)) %>%
  # dplyr::filter(!is.na(nature_quantity.1)) %>%
  # dplyr::filter(!is.na(buffer)) %>%
  dplyr::filter(grepl("Cross sectional study", Study, ignore.case = TRUE))%>%
  dplyr::filter(!grepl("Categorical", exp_SD, ignore.case = TRUE)) %>%
  dplyr::filter(!is.na(range_exp)) %>%
  dplyr::filter(grepl("^1$|^2$|^100$", range_exp)) %>%
  dplyr::filter(!grepl("D (Raw or unstandardized mean difference)|corr_Pearson|coef_MLR_standardized", effect_size_indice, ignore.case = TRUE)) %>%
  #dplyr::filter(grepl("Greenspace - General", nature_type.1, ignore.case = TRUE))%>%
                
  
  # dplyr::mutate(
  # indice = ifelse(!grepl(";", effect_size_indices,fixed = TRUE), effect_size_indices, 
  #                 ifelse(grepl("^raw", subgroup_other), "unstandardized coefficient",
  #                        ifelse(grepl("^beta", subgroup_other), "standardized coefficient", 
  #                               ifelse(grepl("Odds ratio", subgroup_other, ignore.case = TRUE), "or", effect_size_indices)))))%>%
  
                         
    # is.na(subgroup_other), effect_size_indices, 
    #                ifelse(grepl("^raw", subgroup_other), "unstandardized", 
    #                       ifelse(grepl("^beta", subgroup_other), "standardized", 
    #                              ifelse(grepl("^linear", subgroup_other), "linear",
    #                                     ifelse(grepl("^pearson", subgroup_other), "pearson",Unstandardized_coef))))),
  as.data.frame()

f <- paste0(dir_share, 'exp_include_final.CSV')
readr::write_csv(x = df_include, file = f)



df_regression <- df_include %>%
  dplyr::filter(!grepl("^or$", effect_size_indice, ignore.case = TRUE)) %>%
  #dplyr::filter(!grepl(indice == "standardized coefficient" | indice == "standardized coefficient" | indice == "corr_pear")) %>%
  #dplyr::filter(!grepl("Categorical", exp_SD, ignore.case = TRUE)) %>%
  #dplyr::filter(!is.na(range_exp)) %>%
  #dplyr::filter(grepl("^1$|^2$|^100$", range_exp)) %>%
  # dplyr::filter(!grepl("standardized", indice)) %>%
  dplyr::mutate(
    mean_adjusted = Mean * MH_direction /range_MH ,
    mean_adjusted = as.numeric(mean_adjusted),
   # mean_adjusted = ifelse(grepl("100", range_exp), Mean/range_MH * MH_direction / 100, range_exp),
   nature_quantity = ifelse(grepl("frequency", nature_quantity.1), "visit frequency",
                       ifelse(grepl("duration|Time in greenspace|time spent on visiting green space close to home", nature_quantity.1), "visit duration",
                       ifelse(grepl("Distance", nature_quantity.1), "distance to nature",
                       ifelse(grepl("access", nature_quantity.1), "access to nature",
                       ifelse(grepl("view", nature_quantity.1), "nature view",
                       ifelse(grepl("view|Visible greenery from home", nature_quantity.1), "nature view",
                       ifelse(grepl("SVG|Streetscape greenery", nature_quantity.1), "SVG",
                        nature_quantity.1
                                   ))))))),
   nature_quantity = ifelse(is.na(nature_quantity), "percentage of greenspace", nature_quantity),
   nature_quantity = gsub("Blue space coverage","percentage of bluespace", nature_quantity),
   nature_quantity = gsub("Green space coverage","percentage of greenspace",nature_quantity),
   nature_quantity = gsub("Home\\s+Year\\s+Vegetation", "percentage of greenspace", nature_quantity),
   nature_quantity = gsub("access to nature","access", nature_quantity),
   nature_quantity = gsub("Per capita green area","percentage of greenspace",nature_quantity),
   nature_quantity = gsub("proportion of water area","percentage of bluespace",nature_quantity),
   nature_quantity = gsub("Tree cover","percentage of greenspace",nature_quantity),
   nature_quantity = gsub("Percentage of greenspace","percentage of greenspace",nature_quantity),
   buffer = ifelse(id == "102", "500", buffer),
   buffer = ifelse(id == "2661" & Notes == "city", 10000,
                   ifelse(id == "2661" & Notes == "local", 50, buffer)),
    buffer = gsub("1080","1000",buffer),
    buffer = gsub("^50$","100",buffer),
    buffer = gsub("1600","1500",buffer),
    buffer = gsub("10000","2000", buffer),
    buffer = gsub("3000","2000", buffer)
   
  ) %>%
  
  dplyr::filter(!is.na(mean_adjusted)) %>%
  as.data.frame()

f <- paste0(dir_share, 'exp_include_final_regr.CSV')
readr::write_csv(x = df_regression, file = f)

# df_OR <- df_include %>%
#   dplyr::filter(grepl("^or$", effect_size_indice, ignore.case = TRUE)) %>%
#   as.data.frame()

type_count_regr <-  df_regression %>%
                        group_by(nature_type.1) %>%
                        count()

paper_coun_prep <- df_exp_all_model %>%
                        group_by(id) %>%
                        count()

paper_coun_incl <- df_include %>%
                        group_by(id) %>%
                        count()

paper_count_regr <-  df_regression %>%
                        group_by(id) %>%
                        count()

paper_count_or <- df_include %>%
  dplyr::filter(grepl("^or$", effect_size_indice, ignore.case = TRUE)) %>%
  group_by(id) %>%
  count()
  

dat_regression <- escalc(data=df_regression, measure="ZCOR", ri=mean_adjusted, ni=N)
study_label <- paste(dat_regression$id)
#study_label <- paste(dat$id, dat$model_id, sep = '_')

res_regression <- metafor::rma(yi, vi, data=dat_regression, slab = study_label)
res_regression
predict(res_regression, transf=transf.ztor) ## ztor: z to r



# outlier/influence diagnostics
par(mar=c(5,6,4,2))
plot(influence(res_regression), cex=0.8, las=1)

```

## group1 - meta_regression 
```{r}
m.cor.regression <- meta::metacor(
  data = df_regression,
  cor = mean_adjusted, 
  n = N,
  studlab = study_label,
  fixed = FALSE,
  random = TRUE,
  method.tau = "REML",
  hakn = TRUE,
  title = "Mental Wellbeing_regression")
summary(m.cor.regression)
```


# group2 - OR clean
```{r - OR}
df_OR <- df_include %>%
  dplyr::filter(!is.na(Mean)) %>%
  dplyr::filter(grepl("^or$", effect_size_indice,ignore.case = TRUE)) %>%
  # dplyr::filter(!grepl("Categorical", exp_SD)) %>%
  # dplyr::filter(!is.na(range_exp)) %>%
  # dplyr::filter(grepl("^1$|^2$|^100$", range_exp)) %>%
  # dplyr::filter(!grepl("Yes", Unstandardized_coef)) %>%
  dplyr::mutate(
    # mean_adjusted = Mean * MH_direction /range_MH ,
    # mean_adjusted = as.numeric(mean_adjusted),
   #mean_adjusted = ifelse(grepl("100", range_exp), Mean * MH_direction / 10000, range_exp),
    Mean = as.numeric(Mean),
    N = as.numeric(N),
    nature_quantity = ifelse(grepl("frequency", nature_quantity.1), "visit frequency",
                        ifelse(grepl("duration|Time in greenspace|time spent on visiting green space close to home", nature_quantity.1), "visit duration",
                        ifelse(grepl("Distance", nature_quantity.1), "distance to nature",
                        ifelse(grepl("access", nature_quantity.1), "access to nature",
                        ifelse(grepl("view", nature_quantity.1), "nature view",
                        ifelse(grepl("view|Visible greenery from home", nature_quantity.1), "nature view",
                        ifelse(grepl("SVG|Streetscape greenery", nature_quantity.1), "SVG",
                                    nature_quantity.1)))))))
  ) %>%
  # dplyr::filter(!is.na(mean_adjusted)) %>%
  as.data.frame()

# check if the Mean value is numeric
# non_numeric_mean <- df_OR[!grepl("^-?\\d+\\.?\\d*$", df_OR$Mean), "Mean"]
# print(non_numeric_mean)

type_count_conti <-  df_OR %>%
                        group_by(nature_type.1) %>%
                        count()
paper_count_conti <-  df_OR %>%
                        group_by(id) %>%
                        count()

#dat_OR <- escalc(data=df_OR, measure="ZCOR", ri=Mean, ni=N)
#dat_OR <- escalc(data = df_OR, measure = "OR", ai = Mean, bi = N)
dat_OR <- escalc(measure = "OR", ai = Mean, bi = N, data = df_OR)
study_label <- paste(dat_OR$id)

res_OR <- metafor::rma(yi, vi, data=dat_OR)
res_OR
predict(res_OR, transf= exp) # exp: log OR to OR


# outlier/influence diagnostics
par(mar=c(5,6,4,2))
plot(influence(res_OR), cex=0.8, las=1)




```



## Heterogeneity

  If the confidence interval around τ^2 does not contain zero, it indicates that some between-study heterogeneity exists in our data. 
  The value of τ is x, meaning that the true effect sizes have an estimated standard deviation of SD=x, expressed on the scale of the effect size metric.
  
  A look at the second line reveals that I^2= 63% and that H (the square root of H2) is 1.64. This means that more than half of the variation in our data is estimated to stem from true effect size differences. Using Higgins and Thompson’s “rule of thumb”, we can characterize this amount of heterogeneity as moderate to large.
  
  Here is how we could report the amount of heterogeneity we found in our example:

  ```The between-study heterogeneity variance was estimated at ^τ2 = 0.08 (95%CI: 0.03-0.35), with an I2 value of 63% (95%CI: 38-78%). The prediction interval ranged from g = -0.06 to 1.21, indicating that negative intervention effects cannot be ruled out for future studies.```


### Forest plot
  https://wviechtb.github.io/metafor/reference/forest.rma.html
```{r - forest - all included}
### forest plot --------------------------------------------------------------------------
# forest(res)
# forest(res, addpred=TRUE, header=TRUE)
# print(forest(res, addpred=TRUE, header=TRUE))
xlim_custmize = c(-1,1)


f <- paste0(dir.report, 'plot_forest_cor_', today ,'.png'); f
png(file=f, 
    # width = 3.5, height = 4, units = 'in', 
    width = 1000, height = 1000, units = "px", pointsize = 22,
    # res = 200
    ) 
meta::forest(res_all_incl, 
             addpred=TRUE, header=TRUE, 
             digits=2, 
             print.I2 = T,
             layout = "RevMan5",
             xlim=xlim_custmize, slab = study_label, shade=TRUE)
dev.off() 



forest(res_all_incl, addpred=TRUE, header=TRUE, xlim=xlim_custmize, slab = study_label) # showweights=TRUE
forest(res_all_incl, addpred=TRUE, header=TRUE, xlim=xlim_custmize, atransf=exp)
#' optional argument to specify a function to transform the x-axis labels and annotations (e.g., atransf=exp)
forest(res_all_incl, addpred=TRUE, header=TRUE, xlim=xlim_custmize, atransf=exp, at=log(c(.6, .8, 1, 1.2, 1.4)))
```



```{r - forest - binary}
### forest plot --------------------------------------------------------------------------
# forest(res)
# forest(res, addpred=TRUE, header=TRUE)
# print(forest(res, addpred=TRUE, header=TRUE))
xlim_custmize = c(-1,1)


f <- paste0(dir.report, 'plot_forest_cor_', today ,'.png'); f
png(file=f, 
    # width = 3.5, height = 4, units = 'in', 
    width = 1000, height = 1000, units = "px", pointsize = 22,
    # res = 200
    ) 
meta::forest(res_binary, 
             addpred=TRUE, header=TRUE, 
             digits=2, 
             print.I2 = T,
             layout = "RevMan5",
             xlim=xlim_custmize, slab = study_label, shade=TRUE)
dev.off() 



forest(res_binary, addpred=TRUE, header=TRUE, xlim=xlim_custmize, slab = study_label) # showweights=TRUE
forest(res_binary, addpred=TRUE, header=TRUE, xlim=xlim_custmize, atransf=exp)
#' optional argument to specify a function to transform the x-axis labels and annotations (e.g., atransf=exp)
forest(res_binary, addpred=TRUE, header=TRUE, xlim=xlim_custmize, atransf=exp, at=log(c(.6, .8, 1, 1.2, 1.4)))
```



```{r - forest - continuous}
### forest plot --------------------------------------------------------------------------
# forest(res)
# forest(res, addpred=TRUE, header=TRUE)
# print(forest(res, addpred=TRUE, header=TRUE))
xlim_custmize = c(-1,1)


f <- paste0(dir.report, 'plot_forest_cor_', today ,'.png'); f
png(file=f, 
    # width = 3.5, height = 4, units = 'in', 
    width = 1000, height = 1000, units = "px", pointsize = 22,
    # res = 200
    ) 
meta::forest(res_continuous, 
             addpred=TRUE, header=TRUE, 
             digits=2, 
             print.I2 = T,
             layout = "RevMan5",
             xlim=xlim_custmize, slab = study_label, shade=TRUE)
dev.off() 



forest(res_continuous, addpred=TRUE, header=TRUE, xlim=xlim_custmize, slab = study_label) # showweights=TRUE
forest(res_continuous, addpred=TRUE, header=TRUE, xlim=xlim_custmize, atransf=exp)
#' optional argument to specify a function to transform the x-axis labels and annotations (e.g., atransf=exp)
forest(res_continuous, addpred=TRUE, header=TRUE, xlim=xlim_custmize, atransf=exp, at=log(c(.6, .8, 1, 1.2, 1.4)))
```



* NOT in use
```{r - subgroup - to be fixed, eval=FALSE, include=FALSE}
# a little helper function to add Q-test, I^2, and tau^2 estimate info
mlabfun <- function(text, res) {
   list(bquote(paste(.(text),
      " (Q = ", .(formatC(res$QE, digits=2, format="f")),
      ", df = ", .(res$k - res$p),
      ", p ", .(metafor:::.pval(res$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
      I^2, " = ", .(formatC(res$I2, digits=1, format="f")), "%, ",
      tau^2, " = ", .(formatC(res$tau2, digits=2, format="f")), ")")))}

# set up forest plot (with 2x2 table counts added; the 'rows' argument is
# used to specify in which rows the outcomes will be plotted)
# forest(res, addpred=TRUE, header=TRUE, xlim=xlim_custmize, slab = study_label)
forest(res, 
       addpred=TRUE, 
       slab = study_label,
       # xlim=c(-16, 4.6), at=log(c(0.05, 0.25, 1, 4)), 
       # atransf=exp,
       # ilab=cbind(dat$tpos, dat$tneg, dat$cpos, dat$cneg),
       # ilab.xpos=c(-9.5,-8,-6,-4.5), cex=0.90, 
       # ylim=c(-1, 27),            ## add extra space in plot
       order=dat$nature_quantity, 
       # rows=c(3:4,9:15,20:23),    ## set positions
       mlab=mlabfun("RE Model for All Studies", res),
       psize=1, header="Author(s) and Year")

# set font expansion factor (as in forest() above) and use a bold font
op <- par(cex=0.90, font=2)


# switch to bold italic font
par(font=4)

# add text for the subgroups
text(-16, c(24,16,5), pos=4, c("Systematic Allocation",
                               "Random Allocation",
                               "Alternate Allocation"))

# set par back to the original settings
par(op)

# change the nature quantity to a same format
dat <- dat %>% 
  dplyr::mutate(
    nature_quantity.1 = gsub("Streetscape greenery", "SVG", nature_quantity.1)
    #nature_quantity.1 = gsub("Streetscape greenery", "SVG", nature_quantity.1),
    ) %>%
   as.data.frame()

# fit random-effects model in the three subgroups
res.s <- rma(yi, vi, subset=(nature_quantity.1 =="NDVI"), data=dat)  # Any difference among the letters of res?
res.t <- rma(yi, vi, subset=(nature_quantity.1 =="NDWI"), data=dat)
res.r <- rma(yi, vi, subset=(nature_quantity.1 =="Percentage of bluespace"),     data=dat)
res.a <- rma(yi, vi, subset=(nature_quantity.1 =="SVG; SVG-grass; SVG-tree; SVG-quantity"),     data=dat) #SVG| SVG-grass|SVG-tree|SVG-quantity
# res.a <- rma(yi, vi, subset=(nature_quantity.1 =="Other: Percentage of greenspace; Percentage of bluespace; presence of a garden"),  data=dat)

# add summary polygons for the three subgroups
addpoly(res.s, row=18.5, cex=0.90, 
        # atransf=exp, 
        mlab=mlabfun("RE Model for Subgroup", res.s))
addpoly(res.t, row=12.5, cex=0.90, 
        # atransf=exp, 
        mlab=mlabfun("RE Model for Subgroup", res.t))
addpoly(res.r, row= 7.5, cex=0.90, 
        # atransf=exp, 
        mlab=mlabfun("RE Model for Subgroup", res.r))
addpoly(res.a, row= 1.5, cex=0.90, 
        # atransf=exp, 
        mlab=mlabfun("RE Model for Subgroup", res.a))

# fit meta-regression model to test for subgroup differences
res <- rma(yi, vi, mods = ~ nature_quantity.1, data=dat)

# add text for the test of subgroup differences
text(x = -16, y = -1.8, pos=4, cex=0.90, bquote(paste("Test for Subgroup Differences: ",
     Q[M], " = ", .(formatC(res$QM, digits=2, format="f")), ", df = ", .(res$p - 1),
     ", p = ", .(formatC(res$QMp, digits=2, format="f")))))
```


```{r - forest - meta - all included}
width_forestPlot = 40
height_cm <- nrow(df_all_incl)/1.1

f <- paste0('./figures/', 'plot_forest_cor_meta_', today, '3.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot, height = height_cm/1.5, units = "cm", res = 100)
  
  
p_forest <- meta::forest(
  m.cor.all.incl, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()
```


```{r - forest - meta - binary}
width_forestPlot = 40
height_cm <- nrow(df_binary)/1.1

f <- paste0('./figures/', 'plot_forest_cor_meta_', today, '3.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot, height = height_cm/1.5, units = "cm", res = 100)
  
  
p_forest <- meta::forest(
  m.cor.binary, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()
```

# forest - meta - all included - subgroup
```{r - forest - meta - subgroup}
add_subgroup_analysis <- T

subgroup_select_type <- 'Nature'
subgroup_select_quantity <- 'nature_quantity.1'
subgroup_select_buffer <- 'buffer'
# subgroup_select <- 'nature_type.1'
# subgroup_select <- 'nature_quantity.1'

ma_cor_data <- df_all_incl %>%
  dplyr::mutate(Nature = str_to_sentence(Nature),
                buffer = str_to_sentence(buffer),
                nature_quantity.1 = case_when(
                  nature_quantity.1 %in% c("Streetscape greenery", 'SVG-quantity',
                                        "SVG-grass", "SVG-tree") ~ "SVG",
                  # nature_type_o1 == "Home/ courtyard garden" ~ "Greenspace",
                  # nature_type_o1 == "Community private green space" ~ "Greenspace",
                T ~ nature_quantity.1
                
                )) %>%
  #dplyr::mutate(Nature = gsub("NA","Greenspace - general",Nature)) %>%
  #dplyr::filter(!is.na(Nature)) %>%
  #dplyr::filter(!is.na(nature_quantity.1)) %>%
  #dplyr::filter(!is.na(buffer)) %>%
  dplyr::mutate(subgroup_selected_type = !!sym(subgroup_select_type))%>%
  dplyr::mutate(subgroup_selected_quantity = !!sym(subgroup_select_quantity))%>%
  dplyr::mutate(subgroup_selected_buffer = !!sym(subgroup_select_buffer))

ma_cor_data$subgroup_selected_type <- ifelse(is.na(ma_cor_data$subgroup_selected_type), "Greenspace - general", ma_cor_data$subgroup_selected_type)

unique(ma_cor_data$Nature)
unique(ma_cor_data$nature_quantity.1)
unique(ma_cor_data$buffer)


ma_cor_all_incl <-
  meta::metacor(
    data = ma_cor_data,
    cor = pearson_correlation, #Why divide by 100 remains a question cuz I forget why.=> Remember in the metacor function, the value of "cor" should be in (-1,1)
    n = N,
    studlab = study_label,
    fixed = FALSE,
    random = TRUE,
    method.tau = "REML",
    hakn = TRUE,
    title = "Mental Wellbeing_all_incl")

# length(pearson_correlation)
# length(study_label)


## update the MA by adding subgroup analysis - type
if (add_subgroup_analysis == T) {
  ma_cor_type <- update(ma_cor_all_incl, subgroup = subgroup_selected_type)
  
  test.effect.subgroup.random_para = TRUE
  postfix_subgroup_type <- paste0("_subgroup_", subgroup_select_type)
  height_cm <- height_cm
    
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup_type <- ""
  }

f <- paste0('./figures/', 'forest_all_incl_meta_type_',postfix_subgroup_type,  today, '.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm/1.2, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_type, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()
```





# forest - meta - binary - subgroup
```{r - forest - meta - subgroup}
add_subgroup_analysis <- T

subgroup_select_type <- 'Nature'
subgroup_select_quantity <- 'nature_quantity.1'
subgroup_select_buffer <- 'buffer'
# subgroup_select <- 'nature_type.1'
# subgroup_select <- 'nature_quantity.1'

ma_cor_data <- df_binary %>%
  dplyr::mutate(Nature = str_to_sentence(Nature),
                buffer = str_to_sentence(buffer),
                nature_quantity.1 = case_when(
                  nature_quantity.1 %in% c("Streetscape greenery", 'SVG-quantity',
                                        "SVG-grass", "SVG-tree") ~ "SVG",
                  # nature_type_o1 == "Home/ courtyard garden" ~ "Greenspace",
                  # nature_type_o1 == "Community private green space" ~ "Greenspace",
                T ~ nature_quantity.1
                )) %>%
  #dplyr::filter(!is.na(nature_type.1)) %>%
  #dplyr::filter(!is.na(nature_quantity.1)) %>%
  #dplyr::filter(!is.na(buffer)) %>%
  dplyr::mutate(subgroup_selected_type = !!sym(subgroup_select_type))%>%
  dplyr::mutate(subgroup_selected_quantity = !!sym(subgroup_select_quantity))%>%
  dplyr::mutate(subgroup_selected_buffer = !!sym(subgroup_select_buffer))

unique(ma_cor_data$nature_type.1)
unique(ma_cor_data$nature_quantity.1)
unique(ma_cor_data$buffer)


ma_cor_binary <-
  meta::metacor(
    data = ma_cor_data,
    cor = mean_adjusted, #Why divide by 100 remains a question cuz I forget why.=> Remember in the metacor function, the value of "cor" should be in (-1,1)
    n = N,
    studlab = study_label,
    fixed = FALSE,
    random = TRUE,
    method.tau = "REML",
    hakn = TRUE,
    title = "Mental Wellbeing_binary")

# length(ma_cor)
# length(subgroup_select_quantity)


## update the MA by adding subgroup analysis - type
if (add_subgroup_analysis == T) {
  ma_cor_type <- update(ma_cor_binary, subgroup = subgroup_selected_type)
  
  test.effect.subgroup.random_para = TRUE
  postfix_subgroup_type <- paste0("_subgroup_", subgroup_select_type)
  height_cm <- height_cm
    
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup_type <- ""
  }

f <- paste0('./figures/', 'forest_binary_meta_type_',postfix_subgroup_type,  today, '.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm/1.2, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_type, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()



## update the MA by adding subgroup analysis - quantity, **the quantity in binary is not necessary, only for the continuous
if (add_subgroup_analysis == T) {
  ma_cor_quantity <- update(ma_cor_binary, subgroup = subgroup_selected_quantity)
  
  test.effect.subgroup.random_para = TRUE
  postfix_subgroup_quantity <- paste0("_subgroup_", subgroup_select_quantity)
  height_cm <- height_cm
    
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup_quantity <- ""
  }


f <- paste0('./figures/', 'forest_cor_meta_quantity_',postfix_subgroup_quantity,  today, '.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm/1.2, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_quantity, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()


## update the MA by adding subgroup analysis - buffer
if (add_subgroup_analysis == T) {
  ma_cor_buffer <- update(ma_cor, subgroup = subgroup_selected_buffer)
  
  test.effect.subgroup.random_para = TRUE
  postfix_subgroup_buffer <- paste0("_subgroup_", subgroup_select_buffer)
  height_cm <- height_cm
    
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup_buffer <- ""
  }

f <- paste0('./figures/', 'forest_cor_meta_buffer_',postfix_subgroup_buffer,  today, '.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm/1.2, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_buffer, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()
```


```{r - forest - meta - continuous}
width_forestPlot = 40
height_cm <- nrow(df_continuous)/1.1

f <- paste0('./figures/', 'plot_continuous_cor_meta_', today, '3.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot, height = height_cm/1.5, units = "cm", res = 100)
  
  
p_forest <- meta::forest(
  m.cor.continuous, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()
```


# forest - meta - continuous - subgroup
```{r - forest - meta - subgroup}
add_subgroup_analysis <- T

subgroup_select_type <- 'nature_type.1'
subgroup_select_quantity <- 'nature_quantity.1'
subgroup_select_buffer <- 'buffer'
# subgroup_select <- 'nature_type.1'
# subgroup_select <- 'nature_quantity.1'

ma_cor_data <- df_continuous %>%
  dplyr::mutate(nature_type.1 = str_to_sentence(nature_type.1),
                buffer = str_to_sentence(buffer),
                nature_quantity.1 = case_when(
                  nature_quantity.1 %in% c("Streetscape greenery", 'SVG-quantity',
                                        "SVG-grass", "SVG-tree") ~ "SVG",
                  # nature_type_o1 == "Home/ courtyard garden" ~ "Greenspace",
                  # nature_type_o1 == "Community private green space" ~ "Greenspace",
                T ~ nature_quantity.1
                )) %>%
  #dplyr::filter(!is.na(nature_type.1)) %>%
  #dplyr::filter(!is.na(nature_quantity.1)) %>%
  #dplyr::filter(!is.na(buffer)) %>%
  dplyr::mutate(
    subgroup_select_buffer = gsub("400","500",subgroup_select_buffer),
    subgroup_select_buffer = gsub("1080","1000",subgroup_select_buffer),
    #buffer = gsub("50","100",buffer),
  ) %>%
  dplyr::mutate(subgroup_selected_type = !!sym(subgroup_select_type))%>%
  dplyr::mutate(subgroup_selected_quantity = !!sym(subgroup_select_quantity))%>%
  dplyr::mutate(subgroup_selected_buffer = !!sym(subgroup_select_buffer))

#The line is set to fill in the NAs, but not the real helpful code
ma_cor_data$subgroup_selected_buffer <- ifelse(is.na(ma_cor_data$subgroup_selected_buffer), "500", ma_cor_data$subgroup_selected_buffer)

unique(ma_cor_data$nature_type.1)
unique(ma_cor_data$nature_quantity.1)
unique(ma_cor_data$buffer)


ma_cor_continuous <-
  meta::metacor(
    data = ma_cor_data,
    cor = mean_adjusted, #Why divide by 100 remains a question cuz I forget why.=> Remember in the metacor function, the value of "cor" should be in (-1,1)
    n = N,
    studlab = study_label,
    fixed = FALSE,
    random = TRUE,
    method.tau = "REML",
    hakn = TRUE,
    title = "Mental Wellbeing_continuous")

# length(ma_cor)
# length(subgroup_select_quantity)


## update the MA by adding subgroup analysis - type
if (add_subgroup_analysis == T) {
  ma_cor_type <- update(ma_cor_continuous, subgroup = subgroup_selected_type)
  
  test.effect.subgroup.random_para = TRUE
  postfix_subgroup_type <- paste0("_subgroup_", subgroup_select_type)
  height_cm <- height_cm
    
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup_type <- ""
  }

f <- paste0('./figures/', 'forest_continuous_meta_type_',postfix_subgroup_type,  today, '.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm/1.2, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_type, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()



## update the MA by adding subgroup analysis - quantity, **the quantity in binary is not necessary, only for the continuous
if (add_subgroup_analysis == T) {
  ma_cor_quantity <- update(ma_cor_continuous, subgroup = subgroup_selected_quantity)
  
  test.effect.subgroup.random_para = TRUE
  postfix_subgroup_quantity <- paste0("_subgroup_", subgroup_select_quantity)
  height_cm <- height_cm
    
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup_quantity <- ""
  }


f <- paste0('./figures/', 'forest_cor_meta_quantity_',postfix_subgroup_quantity,  today, '.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm/1.2, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_quantity, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()


## update the MA by adding subgroup analysis - buffer
if (add_subgroup_analysis == T) {
  
  ma_cor_buffer <- update(ma_cor_continuous, subgroup = subgroup_selected_buffer)
  
  test.effect.subgroup.random_para = TRUE
  postfix_subgroup_buffer <- paste0("_subgroup_", subgroup_select_buffer)
  height_cm <- height_cm
    
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup_buffer <- ""
  }

f <- paste0('./figures/', 'forest_cor_meta_buffer_',postfix_subgroup_buffer,  today, '.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm/1.2, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_buffer, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()
```



#plot - group1 regression - meta - subgroup
```{r - forest - meta - subgroup}
width_forestPlot = 40
height_cm <- nrow(df_regression)/1.1

add_subgroup_analysis <- T

subgroup_select_type <- 'nature_type.1'
subgroup_select_quantity <- 'nature_quantity'
subgroup_select_buffer <- 'buffer'
# subgroup_select <- 'nature_type.1'
# subgroup_select <- 'nature_quantity.1'

ma_cor_data <- df_regression %>%
  dplyr::mutate(nature_type.1 = str_to_sentence(nature_type.1),
                buffer = str_to_sentence(buffer),
                
                nature_quantity.1 = case_when(
                  nature_quantity.1 %in% c("Streetscape greenery", 'SVG-quantity',
                                        "SVG-grass", "SVG-tree") ~ "SVG",
                  # nature_type_o1 == "Home/ courtyard garden" ~ "Greenspace",
                  # nature_type_o1 == "Community private green space" ~ "Greenspace",
                T ~ nature_quantity.1
                )) %>%
  #dplyr::filter(!is.na(nature_type.1)) %>%
  #dplyr::filter(!is.na(nature_quantity)) %>%
  #dplyr::filter(!is.na(buffer)) %>%
  dplyr::mutate(
    #subgroup_select_buffer = gsub("400","500",subgroup_select_buffer),
    subgroup_select_buffer = gsub("1080","1000",subgroup_select_buffer),
    #buffer = gsub("50","100",buffer),
  ) %>%
  dplyr::mutate(subgroup_selected_type = !!sym(subgroup_select_type))%>%
  dplyr::mutate(subgroup_selected_quantity = !!sym(subgroup_select_quantity))%>%
  dplyr::mutate(subgroup_selected_buffer = !!sym(subgroup_select_buffer))

#The line is set to fill in the NAs, but not the real helpful code
ma_cor_data$subgroup_selected_buffer <- ifelse(is.na(ma_cor_data$subgroup_selected_buffer), "500", ma_cor_data$subgroup_selected_buffer)

unique(ma_cor_data$nature_type.1)
unique(ma_cor_data$nature_quantity.1)
unique(ma_cor_data$buffer)


ma_cor_regression <-
  meta::metacor(
    data = ma_cor_data,
    cor = mean_adjusted, #Why divide by 100 remains a question cuz I forget why.=> Remember in the metacor function, the value of "cor" should be in (-1,1)
    n = N,
    studlab = study_label,
    fixed = FALSE,
    random = TRUE,
    method.tau = "REML",
    hakn = TRUE,
    title = "Mental Wellbeing_regression")

# length(ma_cor)
# length(subgroup_select_quantity)


## update the MA by adding subgroup analysis - type
if (add_subgroup_analysis == T) {
  ma_cor_type <- update(ma_cor_regression, subgroup = subgroup_selected_type)
  
  test.effect.subgroup.random_para = TRUE
  postfix_subgroup_type <- paste0("_subgroup_", subgroup_select_type)
  height_cm <- height_cm
    
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup_type <- ""
  }

f <- paste0('./figures/', 'forest_regression_meta_type_',postfix_subgroup_type,  today, '.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm/0.8, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_type, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()



## update the MA by adding subgroup analysis - quantity, **the quantity in binary is not necessary, only for the regression

if (add_subgroup_analysis == T) {
  ma_cor_quantity <- update(ma_cor_regression, subgroup = subgroup_selected_quantity)
  
  test.effect.subgroup.random_para = TRUE
  postfix_subgroup_quantity <- paste0("_subgroup_", subgroup_select_quantity)
  height_cm <- height_cm
    
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup_quantity <- ""
  }


f <- paste0('./figures/', 'forest_cor_meta_quantity_',postfix_subgroup_quantity,  today, '.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm/0.8, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_quantity, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()


## update the MA by adding subgroup analysis - buffer
if (add_subgroup_analysis == T) {
  
  ma_cor_buffer <- update(ma_cor_regression, subgroup = subgroup_selected_buffer)
  
  test.effect.subgroup.random_para = TRUE
  postfix_subgroup_buffer <- paste0("_subgroup_", subgroup_select_buffer)
  height_cm <- height_cm
    
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup_buffer <- ""
  }

f <- paste0('./figures/', 'forest_cor_meta_buffer_',postfix_subgroup_buffer,  today, '.png'); f
png(filename = f, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot/2, height = height_cm/0.8, units = "cm", res = 100)

p_forest <- meta::forest(
  ma_cor_buffer, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "black",
  col.inside = "black",
  col.square.lines = "black", 
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label, shade=TRUE,
  leftlabs = c("Study ID", "g", "SE"))
p_forest

dev.off()
```


# forest - group2 OR - meta - subgroup
```{r - forest - meta - subgroup}
width_forestPlot = 40
height_cm <- nrow(df_OR_clean)/1.1

```


## simple meta
```{r}
# import the database
df_new_simple <- read.xlsx( "P:/R/meta_mental wellbeing/result/exp_all_model_short2.xlsx", sheet = "simple")
## [] need to fix data that are out of range later ... 
# df_new_coef <- df_new %>%
#   dplyr::filter(!is.na(Mean)) %>%
#   dplyr::filter(mean <=1 & mean >=-0.6)
#   as.data.frame()

  
dat_simple <- escalc(data=df_new_simple, measure="ZCOR", ri=Mean, ni=N)
study_label <- paste(dat_simple$quantity)
#study_label <- paste(dat$id, dat$model_id, sep = '_')


res_simple <- metafor::rma(yi, vi, data=dat_simple, slab = study_label)
res_simple
predict(res_simple, transf=transf.ztor) ## ztor: z to r

# outlier/influence diagnostics
par(mar=c(5,6,4,2))
plot(influence(res), cex=0.8, las=1)

m.cor.simple <- meta::metacor(
  data = df_new_simple,
  cor = Mean, 
  n = N,
  studlab = study_label,
  fixed = FALSE,
  random = TRUE,
  method.tau = "REML",
  hakn = TRUE,
  title = "Mental Wellbeing_simple")
summary(m.cor.simple)


f_simple <- paste0(dir.report, 'forest_cor_simple_', today ,'.png'); f_simple
png(file=f_simple, 
    # width = 3.5, height = 4, units = 'in', 
    width = 1000, height = 1000, units = "px", pointsize = 22,
    # res = 200
    ) 
meta::forest(res_simple, 
             addpred=TRUE, header=TRUE, 
             digits=2, 
             print.I2 = T,
             layout = "RevMan5",
             xlim=xlim_custmize, slab = study_label, shade=TRUE)
dev.off() 



forest(res_simple, addpred=TRUE, header=TRUE, xlim=xlim_custmize, slab = study_label) # showweights=TRUE
forest(res_simple, addpred=TRUE, header=TRUE, xlim=xlim_custmize, atransf=exp)
#' optional argument to specify a function to transform the x-axis labels and annotations (e.g., atransf=exp)
forest(res_simple, addpred=TRUE, header=TRUE, xlim=xlim_custmize, atransf=exp, at=log(c(.6, .8, 1, 1.2, 1.4)))


width_forestPlot = 40
height_cm <- nrow(df_new_coef)/1.1

f_simple <- paste0(dir.report, 'forest_cor_simple_', today ,'.png'); f
png(filename = f_simple, 
    # width = 3000, height = 3000, units = "px", pointsize = 22,
    width = width_forestPlot, height = height_cm, units = "cm", res = 100)
  
  
p_forest_simple <- meta::forest(
  m.cor.simple, 
  # sortvar = TE,
  # prediction = TRUE, 
  # print.tau2 = T,
  addpred=TRUE, 
  header=TRUE, 
  digits=2, 
  print.I2 = T,
  pooled.totals=T,
  overall = T,
  overall.hetstat = T,
  
  col.by = "black",
  col.square = "red",
  col.inside = "black",
  col.square.lines = "black",
  shade=TRUE,
  layout = "RevMan5",
  slab = study_label, shade=TRUE,
  leftlabs = c("N","quantity", "g", "SE"))
p_forest

dev.off()
```


```{r}
# install.packages("corplot")
# library(PerformanceAnalytics)  
## How to import the drapery function?

drapery(m.cor, 
        labels = "id",
        type = "pval", 
        legend = FALSE)
```



### Funnel plot for publication bias

  Given our assumptions, and in the case when there is no publication bias, all studies would lie symmetrically around our pooled effect size (the vertical line in the middle), within the form of the funnel. 
  
  When *publication bias* is present, we would assume that the funnel would look asymmetrical, because only the small studies with a large effect size very published, while small studies without a significant, large effect would be missing.
  
  We can see in the plot that while some studies have statistically significant effect sizes (the gray areas), others do not (white background). 
  
  - https://cjvanlissa.github.io/Doing-Meta-Analysis-in-R/smallstudyeffects.html
  
  - https://wviechtb.github.io/metafor/reference/funnel.html
  
```{r}
### funnel plot --------------------------------------------------------------------------
# funnel(res)
# funnel(res, ylim=c(0,.08), las=1)
funnel(res_regression, ylim=c(0,.08), las=1, digits=list(2L,2), legend=TRUE)

## trim and fill method
funnel(trimfill(res_regression), # , side = 'left'
       las=1, ylim=c(0,.08), digits=list(2L,2), 
       # cex=1.2,
       legend=TRUE)

# res
# trimfill(res)

## contour-enhanced funnel plot
# funnel(dat$yi, dat$vi, yaxis="seinv", ## "seinv" for the inverse of the standard errors
#        # xlim=c(-.5, .5),
#        # ylim=c(10, 200), 
#        xaxs="i", yaxs="i", las=1, 
#        level=c(.10, .05, .01), 
#        shade=c("white", "gray55", "gray85"), ## pink -- not significant 
#        legend=TRUE, 
#        # back="grey90",
#        hlines=NULL, ylab="Precision (1/se)")

f <- paste0('./figures/', 'plot_funnel_cor_', today, '.png'); f
png(file=f, 
    width = 1000, height = 1000, units = "px", pointsize = 22) 
funnel(
  # trimfill(res, side = 'right'),
  res_regression,
  las=1, ylim=c(0,.08), digits=list(2L,2),
  level=c(.10, .05, .01),
  shade=c("white", "gray50", "gray65"), ## pink -- not significant
  legend=TRUE,
  back="grey90",
  hlines=NULL)
dev.off() 

```








