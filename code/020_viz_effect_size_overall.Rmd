---
title: "Untitled"
author: "Yingjie"
date: "`r Sys.Date()`"
output: html_document
---



```{r include=FALSE}
# install.packages("remotes")
# remotes::install_github("guido-s/meta", ref = "develop", build_vignettes = TRUE, force = TRUE)

library(meta)
packageVersion("meta")


##' an extra post fix for figure's version control
vv <- ""
# vv <- "v2"
```



### show overall effect

```{r - overall}
source('./code/func_plot_ma.R')

mh_tool_list <- c('GHQ-12', 'PANAS', 'POMS', 'PSS', 'ROS', 'SF') 

fs <- list.files(path = "./data/0302-MA-output/", 
                 pattern = paste('^ma_result.*_*', sep = ''), ## if opt to include all 
                 # pattern = paste('^ma_result.*_', mh_tool_list, sep = '', collapse = '|'), ## if opt to include selected ones
                 full.names = T);
cat('\n This', length(fs), 'files will be included:\n')
print(fs)

ma_result_all <- data.frame()
for (f in fs) {
  d <- readRDS(file = f) 
  ma_result_all <- rbind(ma_result_all, d)
}
# ma_result_panas <- readRDS("./data/0302-MA-output/ma_result.overall_PANAS_.rds") 
# ma_result_poms  <- readRDS("./data/0302-MA-output/ma_result.overall_POMS_.rds") 
# ma_result.subgroup_panas <- readRDS("./data/0302-MA-output/ma_result.subgroup_PANAS_.rds") 
# ma_result.subgroup_poms  <- readRDS("./data/0302-MA-output/ma_result.subgroup_POMS_.rds") 



# p1 <- ma_result_all %>%
#   dplyr::filter(subgroup == 'Overall', tool == 'PANAS') %>%
#   plot_effect_size_overall(data = ., subgroup = NULL)
# p2 <- ma_result_all %>%
#   dplyr::filter(subgroup == 'Overall', tool == 'POMS') %>%
#   plot_effect_size_overall(data = .)
# 
# 
# ggarrange(p1 + rremove("x.title"), 
#           p2, 
#           labels = c("A", "B"), ncol = 1, nrow = 2,
#           heights = c(0.4, 1),
#           align = "v")


## pool all data together 
ma_result_all %>%
  dplyr::filter(subgroup == 'Overall') %>%
  plot_effect_size_overall(data = ., 
                           color_var = 'tool', 
                           show_legend = T) +
  theme(legend.position = c(0.9, 0.8)) +
  guides(color = guide_legend(title="MH Tools"))



fname <- paste0(dir.fig, 'es_combined_tool', length(mh_tool_list), '_', today, vv, '.png'); fname
func_ggsave(fname, w = 6, h = 5.5, save_png = T)
```

### by group

```{r - table & numbers}
ma_result.subgroup_psubgroup <- ma_result_all %>%
  dplyr::filter(subgroup != 'Overall') %>%
  dplyr::distinct(tool, ind_sub, .keep_all = T)
```



```{r - plot}
source('./code/func_plot_ma.R')

##' color from https://developers.google.com/earth-engine/datasets/catalog/USGS_NLCD_RELEASES_2021_REL_NLCD#bands
nature_type_list <- c("Greenspace",               # '#68ab5f'	(Deciduous Forest)
                      "Greenspace - Forest/Tree", # '#1c5f2c'	
                      "Greenspace - Shrub/scrub", # '#ccb879'	
                      "Greenspace - Grassland",   # '#dfdfc2'
                      "Greenspace - Farmland",    # '#ab6c28'
                      "Greenspace - Park",        # 
                      "Greenspace - Garden",      # '#aaff00'
                      "Greenspace - Green alley/Roadside green", 
                      "Greenspace - Green roof/wall",# '#79ffd2'              (Shrub-Forest)
                      "Bluespace - Open water",      # '#466b9f'
                      "Bluespace - Wetland",         # '#b8d9eb'
                      "Bluespace - Sea",             # '#0000ff'
                      "Bluespace - Beach/coastline", # '#0000ff'
                      "Other"                        # '#000000'	
                      )
colors_nature_type <- c(
  '#68ab5f', # "Greenspace"
  '#1c5f2c', # "Greenspace - Forest/Tree"
  '#ccb879', # "Greenspace - Shrub/scrub"
  '#b2df8a', # "Greenspace - Grassland"
  '#ab6c28', # "Greenspace - Farmland"
  '#fb9a99', # "Greenspace - Park"
  '#aaff00', # "Greenspace - Garden" (forest disturbed before/at 2006)
  '#beaed4', # "Greenspace - Green alley/Roadside green"
  '#79ffd2', # "Greenspace - Green roof/wall"
  '#466b9f', # "Bluespace - Open water"
  '#b8d9eb', # "Bluespace - Wetland"
  '#0000ff', # "Bluespace - Sea"
  '#0000ff', # "Bluespace - Beach/coastline"
  '#000000'  # "Other"
  )

names(colors_nature_type) <- nature_type_list




p1_tool <- ma_result_all %>%
  data.table::as.data.table() %>%
  dplyr::filter(subgroup != 'Overall', tool == 'PANAS'); 

len <- length(unique(p1_tool$subgroup)); len
facet_decide <- ifelse(len >3, T, F)

## add named colors
element_list <- unique(p1_tool$subgroup); element_list
colors_nature_type_included1 <- colors_nature_type[element_list]; colors_nature_type_included1
# p1_tool$subgroup = factor(x = p1_tool$subgroup, levels = element_list_named)

p1 <- p1_tool %>%
  # dplyr::mutate(subgroup = factor(x = subgroup, levels = element_list_named)) %>%
  plot_effect_size_overall(data = .,
                           subgroup = 'subgroup', 
                           facet_bygroup = facet_decide, 
                           add_gradient_bg = F,
                           show_legend = F) +
  scale_colour_manual(values = colors_nature_type)



p2_tool <- ma_result_all %>%
  dplyr::filter(subgroup != 'Overall', tool == 'POMS') 

len <- length(unique(p2_tool$subgroup)); len
facet_decide <- ifelse(len >3, T, F)

## add named colors
element_list2 <- unique(p2_tool$subgroup); 
colors_nature_type_included2 <- colors_nature_type[element_list2]; colors_nature_type_included2

p2 <- p2_tool %>%
  # dplyr::mutate(subgroup = factor(x = subgroup, levels = element_list_named)) %>%
  plot_effect_size_overall(data = ., 
                           subgroup = 'subgroup', 
                           facet_bygroup = facet_decide, 
                           add_gradient_bg = F,
                           show_legend = T) + 
  theme(legend.position = c(0.8, 0.1)) +
  # It's recommended to use a named vector
  scale_colour_manual(values = colors_nature_type)
# p2



## create a legend that includes elements from both figures ------------------------------
set.seed(1) # for reproducibility
ls_element <- unique(c(element_list, element_list2))
ls <- unique(c(colors_nature_type_included1, colors_nature_type_included2))
n  <- length(ls); n

# generate 5 random points
tbl <- tibble(x = runif(n),
              y = runif(n),
              `Nature Type` = ls_element, 
              class = factor( LETTERS[1:n] ))

# print if x > 0.5
legend_plot <- ggplot(data = tbl,
            aes(x = x,
                y = y,
                color = `Nature Type`)) +
  geom_point(size = 2) +
  # scale_colour_discrete(drop = FALSE) +
  scale_colour_manual(values = colors_nature_type) +
  theme_bw() +
  theme(legend.spacing.y = unit(0, 'cm'),
        legend.spacing.x = unit(0, 'cm'),
        legend.key.size = unit(0.05, 'cm'),
        legend.title=element_text(size=7.5, face = 'bold'),
        legend.text=element_text(size=7),
            ) +
  guides(color = guide_legend(reverse=TRUE))
# legend_plot  
legend_made <- get_legend(legend_plot)



## 
p_comb <- 
  ggarrange(p1 + rremove("x.title"), 
            p2 + theme(legend.position = 'none'), 
            labels = c("A", "B"), ncol = 1, nrow = 2,
            heights = c(0.4, 1), 
            common.legend = F, 
            align = "v")
p_comb
fname <- paste0(dir.fig, 'es_combined_tool', length(mh_tool_list), postfix_subgroup, '_', today, vv, '.png'); fname
# func_ggsave(fname, w = 6, h = 5.5+1, save_png = T)


library(grid)
library(gridExtra)

fname <- gsub('.png', '_legend.png', fname); fname
png(filename = fname, width = 6, height = 5.5+1, units = 'in', res = 300)

grid.draw(p_comb)
sample_vp <- viewport(x = 1/3, y = 0, 
                      width = 1/3+0.2, height = 0.3,
                      just = c("left", "bottom")
                      )
pushViewport(sample_vp)
# grid.draw(roundrectGrob())
grid.draw(legend_made)
popViewport()

dev.off()


### the other way to combine plots -------------------------------------------------------
# fname <- gsub('.png', '2.png', fname); fname
# png(filename = fname, width = 6, height = 5.5+1, units = 'in', res = 300)
# library(grid)
# # Move to a new page
# grid.newpage()
# # Create layout : nrow = 3, ncol = 2
# pushViewport(viewport(layout = grid.layout(nrow = 4, ncol = 3)))
# # A helper function to define a region on the layout
# define_region <- function(row, col){
#   viewport(layout.pos.row = row, layout.pos.col = col)
# }
# # Arrange the plots
# print(p1 + rremove("x.title"), vp = define_region(row = 1, col = 1:2))   # Span over two columns
# print(p2, vp = define_region(row = 2:4, col = 1:3))
# print(legend_made, vp = define_region(row = 4, col = 2))
# dev.off()
```

**refs**
  - http://www.sthda.com/english/articles/24-ggpubr-publication-ready-plots/81-ggplot2-easy-way-to-mix-multiple-graphs-on-the-same-page/
  - https://rpkgs.datanovia.com/ggpubr/reference/rremove.html

  