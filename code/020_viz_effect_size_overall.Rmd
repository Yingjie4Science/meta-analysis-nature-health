---
title: "Untitled"
author: "Yingjie"
date: "`r Sys.Date()`"
output: html_document
---


Need to run the following scripts before running this one. 
  * `011_MA_correlation.Rmd`
  * `012_MA_MD.Rmd`


```{r include=FALSE}

### To clear your environment
# remove(list = ls())

# install.packages("remotes")
# remotes::install_github("guido-s/meta", ref = "develop", build_vignettes = TRUE, force = TRUE)

library(meta)
packageVersion("meta")
source('./code/_pkgs_dirs.R')


##' an extra post fix for figure's version control
vv <- ""
```



### show overall effect

```{r}
## select a few easy-to-understand indicator for IALE presentation 
ind_for_presentation <- c("Anxiety", "Depression", 
                  # "Stress", 
                  "Restorative Effect", "Vigor")

nature_type_remove_for_presentation <- 
  c("Greenspace",
    "Greenspace - Garden",
    "Greenspace - Green alley/Roadside green", 
    "Greenspace - Green roof/wall")
```


```{r - data}
source('./code/func_plot_ma.R')

mh_tool_list <- c('PANAS', 'POMS') 
mh_tool_list <- c('PANAS', 'POMS', 'PSS', 'ROS'); design <- 'exp'
mh_tool_list <- c('GHQ-12', 
                  'PANAS', 'POMS', 'PSS', 'ROS',
                  "SF-12", "SF-36", 'WEMWBS', 'WHO-5'); design <- 'obs'


fs <- list.files(path = "./data/0302-MA-output/", 
                 # pattern = paste('^ma_result.*_*', sep = ''), ## if opt to include all 
                 pattern = paste('^ma_result.*_', mh_tool_list, sep = '', collapse = '|'), ## if opt to include selected ones
                 full.names = T);
cat('\n This', length(fs), 'files will be included:\n')
print(fs)

ma_result_all <- data.frame()
for (f in fs) {
  print(f)
  d <- readRDS(file = f) 
  ma_result_all <- rbind(ma_result_all, d)
}
# ma_result_panas <- readRDS("./data/0302-MA-output/ma_result.overall_PANAS_.rds") 
# ma_result_poms  <- readRDS("./data/0302-MA-output/ma_result.overall_POMS_.rds") 
# ma_result.subgroup_panas <- readRDS("./data/0302-MA-output/ma_result.subgroup_PANAS_.rds") 
# ma_result.subgroup_poms  <- readRDS("./data/0302-MA-output/ma_result.subgroup_POMS_.rds") 


## Save as xlsx
writexl::write_xlsx(x = ma_result_all, path = './data/0302-MA-output/ma_result_all.xlsx')
```


```{r - overall}
# p1 <- ma_result_all %>%
#   dplyr::filter(subgroup == 'Overall', tool == 'PANAS') %>%
#   plot_effect_size_overall(data = ., subgroup = NULL)
# p2 <- ma_result_all %>%
#   dplyr::filter(subgroup == 'Overall', tool == 'POMS') %>%
#   plot_effect_size_overall(data = .)
# 
# 
# ggarrange(p1 + rremove("x.title"), 
#           p2, 
#           labels = c("A", "B"), ncol = 1, nrow = 2,
#           heights = c(0.4, 1),
#           align = "v")


## pool all data together 
data <- ma_result_all %>%
  # dplyr::filter(ind_sub %in% ind_for_presentation) %>%
  dplyr::filter(subgroup == 'Overall') 
x_limit_max <- max(abs(data$es.lower), abs(data$es.upper), na.rm = T) * 1.2
x_limit_max

data %>%
  plot_effect_size_overall(data = ., 
                           color_var = 'tool', 
                           text_size = 11,
                           show_legend = T) +
  scale_x_continuous(limits = c(-x_limit_max, x_limit_max)) +
  theme(legend.position.inside = c(0.85, 0.9),
        # legend.spacing.y = unit(0, 'cm'),
        legend.spacing.x = unit(0.2, 'cm'),
        legend.key.size = unit(0.2, 'cm'),
        plot.margin = margin(t=0, r=0, b=0, l=0, "pt")) +
  guides(color = guide_legend(title="MH Tools"))

n_ind <- length(unique(data$ind_sub)); 

fname <- paste0(dir.fig, 'es_comb_', design, '_', today, vv, '.png'); fname
func_ggsave(fname, w = 6, h = 5.5/2/5*n_ind, dpi = 300, save_png = T)
```



### by group

```{r - table & numbers}
ma_result.subgroup_only <- ma_result_all %>%
  dplyr::filter(subgroup != 'Overall') %>%
  dplyr::distinct(tool, ind_sub, subgroup, .keep_all = T)
```



```{r - plot}
source('./code/func_plot_ma.R')
source('./code/func_color_bygroup.R')

mh_tools <- c('PANAS', 'POMS'); 
# mh_tools <- c('PSS', 'ROS') ; 



##' Pick one for viz ---------------------------------------------------------------------

# subgroup_select <- 'subgroup_design' 
# subgroup_select <- 'exposure_o2'
# subgroup_select <- 'nature_type_o2';  color_bygroup = nature_type_color; group_list = nature_type_list
# subgroup_select <- 'age_group';       
# subgroup_select <- 'gender_group';    
# subgroup_select <- 'duration_group';  


subgroups <- c(
  'subgroup_design', 'exposure_o2',
  'nature_type_o2', 
  'Region',
  'age_group', 'gender_group', 'duration_group')


ind_sub_levels <- c("TMD", "Anxiety", "Fatigue", "Confusion", "Anger", 
                    "Depression",  ## for IALE
                    "Stress", "Negative Affect", 
                    "Positive Affect", 
                    "Restorative Effect", 
                    # "Depression", 
                    "Vigor")


for (subgroup_select in subgroups) {
  
  ## subset data
  ma_result_all_sub <- ma_result_all %>%
    dplyr::filter(subgroup != 'Overall', 
                  group_name == subgroup_select)
  
  ## postfix to be added to figure names
  postfix_group <- paste0("_subgroup_", subgroup_select); postfix_group
  
  ## decide color scheme 
  if(subgroup_select == 'nature_type_o2'){
    group_title = str_to_sentence(gsub('_|_o2', ' ', subgroup_select)) %>% trimws()
    color_bygroup = nature_type_color; 
    group_list = nature_type_list
  } else if(subgroup_select == 'age_group'){
    group_title = str_to_sentence(gsub('_', ' ', subgroup_select))
    color_bygroup = age_group_color; 
    group_list = age_group_list
  } else if(subgroup_select == 'gender_group'){
    group_title = str_to_sentence(gsub('_', ' ', subgroup_select))
    color_bygroup = gender_group_color; 
    group_list = gender_group_list
  } else if(subgroup_select == 'duration_group'){
    group_title = 'Duration in nature'
    color_bygroup = duration_group_color; 
    group_list = duration_group_list
  } else if(subgroup_select == 'Region'){
    group_title = subgroup_select
    color_bygroup = region_color; 
    group_list = region_list
  } else {
    # next
    group_title = str_to_sentence(gsub('_|_o2', ' ', subgroup_select)) %>% trimws()
    group_list = unique(ma_result_all_sub$subgroup)
    color_bygroup = func_color_bygroup(df = ma_result_all_sub, column_name = 'subgroup')
  }
  
  
  ##' run sourced code 
  ##' 
  ##' 1. plot by tool and combine plots
  # source('./code/020s1_subgroup_loop_source_code.R')
  
  ##' 2. pool all tools together and plot
  source('./code/020s2_subgroup_loop_source_code.R')
  
}


```


```{r - p_all, eval=FALSE, include=FALSE}

##' This chunk was used as an example or test code for the source code
##' 
source('./code/func_plot_ma.R')

subgroup_select <- 'nature_type_o2';  color_bygroup = nature_type_color; group_list = nature_type_list; group_title = 'Nature type'

unique(ma_result_all$ind_sub)

## run this sourced code 
source('./code/020s2_subgroup_loop_source_code.R')
```

**refs**
  - http://www.sthda.com/english/articles/24-ggpubr-publication-ready-plots/81-ggplot2-easy-way-to-mix-multiple-graphs-on-the-same-page/
  - https://rpkgs.datanovia.com/ggpubr/reference/rremove.html

  