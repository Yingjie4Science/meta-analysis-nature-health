---
title: "mini-review"
author: "Yingjie"
date: "2023-03-05"
output:
  pdf_document: default
  html_document: default
---


  *Run 000_load_extraction.Rmd first*


# Data cleaning 


## Indicator

```{r - indicator, include=FALSE}

## load data
f <- paste0('./data/0301-MA-input/df_covidenceFull_', today, '.rds'); f
df <- readRDS(file = f)


## keep columns of interest, and clean data
dt <- df %>%
  dplyr::select(1:4, matches("Country|Mental health|Indicator|Tools")) %>%
  dplyr::select(!matches("duration", ignore.case = T)) %>%
  func_clean_indicators(data = .) %>%
  dplyr::arrange(!is.na(Indicator), Reviewer) %>%
  as.data.frame()




# names(dt)


## stat
## - by indicator
dt.ind <- dt %>%
  dplyr::filter(str_detect(string = Indicator, pattern = "exclude", negate = T)) %>%
  group_by(Indicator, Tools, Country) %>%
  dplyr::count() %>%
  ungroup() %>%
  as.data.frame()


## - clean and format
dt.ind.cl <- dt.ind %>% 
  expand_col_to_long(data = ., target_col = "Indicator") %>%
  dplyr::mutate(
    Indicator = gsub("emotions|Emotions", "Emotion", Indicator),
    Indicator = gsub(";", "", Indicator),
    ) %>%
  dplyr::filter(!Indicator %in% c('', NA)) %>%
  dplyr::filter(!Tools %in% c('', NA)) %>%
  as.data.frame()

dt.ind.clean <- dt.ind.cl %>% 
  group_by(Indicator) %>%
  dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  as.data.frame()
```


```{r - indicator bar}
dt.ind.clean %>%
  dplyr::slice_max(order_by = n, n = 20) %>%
  ggplot(aes(
    x = reorder(Indicator, n),
    y = n,
    # fill = n
  )) +
  geom_col() +
  coord_flip() +
  # scale_fill_distiller(name = '', palette = "Blues", guide = "colorbar", direction = 1) +
  xlab("") +
  ggtitle("Frequency of Mental health indicators") +
  theme_bw() +
  theme(
    # axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
    plot.title = element_text(size = 10, hjust = 1.2, face = 'bold')
    )

f <- paste0("mini-review_indicators_", today, ".png")
fname <- paste0(dir.fig, f)
w = 3
h = 5
func_ggsave(fname = fname, w = w, h = h)


## save to a shared Drive
fname <- paste0(dir_share, f); fname
func_ggsave(fname = fname, w = w, h = h)
```






## Tool

```{r - tool, include=FALSE}
## - by scale

dt.tool <- dt %>%
  ### -clean up the names of the tools
  dplyr::select(1:5, Tools, -Title) %>%
  dplyr::filter(str_detect(string = Tools, pattern = "exclude", negate = T)) %>%
  dplyr::mutate(Tool = gsub("Other: ", "", Tools)) %>%
  func_clean_tools(data = ., column_name = 'Tool') %>%
  as.data.frame()

dt.tool.expand <- dt.tool %>% 
  dplyr::filter(nchar(Tool) < 180) %>%
  expand_col_to_long(data = ., target_col = "Tool") %>%
  dplyr::mutate(
    Tool = gsub(".*Likert.*|.*likert.*", "Likert scale", Tool),
    # Tool = gsub(";", "", Tool),
    ) %>% 
  func_clean_tools(data = ., column_name = 'Tool') 

dt.tool.clean <- dt.tool.expand %>%
  group_by(Tool) %>%
  # dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  tally() %>%
  ungroup() %>%
  arrange(Tool) %>%
  as.data.frame()
```



```{r - tools selected for MA, include=FALSE}
## select the most used measures in literature for meta-analysis

### - 1. top 3
tools_selected <- c('POMS', 'GHQ-12', 'PANAS')

### - 2. adding more for data extraction 
tools_selected <- c('ROS',   # Restoration Outcome Scale
                    'PSS',   # Perceived Stress Scale
                    'PRS',   # Perceived Restorativeness Scale
                    'SF-12', # Short From Health Survey 36-item
                    'SF-36')

dt.tool.expand.selected <- dt.tool.expand %>% 
  dplyr::filter(Tool %in% tools_selected) %>%
  dplyr::select(-Tools) %>%
  arrange(Tool, id) %>%
  dplyr::mutate(id = paste0('#', id)) %>%
  as.data.frame()

f <- paste0('./data/0301-MA-input/', 'paperID_byTopTools2_', today, '.CSV'); f
readr::write_csv(x = dt.tool.expand.selected, file = f)
```



```{r - tool bar}

dt.tool.clean %>%
  dplyr::slice_max(order_by = n, n = 20) %>%
  plot_freq(data = ., var = 'Tool') +
  geom_text(
    aes(label = n), vjust = 0.5, hjust = 1.1, color = 'white', size = 3) +
  ggtitle("Frequency of Mental health\nmeasurement tools") +
  theme_bw() +
  theme(
    plot.title = element_text(size = 10, hjust = .5, face = 'bold'),
    plot.title.position = "plot", #NEW parameter. Apply for subtitle too.
    )

f <- paste0('mini-review_tools_bar_', today, '.png'); f
fname <- paste0(dir.fig, f)
func_ggsave(fname = fname, w = w, h = h)

###' save to a shared Drive
fname <- paste0(dir_share, f); fname
func_ggsave(fname = fname, w = w, h = h)
```


## Matching

```{r - indicator-tool matching}
set.seed(123)

## - need to better match indicator and scales for N vs N cases
dt.ind_match_scale <- dt %>%
  dplyr::select(-`Study ID`, -Title, -Country) %>%
  dplyr::mutate(
    n_ind  = 1+str_count(Indicator, ",|;"),
    n_tool = 1+str_count(Tools, ",|;")) %>%
  dplyr::filter(n_ind >1 & n_tool >1) %>%
  # dplyr::filter(Reviewer == 'Yingjie Li') %>%
  arrange(Indicator) %>%
  dplyr::slice(., sample(1:n()))
  


## YYM and YJL will each take a proportion, and manually fix the indicator-tool matching issue.  
dt.ind_match_scale1 <- dt.ind_match_scale %>%
  dplyr::slice_head(., prop = .51) %>%
  arrange(Indicator)


dt.ind_match_scale2 <- dt.ind_match_scale %>%
  dplyr::slice_tail(., prop = .51)%>%
  arrange(Indicator)


intersect(dt.ind_match_scale1$id, dt.ind_match_scale2$id)
intersect(dt.ind_match_scale2$id, dt.ind_match_scale1$id)

# readr::write_csv(x = dt.ind_match_scale1, file = paste0('./data/fix_indicator-tool_matching/', 'dt.ind_match_scale1.csv'))
# readr::write_csv(x = dt.ind_match_scale2, file = paste0('./data/fix_indicator-tool_matching/', 'dt.ind_match_scale2.csv'))

rm(dt.ind_match_scale1, dt.ind_match_scale2)

```


```{r - manual match, include=FALSE}
library(googlesheets4)
link <- 'https://docs.google.com/spreadsheets/d/1Tu7m6A7LOplbuXaLTYV0X3JUs0AhX90T0v-TcFTW3Yg/edit?usp=sharing'

### Footprint indicators
mat <- googlesheets4::read_sheet(link, sheet = 'MH_indicators_tools', skip = 1) 

matching <- mat %>%
  dplyr::select(MH_indicator, MH_tool_abbr) %>%
  # dplyr::distinct(ind, .keep_all = T) %>%
  dplyr::filter(
    !MH_indicator %in% c('x', '?', NA), 
    !MH_tool_abbr %in% c('x', '?', NA)
  ) %>%  
  dplyr::mutate(
    MH_indicator = gsub("\\s*\\([^\\)]+\\)", "", MH_indicator), # remove text within parenthesis 
    MH_tool_abbr = gsub("\\s*\\([^\\)]+\\)", "", MH_tool_abbr), # remove text within parenthesis 
    MH_indicator = Hmisc::capitalize(str_squish(trimws(MH_indicator))),
    MH_tool_abbr = Hmisc::capitalize(str_squish(trimws(MH_tool_abbr))),
  ) %>%  
  arrange(MH_indicator, MH_tool_abbr) %>%
  as.data.frame()
```




```{r - columns to be cleaned}
to.clean.ind <- dt.ind_match_scale %>% 
  expand_col_to_long(data = ., target_col = "Indicator") %>%
  dplyr::mutate(
    Indicator = gsub("emotions|Emotions", "Emotion", Indicator),
    Indicator = gsub(";", "", Indicator),
    ) %>% 
  group_by(Indicator) %>%
  tally() %>%
  dplyr::filter(!Indicator %in% c('', NA)) %>%
  as.data.frame()

to.clean.tool <- dt.ind_match_scale %>%
  dplyr::select(1:2, Tools) %>%
  dplyr::mutate(Tool = gsub("Other: ", "", Tools)) %>%
  func_clean_tools(data = ., column_name = 'Tool') %>%
  expand_col_to_long(data = ., target_col = "Tool") %>%
  dplyr::mutate(
    Tool = gsub(".*Likert.*|.*likert.*", "Likert scale", Tool),
    Tool = str_squish(trimws(Tool))
    ) %>% 
  dplyr::distinct(Tool, .keep_all = T) %>%
  dplyr::filter(str_starts(negate = T, pattern = "'|’", string = Tool)) %>%
  ungroup() %>%
  arrange(Tool) %>%
  as.data.frame()
```




```{r - varify matching, include=FALSE}
## make sure the indicator and tool names are cleaned and unified ------------------------
matching.1 <- matching %>%
  merge(x = ., y = to.clean.ind,  by.x = 'MH_indicator', by.y = 'Indicator', all = T) %>%
  arrange(!is.na(MH_tool_abbr)) %>%
  dplyr::select(-n) %>%
  merge(x = ., y = to.clean.tool, by.x = 'MH_tool_abbr', by.y = 'Tool', all = T) %>%
  arrange(!is.na(MH_indicator))
  


matching.final <- matching.1 %>%
  dplyr::filter(!is.na(MH_indicator) & !is.na(MH_tool_abbr)) %>%
  dplyr::select(1:2) %>%
  dplyr::mutate(pair = paste0(MH_indicator, '-', MH_tool_abbr))

f <- paste0('./data/MH_indicator_tool_matching_database.rds')
### Save a single object to a file
# saveRDS(object = matching, file = f)

### Restore it under a different name
# matching <- readRDS(file = f)
```



## Check data 

```{r - ❌ errors, include=FALSE}
dt_err <- dt %>%
  # dplyr::filter(str_detect(Indicator, fixed('Antidepressants', ignore_case = T))) %>% ##  
  # dplyr::filter(str_detect(Indicator, fixed('Hyperactivity', ignore_case = T))) %>% ##  
  # dplyr::filter(str_detect(Tools, fixed('4DSQ', ignore_case = T))) %>%
  # dplyr::filter(str_detect(Tools, fixed('PRS', ignore_case = T))) %>% # 
  # dplyr::filter(str_detect(Tools, fixed('Both SF', ignore_case = T))) %>% #
  dplyr::filter(str_detect(Tools, fixed('PNAS', ignore_case = T))) %>% # 
  # dplyr::filter(str_detect(Country, fixed('Virginia', ignore_case = T))) %>% # 
  as.data.frame()

# dt_err_ <- dt %>%
#   # dplyr::filter(id == '320') %>%
#   dplyr::filter(id == '134') %>%
#   dplyr::distinct(id, .keep_all = T) %>%
#   as.data.frame()
```



```{r - ✅ to-do list}
```
  [x] current indicator-scale matching approach needs to be improved, `dt.ind.tool`
  [] clean data in `matching.1`
  [] address consensus and keep unique paper id in the data `df`
  []
  []



## Region 

```{r - region - bar}

reg_ <- dt %>%
  dplyr::select(1, Country) %>%
  dplyr::filter(!is.na(Country)) %>%
  dplyr::filter(!Country %in% c('m', 'NA', 'Global', 'Europe', 'all over the world')) %>%
  group_by(Country) %>%
  tally() %>%
  as.data.frame()

region <- reg_ %>%
  expand_col_to_long(data = ., target_col = "Country") %>%
  dplyr::mutate(Country = ifelse(
      nchar(Country) > 3,
      str_to_title(Country),
      Country
    )) %>%
  func_clean_country(data = ., column_name = "Country") %>%
  group_by(Country) %>%
  dplyr::summarise_at('n', sum, na.rm = TRUE) %>%
  as.data.frame()


library(SDGdetector)
packageVersion('SDGdetector')

library(dplyr)
library(stringr)
library(ggplot2)
library(cowplot)


codelist.supp <- data.frame(
  country.name.en = c('USA'),
  iso3c = c('USA'),
  region = c('North America')
)
codelist <- SDGdetector::codelist_panel %>%
  dplyr::distinct(country.name.en, iso3c, region) %>%
  rbind(., codelist.supp) %>%
  dplyr::mutate(
    country.name.en = case_when(
      str_detect(string = iso3c, pattern = 'HKG') ~ 'Hong Kong',
      T ~ country.name.en)
  ) %>%
  dplyr::distinct(country.name.en, iso3c, region
)
  
shp <- SDGdetector::shp


func_add_region <- function(data) {
  d <- data %>%
    merge(x = ., 
          y = codelist, 
          by.x = 'Country', 
          by.y = 'country.name.en', all.x = T) %>%
    ## add more detailed region name info
    merge(x = ., 
          y = countryRegions %>%
            dplyr::select(ISO3, REGION, continent), 
          by.x = 'iso3c', 
          by.y = 'ISO3', all.x = T) %>%
    ## remove `region`, and rename `REGION` to `Region`
    dplyr::select(-region) %>%
    dplyr::rename('Region' = 'REGION') %>%
    arrange(!is.na(iso3c))
  
  return(d)
}

region_match <- region %>%
  func_add_region(.)
 

region_count <- region_match %>%
  group_by(
           # Country, 
           Region,
           iso3c
           ) %>%
  dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  arrange(n, Region, iso3c) %>%
  as.data.frame()


region_count %>% 
  dplyr::mutate(facet = ifelse(n>=5, 0, 1)) %>%
  # dplyr::slice_max(order_by = n, n = 20) %>%
  ggplot(aes(x = reorder(iso3c, n), 
             y = n,
             fill = Region
             )) +
  geom_col() +
  geom_text(aes(label = n), vjust = 0.5, hjust = 0, size = 3, color = 'gray20') +
  xlab('')+
  coord_flip() +
  facet_wrap(~facet, scales = 'free') +
  theme_bw() +
  theme(legend.position = c(.35, .27),
        strip.background = element_blank(), 
        strip.text = element_blank()
  )

f <- paste0('mini-review_paper_count_bar_', today, '.png'); f
fname <- paste0(dir.fig, f); fname
func_ggsave(fname = fname, w = 7, h = 4, save_png = T)
```


```{r - region - map}

region_count_sf <- region_count %>%
  merge(x= shp, y = ., by.x = 'iso_a3', by.y  = 'iso3c', all.x = T) 


region_count_sf %>%
  dplyr::filter(name != 'Antarctica') %>%
  ggplot(.) +
  geom_sf(aes(fill = n), size = 0.1, color = 'gray80') +
  # geom_sf_text(aes(label = iso_a3), colour = "gray", size =1) + 
  scale_fill_distiller(name= 'Count', palette = 'YlGnBu', direction = 1, na.value = "gray90") +
  # theme_bw() +
  theme_nothing() +
  theme(legend.position = c(0.06, 0.4))

f <- paste0('mini-review_paper_count_map_', today, '.png'); f
w_map = 6.4*2
h_map = 3.2*2

fname <- paste0(dir.fig, f); fname
func_ggsave(fname = fname, w = w_map, h = h_map)

fname <- paste0(dir_share, f); fname
func_ggsave(fname = fname, w = w_map, h = h_map)

```



```{r - ind + ctr}
dt.ind.cl_ctr  <- dt.ind.cl  %>%
  ## - clean `country` -------------------------------------------------------------------
  func_clean_country(., column_name = "Country") %>%
  expand_col_to_long(data = ., target_col = "Country") %>%
  func_add_region(.) %>%
  group_by(Indicator, Region) %>%
  tally() %>%
  as.data.frame()


dt.ind.cl_ctr_flow  <- dt.ind.cl_ctr  %>%  
  tidyr::pivot_longer(names_to  = 'dimension', 
               values_to = 'layers', 
               cols = c('Indicator', 'Region')) %>%
  group_by(dimension) %>%
  dplyr::mutate(id_within_layers = row_number(dimension)) %>%
  arrange(dimension) %>%
  dplyr::rename(freq = n) %>%
  dplyr::mutate(
    dimension = factor(dimension, levels = c('Indicator', 'Region')),
    ) %>%
  group_by(layers) %>%
  dplyr::mutate(total = sum(freq, na.rm = T)) %>%
  as.data.frame()



library(ggalluvial)
width_my <- 1/2.5
sorted <- T  ## sorted by flow size
sorted <- NA ## default setting, sorted alphabetically 

indicator_n_min <- 5 ## only map indicators with more than 5 times
# Labeling small strata
labele_small <- 15


func_alluvial(data = dt.ind.cl_ctr_flow, indicator_n_min = 5, filename.postfix = 'indicator_region')
```



```{r - tool + ctr}
dt.tool_ctr  <- dt.ind  %>%
  dplyr::select(-Indicator) %>%
  ## - clean `tools` ---------------------------------------------------------------------
  dplyr::mutate(Tool = gsub("Other: ", "", Tools)) %>%
  func_clean_tools(data = ., column_name = 'Tool') %>%
  dplyr::filter(nchar(Tool) < 180) %>%
  dplyr::select(-Tools) %>%
  expand_col_to_long(data = ., target_col = "Tool") %>%
  dplyr::mutate(
    Tool = gsub(".*Likert.*|.*likert.*", "Likert scale", Tool),
    Tool = gsub("\\s*\\([^\\)]+\\)", "", Tool), # remove text within parenthesis 
    Tool = trimws(Tool)
    ) %>% 
  func_clean_tools(data = ., column_name = 'Tool') %>%
  # as.data.frame() 
  ## clean `country` ---------------------------------------------------------------------
  func_clean_country(., column_name = "Country") %>%
  expand_col_to_long(data = ., target_col = "Country") %>%
  func_add_region(.) %>%
  group_by(Tool, Region) %>%
  tally() %>%
  as.data.frame()


dt.tool_ctr_flow  <- dt.tool_ctr  %>%  
  pivot_longer(names_to  = 'dimension', 
               values_to = 'layers', 
               cols = c('Tool', 'Region')) %>%
  group_by(dimension) %>%
  dplyr::mutate(id_within_layers = row_number(dimension)) %>%
  arrange(dimension) %>%
  dplyr::rename(freq = n) %>%
  dplyr::mutate(
    dimension = factor(dimension, levels = c('Tool', 'Region')),
    ) %>%
  group_by(layers) %>%
  dplyr::mutate(total = sum(freq, na.rm = T)) %>%
  as.data.frame()

func_alluvial(data = dt.tool_ctr_flow, indicator_n_min = 5, labele_small = 1, filename.postfix = 'tool_region')
```


```{r - ind + tool + region}
library(tidyverse)


## 1. selected countries for plot
country_selected <- region_count %>%
  slice_max(n = 3, order_by = n)
country_selected <- country_selected$iso3c
n_ctr <- length(country_selected)

## 2. all countries for plot
country_selected <- c()
n_ctr <- length(country_selected)


## - clean `tools` ---------------------------------------------------------------------
dt.ind.cl.1 <- dt.ind.cl %>%
  dplyr::mutate(
    n_tool = 1+str_count(Tools, ",|;")) %>%
  dplyr::filter(n_tool <= 1) %>%
  as.data.frame()

dt.ind.cl.2 <- dt.ind.cl %>%
  dplyr::mutate(
    n_tool = 1+str_count(Tools, ",|;")) %>%
  dplyr::filter(n_tool >1) %>%
  as.data.frame()


dt.ind.tool.1  <- dt.ind.cl.1  %>%
  dplyr::mutate(Tool = gsub("Other: ", "", Tools)) %>%
  func_clean_tools(data = ., column_name = 'Tool') %>%
  dplyr::filter(nchar(Tool) < 180) %>%
  dplyr::select(-Tools) %>%
  dplyr::mutate(
    Tool = gsub(".*Likert.*|.*likert.*", "Likert scale", Tool),
    Tool = gsub("\\s*\\([^\\)]+\\)", "", Tool), # remove text within parenthesis 
    Tool = trimws(Tool)
    ) %>% 
  group_by(Indicator, Tool, Country) %>%
  dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  as.data.frame()


dt.ind.tool.2  <- dt.ind.cl.2  %>%
  dplyr::mutate(Tool = gsub("Other: ", "", Tools)) %>%
  func_clean_tools(data = ., column_name = 'Tool') %>%
  dplyr::filter(nchar(Tool) < 180) %>%
  dplyr::select(-Tools) %>%
  expand_col_to_long(data = ., target_col = "Tool") %>%
  dplyr::mutate(
    Tool = gsub(".*Likert.*|.*likert.*", "Likert scale", Tool),
    Tool = gsub("\\s*\\([^\\)]+\\)", "", Tool), # remove text within parenthesis 
    Tool = trimws(Tool)
    ) %>% 
  group_by(Indicator, Tool, Country) %>%
  dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  ## matching 
  dplyr::mutate(matching = paste0(Indicator, '-', Tool)) %>%
  dplyr::filter(matching %in% unique(matching.final$pair)) %>%
  dplyr::select(-matching) %>%
  as.data.frame()
  
dt.ind.tool <- rbind(dt.ind.tool.1, dt.ind.tool.2)
  

## - clean `country` -------------------------------------------------------------------
dt.ind.tool.ctr  <- dt.ind.tool  %>%  
  func_clean_country(., column_name = "Country") %>%
  expand_col_to_long(data = ., target_col = "Country") %>%
  func_add_region(.) %>%
  group_by(Indicator, Tool, Country, Region) %>%
  dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  as.data.frame()

if (n_ctr > 0) {
  dt.ind.tool.ctr2 <- dt.ind.tool.ctr %>%
    dplyr::filter(iso3c %in% country_selected)
} else {
  n_ctr <- ''
  dt.ind.tool.ctr2 <- dt.ind.tool.ctr
}
  

dt.ind.tool.region <- dt.ind.tool.ctr2 %>%
  group_by(Indicator, Tool, Region) %>%
  dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  # arrange(type_top) %>%
  dplyr::mutate(id = row_number()) %>%
  as.data.frame()


## - prep input for `ggalluvial` ---------------------------------------------------------
dtt  <- dt.ind.tool.region  %>%  
  pivot_longer(names_to = 'dimension', 
               values_to = 'layers', 
               cols = c('Indicator', 'Tool', 'Region')) %>%
  group_by(dimension) %>%
  dplyr::mutate(id_within_layers = row_number(dimension)) %>%
  arrange(dimension) %>%
  dplyr::rename(freq = n) %>%
  dplyr::mutate(
    dimension = factor(dimension, levels = c('Indicator', 'Tool', 'Region')),
    # layers = factor(layers, levels = org_levels)
    ) %>%
  group_by(layers) %>%
  dplyr::mutate(total = sum(freq, na.rm = T)) %>%
  as.data.frame()


func_alluvial(data = dtt, indicator_n_min = 3, labele_small = 20, w_p = 10, filename.postfix = 'indicator_tool_region2')

# f <- paste0('mini-review_mh_indicator_tool_pairs_min', indicator_n_min, '_ctr', n_ctr, '_', today, '.png')
# fname <- paste0(dir.fig, f); fname
# ggsave(filename = fname, plot = last_plot(), width = 10, height = 10, units = 'in', dpi = 300)
# 
# fname <- paste0(dir_share, f); fname
# ggsave(filename = fname, plot = last_plot(), width = 10, height = 10, units = 'in', dpi = 300)

```





