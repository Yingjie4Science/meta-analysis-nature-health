---
title: "mini-review"
author: "Yingjie"
date: "2023-03-05"
output:
  pdf_document: default
  html_document: default
---


# Setup
```{r, include=FALSE}
# To clear your environment
remove(list = ls())

Sys.setenv(LANG = "en")

## Load directories
# knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
# getwd()
# setwd(dirname(getwd()))

## Load common packages
getwd()
source("./code/_pkgs_dirs.R")
dir.raw   <- "./data/0005-covidence_export/data extraction/"
dir_share <- 'G:/Shared drives/Urban nature-health/projects/meta-analysis/figures/'


## Additional packages
library(rprojroot)
library(tidyverse)
library(splitstackshape) ## `cSplit()`
library(Hmisc)
library(rworldmap)
today <- format(Sys.time(), "%Y%m%d"); today ## "%Y%m%d%H%M"


save_plot <- F
save_plot <- T
```


```{r - helper data}
data(countryRegions,envir=environment(),package="rworldmap")
# str(countryRegions)

# ISO3:       ISO 3 letter country code
# ADMIN:      country name
# REGION:     7 region continent classification
# continent:  6 continents classification
```


```{r - functions}
source('./code/func_expand_col_to_long.R')
source('./code/func_clean_indicators.R')
source('./code/func_plot_freq.R')
source('./code/func_ggsave.R')

```



# Data import

## Data list
```{r include=FALSE}
fs <- list.files(path = dir.raw, full.names = T, pattern = '.csv$'); fs
# csv <- fs[1]
# names(df)
```


## Data for analysis 📁 
```{r include=FALSE}
## Choose the most updated one for formal analysis ---------------------------------------
# csv <- "review_278532_20230305161741-test mini-review-analysis.csv"
# csv <- "review_278532_20230328115335.csv"   # 2023-03-28
csv <- "review_278532_20230427120514.csv"     # 2023-04-27 
csv <- "review_278532_20230616074045.csv"     # 2023-05-13, addressed 85 consensus 
csv <- "review_278532_20230703085230.csv"
csv <- "review_278532_20230919160759.csv"     # 2023-9-18, 30 consensus done for Extraction

t <- basename(csv) %>% gsub('review_278532_', '', .) %>%
  str_sub(start = 1, end = 14)  %>%
  as.POSIXct(.,format="%Y%m%d%H%M%S") 
t

dd <- readr::read_csv(file = paste0(dir.raw, csv), show_col_types = F) %>%
  dplyr::mutate(date = t) %>%
  dplyr::rename(
    'id' = 'Covidence #',
    "Country" = "Country in which the study conducted",
    "Reviewer" = "Reviewer Name",
    'Indicator' = 'Mental health indicators',
    "Tools" = "Mental health measurement tools",
    "meet_criteria" = "Does this study meet the criteria for data extraction?"
  ) %>%
  dplyr::filter(!meet_criteria %in% c('No')) %>%
  dplyr::mutate(Tools = gsub("Other: |Other:", "", Tools)) %>%
  dplyr::mutate(Country = gsub("Other: |Other:", "", Country)) %>%
  arrange(id, Reviewer) %>%
  as.data.frame()

# names(dd)
unique(dd$Reviewer)

df <- dd %>%
  dplyr::mutate(Reviewer_id = case_when(
    Reviewer == 'Yingjie Li'    ~ 1, 
    Reviewer == 'Yuanyuan Mao'  ~ 2, 
    Reviewer == 'Zander Galli'  ~ 3, 
    Reviewer == 'Xin Lan'       ~ 4, 
    Reviewer == 'Emily Brieant' ~ 5, 
    Reviewer == 'Katherine Wu'  ~ 6,
    Reviewer == 'Mary Lee'      ~ 7,
    Reviewer == 'Consensus'     ~ 99
  )) %>%
  dplyr::select(id:Reviewer, Reviewer_id, everything()) %>%
  arrange(id, Reviewer_id, desc(date)) %>%
  dplyr::distinct(id, .keep_all = T) %>%
  as.data.frame()

## save data for other analysis
f <- paste0('./data/0301-MA-input/df_covidenceFull_', today, '.rds'); f
saveRDS(df, file = f)
```


## Check consensus status
```{r}

df_check <- dd %>%
  arrange(id, Reviewer, desc(date)) %>%
  dplyr::distinct(id, Reviewer, .keep_all = T) %>%
  dplyr::select(1:5) %>%
  group_by(id) %>%
  add_count() %>%
  # dplyr::filter(n == 3) %>%  ## passed `consensus`
  dplyr::filter(n == 2) %>%    ## need `consensus`
  as.data.frame()

unique(df_check$id)


dd1 <- df_check %>%
  dplyr::distinct(id, Reviewer) %>%
  arrange(id, Reviewer) %>% 
  group_by(Reviewer) %>%
  summarise(id = str_c(id, collapse = ", ") )

##' a list of papers that have NOT been sent for concensus
dd2 <- aggregate(id ~ Reviewer, unique(df_check), paste, collapse = ", ")
```



# Data cleaning 


## Indicator

```{r - indicator, include=FALSE}

## load data
f <- paste0('./data/0301-MA-input/df_covidenceFull_', today, '.rds'); f
df <- readRDS(file = f)


## keep columns of interest, and clean data
dt <- df %>%
  dplyr::select(1:4, matches("Country|Mental health|Indicator|Tools")) %>%
  dplyr::select(!matches("duration", ignore.case = T)) %>%
  func_clean_indicators(data = .) %>%
  dplyr::arrange(!is.na(Indicator), Reviewer) %>%
  as.data.frame()




# names(dt)


## stat
## - by indicator
dt.ind <- dt %>%
  dplyr::filter(str_detect(string = Indicator, pattern = "exclude", negate = T)) %>%
  group_by(Indicator, Tools, Country) %>%
  dplyr::count() %>%
  ungroup() %>%
  as.data.frame()


## - clean and format
dt.ind.cl <- dt.ind %>% 
  expand_col_to_long(data = ., target_col = "Indicator") %>%
  dplyr::mutate(
    Indicator = gsub("emotions|Emotions", "Emotion", Indicator),
    Indicator = gsub(";", "", Indicator),
    ) %>%
  dplyr::filter(!Indicator %in% c('', NA)) %>%
  dplyr::filter(!Tools %in% c('', NA)) %>%
  as.data.frame()

dt.ind.clean <- dt.ind.cl %>% 
  group_by(Indicator) %>%
  dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  as.data.frame()
```


```{r - indicator bar}
dt.ind.clean %>%
  dplyr::slice_max(order_by = n, n = 20) %>%
  ggplot(aes(
    x = reorder(Indicator, n),
    y = n,
    # fill = n
  )) +
  geom_col() +
  coord_flip() +
  # scale_fill_distiller(name = '', palette = "Blues", guide = "colorbar", direction = 1) +
  xlab("") +
  ggtitle("Frequency of Mental health indicators") +
  theme_bw() +
  theme(
    # axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
    plot.title = element_text(size = 10, hjust = 1.2, face = 'bold')
    )

f <- paste0("mini-review_indicators_", today, ".png")
fname <- paste0(dir.fig, f)
w = 3
h = 5
func_ggsave(fname = fname, w = w, h = h)


## save to a shared Drive
fname <- paste0(dir_share, f); fname
func_ggsave(fname = fname, w = w, h = h)
```






## Tool

```{r - tool, include=FALSE}
## - by scale

func_clean_tools <- function(data) {
  d <- data %>%
    dplyr::mutate(
      Tool = gsub("Other: ", "", Tool),
      Tool = gsub("scales|Scales", "scale", Tool, ignore.case = T),
      Tool = gsub("\\s*\\([^\\)]+\\)", "", Tool), # remove text within parenthesis 
      Tool = gsub(
        paste("Anti\\-depressant prescribing", "Antidepressant prescriptions", 
              "Antidepressant prescription rates", "Antidepressant use", sep = "|"),
        "Antidepressant prescription", Tool, ignore.case = T),
      Tool = gsub("CES\\-D\\-10|CESD\\-10", "CES\\-D10", Tool, ignore.case = T),
      Tool = gsub(
        paste("Diagnosed", "Diagnoses", "Diagnosis by professionals", 
              "Diagnosis of mental health disorders", sep = "|"), 
        "Diagnosis", Tool, ignore.case = T),
      Tool = gsub("Digit Span Backward", "DSB", Tool, ignore.case = F), ## 
      Tool = case_when(Tool %in% c('Digit', 'digit', 'Digit-span Task') ~ "Digit Span",
                       Tool == 'Digit test' ~ "Digit Span",
                       T ~ Tool),
      Tool = gsub("Electroencephalography", "EEG", Tool, ignore.case = F), ## # 
      Tool = gsub("EQ-5D", "EQ5D", Tool, ignore.case = F), ## # 
      Tool = gsub("K\\-10", "K10", Tool, ignore.case = F),
      Tool = gsub("Life Satisfaction approach", 'Life satisfaction approach', Tool, ignore.case = T),
      Tool = gsub(
        paste("Official/National mental health", "National survey", "Office for National Statistics", 
              "UK's Office of National Statistics",
              sep = "|"),
        'Official MH survey', Tool, ignore.case = T),#
      Tool = gsub("survey survey", 'survey', Tool, ignore.case = T),# 
      Tool = gsub("PNAS", 'PANAS', Tool, ignore.case = T),# 
      Tool = gsub("Profile of mood state questionnaire", 'POMS', Tool, ignore.case = T),# 
      Tool = gsub("Psychiatric disorders", 'Mental disorder', Tool, ignore.case = T),# 
      Tool = gsub("Psychiatric disorder", 'Mental disorder', Tool, ignore.case = T),
      Tool = gsub("PHQ-2|PHQ-4|PHQ-8|PHQ-9", 'PHQ', Tool, ignore.case = T),
      Tool = gsub("RAND-36", 'RAND36', Tool, ignore.case = T), # # 
      Tool = gsub("Restoration Outcome Scale", 'ROS', Tool, ignore.case = T), # 
      Tool = gsub("RSE or RSES|RSES", 'RSE', Tool, ignore.case = F), # 
      Tool = gsub("SCL90", 'SCL-90', Tool, ignore.case = F), # 
      Tool = gsub("SWEMWBS|WEMWBS 7-item", 'WEMWBS', Tool, ignore.case = F), # # 
      Tool = gsub(",+", ",", Tool), ## Removing repeated punctuation character from a string
      Tool = gsub(";+", ";", Tool), ## Removing repeated punctuation character from a string
      Tool = trimws(Tool),
      Tool = str_squish(Tool)

      ) %>% ## remove any strings in a ()
    dplyr::filter(Tool != 'NA') %>%
    as.data.frame()
}


dt.tool <- dt %>%
  ### -clean up the names of the tools
  dplyr::select(1:5, Tools, -Title) %>%
  dplyr::filter(str_detect(string = Tools, pattern = "exclude", negate = T)) %>%
  dplyr::mutate(Tool = gsub("Other: ", "", Tools)) %>%
  func_clean_tools(data = .) %>%
  as.data.frame()

dt.tool.expand <- dt.tool %>% 
  dplyr::filter(nchar(Tool) < 180) %>%
  expand_col_to_long(data = ., target_col = "Tool") %>%
  dplyr::mutate(
    Tool = gsub(".*Likert.*|.*likert.*", "Likert scale", Tool),
    # Tool = gsub(";", "", Tool),
    ) %>% 
  func_clean_tools(data = .) 

dt.tool.clean <- dt.tool.expand %>%
  group_by(Tool) %>%
  # dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  tally() %>%
  ungroup() %>%
  arrange(Tool) %>%
  as.data.frame()
```



```{r - tools selected for MA, include=FALSE}
## select the most used measures in literature for meta-analysis
tools_selected <- c('POMS', 'GHQ-12', 'PANAS')

dt.tool.expand.selected <- dt.tool.expand %>% 
  dplyr::filter(Tool %in% tools_selected) %>%
  dplyr::select(-Tools) %>%
  arrange(Tool, id) %>%
  dplyr::mutate(id = paste0('#', id)) %>%
  as.data.frame()

f <- paste0('./data/0301-MA-input/', 'paperID_byTopTools_', today, '.CSV'); f
readr::write_csv(x = dt.tool.expand.selected, file = f)
```



```{r - tool bar}

dt.tool.clean %>%
  dplyr::slice_max(order_by = n, n = 20) %>%
  plot_freq(data = ., var = 'Tool') +
  geom_text(
    aes(label = n), vjust = 0.5, hjust = 1.1, color = 'white', size = 3) +
  ggtitle("Frequency of Mental health\nmeasurement tools") +
  theme_bw() +
  theme(
    plot.title = element_text(size = 10, hjust = .5, face = 'bold'),
    plot.title.position = "plot", #NEW parameter. Apply for subtitle too.
    )

f <- paste0('mini-review_tools_bar_', today, '.png'); f
fname <- paste0(dir.fig, f)
func_ggsave(fname = fname, w = w, h = h)

###' save to a shared Drive
fname <- paste0(dir_share, f); fname
func_ggsave(fname = fname, w = w, h = h)
```


## Matching

```{r - indicator-tool matching}
set.seed(123)

## - need to better match indicator and scales for N vs N cases
dt.ind_match_scale <- dt %>%
  dplyr::select(-`Study ID`, -Title, -Country) %>%
  dplyr::mutate(
    n_ind  = 1+str_count(Indicator, ",|;"),
    n_tool = 1+str_count(Tools, ",|;")) %>%
  dplyr::filter(n_ind >1 & n_tool >1) %>%
  # dplyr::filter(Reviewer == 'Yingjie Li') %>%
  arrange(Indicator) %>%
  dplyr::slice(., sample(1:n()))
  


## YYM and YJL will each take a proportion, and manually fix the indicator-tool matching issue.  
dt.ind_match_scale1 <- dt.ind_match_scale %>%
  dplyr::slice_head(., prop = .51) %>%
  arrange(Indicator)


dt.ind_match_scale2 <- dt.ind_match_scale %>%
  dplyr::slice_tail(., prop = .51)%>%
  arrange(Indicator)


intersect(dt.ind_match_scale1$id, dt.ind_match_scale2$id)
intersect(dt.ind_match_scale2$id, dt.ind_match_scale1$id)

# readr::write_csv(x = dt.ind_match_scale1, file = paste0('./data/fix_indicator-tool_matching/', 'dt.ind_match_scale1.csv'))
# readr::write_csv(x = dt.ind_match_scale2, file = paste0('./data/fix_indicator-tool_matching/', 'dt.ind_match_scale2.csv'))

rm(dt.ind_match_scale1, dt.ind_match_scale2)

```


```{r - manual match, include=FALSE}
library(googlesheets4)
link <- 'https://docs.google.com/spreadsheets/d/1Tu7m6A7LOplbuXaLTYV0X3JUs0AhX90T0v-TcFTW3Yg/edit?usp=sharing'

### Footprint indicators
mat <- googlesheets4::read_sheet(link, sheet = 'MH_indicators_tools', skip = 1) 

matching <- mat %>%
  dplyr::select(MH_indicator, MH_tool_abbr) %>%
  # dplyr::distinct(ind, .keep_all = T) %>%
  dplyr::filter(
    !MH_indicator %in% c('x', '?', NA), 
    !MH_tool_abbr %in% c('x', '?', NA)
  ) %>%  
  dplyr::mutate(
    MH_indicator = gsub("\\s*\\([^\\)]+\\)", "", MH_indicator), # remove text within parenthesis 
    MH_tool_abbr = gsub("\\s*\\([^\\)]+\\)", "", MH_tool_abbr), # remove text within parenthesis 
    MH_indicator = Hmisc::capitalize(str_squish(trimws(MH_indicator))),
    MH_tool_abbr = Hmisc::capitalize(str_squish(trimws(MH_tool_abbr))),
  ) %>%  
  arrange(MH_indicator, MH_tool_abbr) %>%
  as.data.frame()
```




```{r - columns to be cleaned}
to.clean.ind <- dt.ind_match_scale %>% 
  expand_col_to_long(data = ., target_col = "Indicator") %>%
  dplyr::mutate(
    Indicator = gsub("emotions|Emotions", "Emotion", Indicator),
    Indicator = gsub(";", "", Indicator),
    ) %>% 
  group_by(Indicator) %>%
  tally() %>%
  dplyr::filter(!Indicator %in% c('', NA)) %>%
  as.data.frame()

to.clean.tool <- dt.ind_match_scale %>%
  dplyr::select(1:2, Tools) %>%
  dplyr::mutate(Tool = gsub("Other: ", "", Tools)) %>%
  func_clean_tools(data = .) %>%
  expand_col_to_long(data = ., target_col = "Tool") %>%
  dplyr::mutate(
    Tool = gsub(".*Likert.*|.*likert.*", "Likert scale", Tool),
    Tool = str_squish(trimws(Tool))
    ) %>% 
  dplyr::distinct(Tool, .keep_all = T) %>%
  dplyr::filter(str_starts(negate = T, pattern = "'|’", string = Tool)) %>%
  ungroup() %>%
  arrange(Tool) %>%
  as.data.frame()
```




```{r - varify matching, include=FALSE}
## make sure the indicator and tool names are cleaned and unified ------------------------
matching.1 <- matching %>%
  merge(x = ., y = to.clean.ind,  by.x = 'MH_indicator', by.y = 'Indicator', all = T) %>%
  arrange(!is.na(MH_tool_abbr)) %>%
  dplyr::select(-n) %>%
  merge(x = ., y = to.clean.tool, by.x = 'MH_tool_abbr', by.y = 'Tool', all = T) %>%
  arrange(!is.na(MH_indicator))
  


matching.final <- matching.1 %>%
  dplyr::filter(!is.na(MH_indicator) & !is.na(MH_tool_abbr)) %>%
  dplyr::select(1:2) %>%
  dplyr::mutate(pair = paste0(MH_indicator, '-', MH_tool_abbr))

f <- paste0('./data/MH_indicator_tool_matching_database.rds')
### Save a single object to a file
# saveRDS(object = matching, file = f)

### Restore it under a different name
# matching <- readRDS(file = f)
```



## Check data 

```{r - ❌ errors, include=FALSE}
dt_err <- dt %>%
  # dplyr::filter(str_detect(Indicator, fixed('Antidepressants', ignore_case = T))) %>% ##  
  # dplyr::filter(str_detect(Indicator, fixed('Hyperactivity', ignore_case = T))) %>% ##  
  # dplyr::filter(str_detect(Tools, fixed('4DSQ', ignore_case = T))) %>%
  # dplyr::filter(str_detect(Tools, fixed('PRS', ignore_case = T))) %>% # 
  # dplyr::filter(str_detect(Tools, fixed('Both SF', ignore_case = T))) %>% #
  dplyr::filter(str_detect(Tools, fixed('PNAS', ignore_case = T))) %>% # 
  # dplyr::filter(str_detect(Country, fixed('Virginia', ignore_case = T))) %>% # 
  as.data.frame()

# dt_err_ <- dt %>%
#   # dplyr::filter(id == '320') %>%
#   dplyr::filter(id == '134') %>%
#   dplyr::distinct(id, .keep_all = T) %>%
#   as.data.frame()
```



```{r - ✅ to-do list}
```
  [x] current indicator-scale matching approach needs to be improved, `dt.ind.tool`
  [] clean data in `matching.1`
  [] address consensus and keep unique paper id in the data `df`
  []
  []



## Region 

```{r - region - bar}

func_clean_country <- function(data) {
  d <- data %>%
    dplyr::mutate(
      ## clean and correct country names
      Country = case_when(
        str_detect(string = Country, pattern = 'Scotland|UK|England|United kingdom|The United Kingdom') ~ 'United Kingdom',
        str_detect(string = Country, pattern = 'Indonasia') ~ 'Indonesia',
        str_detect(string = Country, pattern = 'Malasia') ~ 'Malaysia',
        str_detect(string = Country, pattern = 'The Netherlands') ~ 'Netherlands',
        str_detect(string = Country, pattern = 'Danmark') ~ 'Denmark',
        str_detect(string = Country, pattern = 'Beigium') ~ 'Belgium',
        str_detect(string = Country, pattern = 'Brasil') ~ 'Brazil',
        str_detect(string = Country, pattern = 'Chili') ~ 'Chile',
        str_detect(string = Country, pattern = 'Czech') ~ 'Czechia',
        str_detect(string = Country, pattern = 'Virginia') ~ 'USA',
        # 
        T ~ Country)
      ) %>%
    dplyr::mutate(Country = trimws(Country)) %>%
    as.data.frame()
  return(d)
}

reg_ <- dt %>%
  dplyr::select(1, Country) %>%
  dplyr::filter(!is.na(Country)) %>%
  dplyr::filter(!Country %in% c('m', 'NA', 'Global', 'Europe', 'all over the world')) %>%
  group_by(Country) %>%
  tally() %>%
  as.data.frame()

region <- reg_ %>%
  expand_col_to_long(data = ., target_col = "Country") %>%
  dplyr::mutate(Country = ifelse(
      nchar(Country) > 3,
      str_to_title(Country),
      Country
    )) %>%
  func_clean_country(data = .) %>%
  group_by(Country) %>%
  dplyr::summarise_at('n', sum, na.rm = TRUE) %>%
  as.data.frame()


library(SDGdetector)
packageVersion('SDGdetector')

library(dplyr)
library(stringr)
library(ggplot2)
library(cowplot)


codelist.supp <- data.frame(
  country.name.en = c('USA'),
  iso3c = c('USA'),
  region = c('North America')
)
codelist <- SDGdetector::codelist_panel %>%
  dplyr::distinct(country.name.en, iso3c, region) %>%
  rbind(., codelist.supp) %>%
  dplyr::mutate(
    country.name.en = case_when(
      str_detect(string = iso3c, pattern = 'HKG') ~ 'Hong Kong',
      T ~ country.name.en)
  ) %>%
  dplyr::distinct(country.name.en, iso3c, region
)
  
shp <- SDGdetector::shp


func_add_region <- function(data) {
  d <- data %>%
    merge(x = ., 
          y = codelist, 
          by.x = 'Country', 
          by.y = 'country.name.en', all.x = T) %>%
    ## add more detailed region name info
    merge(x = ., 
          y = countryRegions %>%
            dplyr::select(ISO3, REGION, continent), 
          by.x = 'iso3c', 
          by.y = 'ISO3', all.x = T) %>%
    ## remove `region`, and rename `REGION` to `Region`
    dplyr::select(-region) %>%
    dplyr::rename('Region' = 'REGION') %>%
    arrange(!is.na(iso3c))
  
  return(d)
}

region_match <- region %>%
  func_add_region(.)
 

region_count <- region_match %>%
  group_by(
           # Country, 
           Region,
           iso3c
           ) %>%
  dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  arrange(n, Region, iso3c) %>%
  as.data.frame()


region_count %>% 
  dplyr::mutate(facet = ifelse(n>=5, 0, 1)) %>%
  # dplyr::slice_max(order_by = n, n = 20) %>%
  ggplot(aes(x = reorder(iso3c, n), 
             y = n,
             fill = Region
             )) +
  geom_col() +
  geom_text(aes(label = n), vjust = 0.5, hjust = 0, size = 3, color = 'gray20') +
  xlab('')+
  coord_flip() +
  facet_wrap(~facet, scales = 'free') +
  theme_bw() +
  theme(legend.position = c(.35, .27),
        strip.background = element_blank(), 
        strip.text = element_blank()
  )

f <- paste0('mini-review_paper_count_bar_', today, '.png'); f
fname <- paste0(dir.fig, f); fname
func_ggsave(fname = fname, w = 7, h = 4, save_png = T)
```


```{r - region - map}

region_count_sf <- region_count %>%
  merge(x= shp, y = ., by.x = 'iso_a3', by.y  = 'iso3c', all.x = T) 


region_count_sf %>%
  dplyr::filter(name != 'Antarctica') %>%
  ggplot(.) +
  geom_sf(aes(fill = n), size = 0.1, color = 'gray80') +
  # geom_sf_text(aes(label = iso_a3), colour = "gray", size =1) + 
  scale_fill_distiller(name= 'Count', palette = 'YlGnBu', direction = 1, na.value = "gray90") +
  # theme_bw() +
  theme_nothing() +
  theme(legend.position = c(0.06, 0.4))

f <- paste0('mini-review_paper_count_map_', today, '.png'); f
w_map = 6.4*2
h_map = 3.2*2

fname <- paste0(dir.fig, f); fname
func_ggsave(fname = fname, w = w_map, h = h_map)

fname <- paste0(dir_share, f); fname
func_ggsave(fname = fname, w = w_map, h = h_map)

```



```{r - ind + ctr}
dt.ind.cl_ctr  <- dt.ind.cl  %>%
  ## - clean `country` -------------------------------------------------------------------
  func_clean_country(.) %>%
  expand_col_to_long(data = ., target_col = "Country") %>%
  func_add_region(.) %>%
  group_by(Indicator, Region) %>%
  tally() %>%
  as.data.frame()


dt.ind.cl_ctr_flow  <- dt.ind.cl_ctr  %>%  
  tidyr::pivot_longer(names_to  = 'dimension', 
               values_to = 'layers', 
               cols = c('Indicator', 'Region')) %>%
  group_by(dimension) %>%
  dplyr::mutate(id_within_layers = row_number(dimension)) %>%
  arrange(dimension) %>%
  dplyr::rename(freq = n) %>%
  dplyr::mutate(
    dimension = factor(dimension, levels = c('Indicator', 'Region')),
    ) %>%
  group_by(layers) %>%
  dplyr::mutate(total = sum(freq, na.rm = T)) %>%
  as.data.frame()



library(ggalluvial)
width_my <- 1/2.5
sorted <- T  ## sorted by flow size
sorted <- NA ## default setting, sorted alphabetically 

indicator_n_min <- 5 ## only map indicators with more than 5 times
# Labeling small strata
labele_small <- 15


func_alluvial <- function(data, 
                          sorted = NA,
                          indicator_n_min = 5, 
                          width_my = 1/2.5, 
                          w_p = 6,
                          labele_small = 15,
                          n_ctr = '',
                          filename.postfix = '') {
  p <- data %>%
    dplyr::filter(freq >= indicator_n_min) %>%
    ggplot(
      .,
      aes(
        x = dimension,
        y = freq,
        alluvium = id_within_layers,
        stratum = layers,
        fill = layers
      )
    ) +
    scale_x_discrete(expand = c(0, 0)) +
    # scale_fill_manual(values = getPalette(colourCount)) +
    # geom_flow(width = width_my) +
    geom_flow(
      width = width_my,
      # aes.bind = TRUE,
      decreasing = sorted
    ) +
    geom_stratum(
      alpha = .6, width = width_my,
      decreasing = sorted
    ) +
    stat_stratum(
      geom = "text",
      aes(label = ifelse(as.numeric(total) >= labele_small, layers, NA)),
      decreasing = sorted
    ) +
    ggrepel::geom_text_repel(
      decreasing = sorted,
      aes(label = ifelse(as.numeric(total) < labele_small, as.character(layers), NA)),
      # segment.square  = F,
      # segment.inflect = T,
      segment.size = 0.3,
      segment.alpha = .7,
      segment.curvature = 0.2, ## negative for left-hand and positive for right-hand curves, 0 for straight lines
      # segment.curvature = -1e-20,
      segment.ncp = 3,
      segment.angle = 20, ## values greater than 90 would skew toward the end
  
      nudge_x = .4,
      nudge_y = .5,
      force_pull = 1,
      direction = "both",
      stat = "stratum",
      size = 3
    ) +
    theme_classic() +
    theme(
      legend.position = "none",
      plot.margin = margin(0, 0, 0, 0, "in"),
      panel.spacing = unit(0, "in"),
      axis.title = element_blank(),
      axis.line = element_blank(),
      
      axis.ticks.x = element_blank(),
      axis.text.y = element_text(margin = margin(t = 0, r = 0, b = 0, l = 0)),
      axis.text.x = element_text(
        size = rel(1.4),
        vjust = 10,
        margin = margin(t = 0, r = 0, b = 0, l = 0)
      )
    )
  
  
  f <- paste0('mini-review_', filename.postfix, '_min', indicator_n_min, '_ctr', n_ctr, '_', today, '.png')
  fname <- paste0(dir.fig, f); print(fname)
  ggsave(filename = fname, plot = p, width = w_p, height = 8, units = 'in', dpi = 300)

  return(p)
}


func_alluvial(data = dt.ind.cl_ctr_flow, indicator_n_min = 5, filename.postfix = 'indicator_region')
```



```{r - tool + ctr}
dt.tool_ctr  <- dt.ind  %>%
  dplyr::select(-Indicator) %>%
  ## - clean `tools` ---------------------------------------------------------------------
  dplyr::mutate(Tool = gsub("Other: ", "", Tools)) %>%
  func_clean_tools(data = .) %>%
  dplyr::filter(nchar(Tool) < 180) %>%
  dplyr::select(-Tools) %>%
  expand_col_to_long(data = ., target_col = "Tool") %>%
  dplyr::mutate(
    Tool = gsub(".*Likert.*|.*likert.*", "Likert scale", Tool),
    Tool = gsub("\\s*\\([^\\)]+\\)", "", Tool), # remove text within parenthesis 
    Tool = trimws(Tool)
    ) %>% 
  func_clean_tools(data = .) %>%
  # as.data.frame() 
  ## clean `country` ---------------------------------------------------------------------
  func_clean_country(.) %>%
  expand_col_to_long(data = ., target_col = "Country") %>%
  func_add_region(.) %>%
  group_by(Tool, Region) %>%
  tally() %>%
  as.data.frame()


dt.tool_ctr_flow  <- dt.tool_ctr  %>%  
  pivot_longer(names_to  = 'dimension', 
               values_to = 'layers', 
               cols = c('Tool', 'Region')) %>%
  group_by(dimension) %>%
  dplyr::mutate(id_within_layers = row_number(dimension)) %>%
  arrange(dimension) %>%
  dplyr::rename(freq = n) %>%
  dplyr::mutate(
    dimension = factor(dimension, levels = c('Tool', 'Region')),
    ) %>%
  group_by(layers) %>%
  dplyr::mutate(total = sum(freq, na.rm = T)) %>%
  as.data.frame()

func_alluvial(data = dt.tool_ctr_flow, indicator_n_min = 5, labele_small = 1, filename.postfix = 'tool_region')
```


```{r - ind + tool + region}
library(tidyverse)


## 1. selected countries for plot
country_selected <- region_count %>%
  slice_max(n = 3, order_by = n)
country_selected <- country_selected$iso3c
n_ctr <- length(country_selected)

## 2. all countries for plot
country_selected <- c()
n_ctr <- length(country_selected)


## - clean `tools` ---------------------------------------------------------------------
dt.ind.cl.1 <- dt.ind.cl %>%
  dplyr::mutate(
    n_tool = 1+str_count(Tools, ",|;")) %>%
  dplyr::filter(n_tool <= 1) %>%
  as.data.frame()

dt.ind.cl.2 <- dt.ind.cl %>%
  dplyr::mutate(
    n_tool = 1+str_count(Tools, ",|;")) %>%
  dplyr::filter(n_tool >1) %>%
  as.data.frame()


dt.ind.tool.1  <- dt.ind.cl.1  %>%
  dplyr::mutate(Tool = gsub("Other: ", "", Tools)) %>%
  func_clean_tools(data = .) %>%
  dplyr::filter(nchar(Tool) < 180) %>%
  dplyr::select(-Tools) %>%
  dplyr::mutate(
    Tool = gsub(".*Likert.*|.*likert.*", "Likert scale", Tool),
    Tool = gsub("\\s*\\([^\\)]+\\)", "", Tool), # remove text within parenthesis 
    Tool = trimws(Tool)
    ) %>% 
  group_by(Indicator, Tool, Country) %>%
  dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  as.data.frame()


dt.ind.tool.2  <- dt.ind.cl.2  %>%
  dplyr::mutate(Tool = gsub("Other: ", "", Tools)) %>%
  func_clean_tools(data = .) %>%
  dplyr::filter(nchar(Tool) < 180) %>%
  dplyr::select(-Tools) %>%
  expand_col_to_long(data = ., target_col = "Tool") %>%
  dplyr::mutate(
    Tool = gsub(".*Likert.*|.*likert.*", "Likert scale", Tool),
    Tool = gsub("\\s*\\([^\\)]+\\)", "", Tool), # remove text within parenthesis 
    Tool = trimws(Tool)
    ) %>% 
  group_by(Indicator, Tool, Country) %>%
  dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  ## matching 
  dplyr::mutate(matching = paste0(Indicator, '-', Tool)) %>%
  dplyr::filter(matching %in% unique(matching.final$pair)) %>%
  dplyr::select(-matching) %>%
  as.data.frame()
  
dt.ind.tool <- rbind(dt.ind.tool.1, dt.ind.tool.2)
  

## - clean `country` -------------------------------------------------------------------
dt.ind.tool.ctr  <- dt.ind.tool  %>%  
  func_clean_country(.) %>%
  expand_col_to_long(data = ., target_col = "Country") %>%
  func_add_region(.) %>%
  group_by(Indicator, Tool, Country, Region) %>%
  dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  as.data.frame()

if (n_ctr > 0) {
  dt.ind.tool.ctr2 <- dt.ind.tool.ctr %>%
    dplyr::filter(iso3c %in% country_selected)
} else {
  n_ctr <- ''
  dt.ind.tool.ctr2 <- dt.ind.tool.ctr
}
  

dt.ind.tool.region <- dt.ind.tool.ctr2 %>%
  group_by(Indicator, Tool, Region) %>%
  dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  # arrange(type_top) %>%
  dplyr::mutate(id = row_number()) %>%
  as.data.frame()


## - prep input for `ggalluvial` ---------------------------------------------------------
dtt  <- dt.ind.tool.region  %>%  
  pivot_longer(names_to = 'dimension', 
               values_to = 'layers', 
               cols = c('Indicator', 'Tool', 'Region')) %>%
  group_by(dimension) %>%
  dplyr::mutate(id_within_layers = row_number(dimension)) %>%
  arrange(dimension) %>%
  dplyr::rename(freq = n) %>%
  dplyr::mutate(
    dimension = factor(dimension, levels = c('Indicator', 'Tool', 'Region')),
    # layers = factor(layers, levels = org_levels)
    ) %>%
  group_by(layers) %>%
  dplyr::mutate(total = sum(freq, na.rm = T)) %>%
  as.data.frame()


func_alluvial(data = dtt, indicator_n_min = 3, labele_small = 20, w_p = 10, filename.postfix = 'indicator_tool_region2')

# f <- paste0('mini-review_mh_indicator_tool_pairs_min', indicator_n_min, '_ctr', n_ctr, '_', today, '.png')
# fname <- paste0(dir.fig, f); fname
# ggsave(filename = fname, plot = last_plot(), width = 10, height = 10, units = 'in', dpi = 300)
# 
# fname <- paste0(dir_share, f); fname
# ggsave(filename = fname, plot = last_plot(), width = 10, height = 10, units = 'in', dpi = 300)

```





