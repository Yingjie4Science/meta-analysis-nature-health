---
title: "mini-review"
author: "Yingjie"
date: "2023-03-05"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
# To clear your environment
remove(list = ls())

## Load common packages and directories
getwd()
setwd(dirname(getwd()))
source("./code/_pkgs_dirs.R")

## Additional packages
library(splitstackshape) ## `cSplit()`
library(Hmisc)
today <- format(Sys.time(), "%Y%m%d"); today ## "%Y%m%d%H%M"
```



# Data import
```{r include=FALSE}
csv_dir <- "./data/covidence_export/data extraction/"
csv <- "review_278532_20230305161741-test mini-review-analysis.csv"
csv <- "review_278532_20230328115335.csv"
df <- readr::read_csv(file = paste0(csv_dir, csv))
```



## data cleaning 

```{r - functions}
expand_col_to_long <- function(data, target_col = "Mental health indicators") {
  data_long <- data %>%
    dplyr::rename("col_split" = target_col) %>%
    cSplit(
      indt = .,
      splitCols = c("col_split"),
      sep = ";|,",
      drop = F, # drop the original col or not
      direction = "long", # this is better than "wide"
      stripWhite = T
    ) %>% # clean white space
    dplyr::mutate(across(where(is.factor), as.character)) %>%
    dplyr::mutate(col_split = trimws(col_split)) %>%
    dplyr::mutate(col_split = ifelse(
      nchar(col_split) > 10,
      str_to_sentence(col_split),
      col_split
    )) %>%
    ## capitalizes first word but not subsequent words
    dplyr::mutate(col_split = Hmisc::capitalize(col_split)) %>%
    as.data.frame() %>%
    group_by(col_split) %>%
    dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
    as.data.frame()

  ## change back to the original column name
  names(data_long)[names(data_long) == "col_split"] <- target_col

  return(data_long)
}



plot_freq <- function(data, var = "Mental health indicators") {
  p <- ggplot(
    data = data,
    aes(
      x = reorder(eval(parse(text = var)), n),
      y = n,
      # fill = n
  )) +
  geom_col() +
  theme_bw() +
  # theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  coord_flip() +
  # scale_fill_distiller(name = '', palette = "Blues", guide = "colorbar", direction = 1) +
  xlab("")
  
  return(p)
}
```


```{r - indicator, include=FALSE}
## keep columns of interest, and clean data
dt <- df %>%
  dplyr::select(1:4, matches("Country|Mental health")) %>%
  dplyr::select(!matches("duration", ignore.case = T)) %>%
  dplyr::rename(
    "Country" = "Country in which the study conducted",
    "Reviewer" = "Reviewer Name"
  ) %>%
  dplyr::mutate(Country = gsub("Other: ", "", Country)) %>%
  dplyr::mutate(`Mental health indicators` = gsub("\\*|Other\\: ", "", `Mental health indicators`)) %>%
  dplyr::arrange(!is.na(`Mental health indicators`), Reviewer)


names(dt)


## stat
## - by indicator
dt.bymhi <- dt %>%
  dplyr::filter(str_detect(string = `Mental health indicators`, pattern = "exclude", negate = T)) %>%
  group_by(`Mental health indicators`) %>%
  dplyr::count() %>%
  ungroup() %>%
  as.data.frame()


## - clean and format
dt.bymhi.clean <- expand_col_to_long(data = dt.bymhi, target_col = "Mental health indicators") %>%
  dplyr::rename('Indicator' = 'Mental health indicators') %>%
  dplyr::mutate(
    Indicator = gsub("emotions|Emotions", "Emotion", Indicator)) %>% 
  group_by(Indicator) %>%
    dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  as.data.frame()
```


```{r - tools, include=FALSE}
## - by scale
dt.bytool <- dt %>%
  ### -clean up the names of the tools
  dplyr::rename("Tools" = "Mental health measurement tools") %>%
  dplyr::select(1:5, Tools, -Title) %>%
  dplyr::mutate(Tools = gsub("\\*|Other\\: ", "", Tools)) %>%
  dplyr::filter(nchar(Tools) < 180) %>%
  dplyr::filter(str_detect(string = Tools, pattern = "exclude", negate = T)) %>%
  dplyr::mutate(
    Tool = gsub("scales|Scales", "scale", Tools),
    Tool = gsub("\\s*\\([^\\)]+\\)", "", Tool)) %>% ## remove any strings in a ()
  ### - stat
  group_by(Tool) %>%
  dplyr::count() %>%
  ungroup() %>%
  dplyr::filter(Tool != 'NA') %>%
  as.data.frame()

dt.bytool.clean <- expand_col_to_long(data = dt.bytool, target_col = "Tool") %>%
  dplyr::mutate(
    Tool = gsub(".*Likert.*|.*likert.*", "Likert scale", Tool)) %>% 
  group_by(Tool) %>%
    dplyr::summarise_at(c("n"), sum, na.rm = T) %>%
  as.data.frame()
```




```{r - by region}
region <- dt %>%
  dplyr::select(1, Country) %>%
  dplyr::filter(!is.na(Country)) %>%
  dplyr::filter(!Country %in% c('m', 'NA', 'Global', 'Europe', 'all over the world')) %>%
  dplyr::mutate(
    Country = case_when(
      str_detect(string = Country, pattern = 'Scotland|UK') ~ 'United Kingdom',
      str_detect(string = Country, pattern = 'Indonasia') ~ 'Indonesia',
      str_detect(string = Country, pattern = 'Malasia') ~ 'Malaysia',
      str_detect(string = Country, pattern = 'Danmark') ~ 'Denmark',
      str_detect(string = Country, pattern = 'Beigium') ~ 'Belgium',
      str_detect(string = Country, pattern = 'Brasil') ~ 'Brazil',
      str_detect(string = Country, pattern = 'Chili') ~ 'Chile',
      T ~ Country)
    )


library(SDGdetector)
packageVersion('SDGdetector')

library(dplyr)
library(stringr)
library(ggplot2)
library(cowplot)


codelist.supp <- data.frame(
  country.name.en = c('USA'),
  iso3c = c('USA')
)
codelist <- SDGdetector::codelist_panel %>%
  dplyr::distinct(country.name.en, iso3c) %>%
  rbind(., codelist.supp) %>%
  dplyr::mutate(
    country.name.en = case_when(
      str_detect(string = iso3c, pattern = 'HKG') ~ 'Hong Kong',
      T ~ country.name.en)
  ) %>%
  dplyr::distinct(country.name.en, iso3c)
  
shp <- SDGdetector::shp


dt_match <- region %>%
  merge(x = ., 
        y = codelist, 
        by.x = 'Country', 
        by.y = 'country.name.en', all.x = T) %>%
  arrange(!is.na(iso3c))


region_count <- dt_match %>%
  group_by(iso3c) %>%
  tally()
```


```{r - by region map}

dt_sf <- region_count %>%
  merge(x= shp, y = ., by.x = 'iso_a3', by.y  = 'iso3c', all.x = T) 


dt_sf %>%
  dplyr::filter(name != 'Antarctica') %>%
  ggplot(.) +
  geom_sf(aes(fill = n), size = 0.1, color = 'gray80') +
  # geom_sf_text(aes(label = iso_a3), colour = "gray", size =1) + 
  scale_fill_distiller(name= 'Count', palette = 'YlGnBu', direction = 1, na.value = "gray90") +
  # theme_bw() +
  theme_nothing() +
  theme(legend.position = c(0.06, 0.4))

fname <- paste0(dir.fig, 'mini-review_paper_count_', 'map.png'); fname
ggsave(filename = fname, plot = last_plot(), width = 6.4*2, height = 3.2*2, units = 'in', dpi = 300)
```


# Viz

## proregss
```{r}
dt %>%
  group_by(Reviewer) %>%
  tally() %>%
  ggplot(aes(x = reorder(Reviewer, n), y = n)) +
  geom_col() +
  geom_text(aes(label = n), vjust = 0.5, hjust = 0, color = 'gray20') +
  coord_flip() +
  theme_bw()
```


## Count by indicator

```{r}
dt.bymhi.clean %>%
  dplyr::slice_max(order_by = n, n = 20) %>%
  ggplot(aes(
    x = reorder(Indicator, n),
    y = n,
    # fill = n
  )) +
  geom_col() +
  theme_bw() +
  # theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  coord_flip() +
  # scale_fill_distiller(name = '', palette = "Blues", guide = "colorbar", direction = 1) +
  xlab("") +
  ggtitle("Frequency of Mental health indicators")

fname <- paste0(dir.fig, "mini-review_mh_freq_", today, ".png")
ggsave(filename = fname, plot = last_plot(), width = 16 / 2, height = 9 / 2, units = "in", dpi = 300, bg = NULL)
```


## Count by tool

```{r}
dt.bytool.clean %>%
  dplyr::slice_max(order_by = n, n = 20) %>%
  plot_freq(data = ., var = 'Tool') +
  ggtitle("Frequency of Mental health measurement tools")

fname <- paste0(dir.fig, "mini-review_mh_tool_freq_", today, ".png")
ggsave(filename = fname, plot = last_plot(), width = 16 / 2, height = 9 / 2, units = "in", dpi = 300, bg = NULL)
```
