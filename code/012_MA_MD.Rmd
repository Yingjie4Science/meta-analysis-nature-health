---
title: "Untitled"
author: "Yingjie"
date: "`r Sys.Date()`"
output: html_document
---


# Data

```{r}

# unique(exp_sub_mods_md$Tools)

## data extracted in Table option 1 ----
exp_sub_mods_md1 <- exp_sub_mods_md %>%
  dplyr::select(1:Notes_o1)


## data extracted in Table option 2 ----
exp_sub_mods_md2 <- exp_sub_mods_md %>%
  dplyr::select(1:buffers_unit, Other_covariates_o2:Notes_o2) %>%
  
  ## within group vs. between group 
  dplyr::mutate(subgroup_design = stringr::str_extract(string=subgroup_other_o2, pattern = "\\d{1}ba|\\d{1}aa") ) %>%
  dplyr::select(1:subgroup_other_o2, subgroup_design, everything()) %>%
  
  ## remove row without any data from table option 2
  dplyr::filter(!is.na(c_mean) & !is.na(e_mean) & !is.na(MH_indicator_o2)) %>%
  
  dplyr::select(1:n_participants, Control_N, c_n, Treatment_N, e_n, everything()) %>%
  # arrange(id, model_id) %>%
  as.data.frame()

##' to see the number of studies by sub_indicators
##' we might need to remove the ones with fewer case studies
unique(exp_sub_mods_md2$MH_indicator_o2) %>% sort()
stats_count_by_ind <- exp_sub_mods_md2 %>% count(MH_indicator_o2) 
stats_count_by_ind

stats_count_by_ind_selected <- stats_count_by_ind %>% dplyr::filter(n>8)
sub_indicator_selected <- unique(stats_count_by_ind_selected$MH_indicator_o2)
sub_indicator_selected


### This is a list manually selected for POMS  
# sub_indicator_selected <- c("Anger", "Anxiety", "Confusion", "Depression", "Fatigue", "Vigor", "TMD")


### remove irrelevant columns 
exp_sub_mods_md2fewCol <- exp_sub_mods_md2 %>%
  dplyr::select(-dplyr::starts_with("Control_"), 
                -dplyr::starts_with('Treatment_'),
                -c('c_sd'))
names(exp_sub_mods_md2fewCol)
```





# MA - SMD

## Using `meta`

### show study details
```{r}
library(meta)
library(grid)
# Use metcont to pool results.

show_raw_data_in_forest <- F
add_subgroup_analysis   <- F


if (add_subgroup_analysis == T) {
  byvar_subgroup <- "subgroup_design"
} else {
  byvar_subgroup <- NULL
}


ma_result <- data.frame()

for (sub_ind_i in sub_indicator_selected) {
  
  exp_sub_mods_md2i <- exp_sub_mods_md2 %>%
    dplyr::filter(MH_indicator_o2 == sub_ind_i)
  
  height_cm <- nrow(exp_sub_mods_md2i)
  
  ma_smd <- metacont(data = exp_sub_mods_md2i,
                     n.e = e_n,
                     n.c = c_n,
                     mean.e = e_mean,
                     mean.c = c_mean,
                     sd.e = e_sd_r,
                     sd.c = c_sd_r,
                     studlab = study_label,
                     
                     sm = "SMD",
                     method.smd = "Hedges",
                     fixed = FALSE,
                     random = TRUE,
                     method.tau = "REML",
                     hakn = TRUE,
                     byvar = byvar_subgroup,  ## Grouping results by a variable, default = NULL
                     title = mh_tool)
  ma_smd
  
  ma_smd.df <- data.frame(
    tool = mh_tool, 
    ind_sub = sub_ind_i, 
    es.mean = ma_smd$TE.random,
    es.lower= ma_smd$lower.random,
    es.upper= ma_smd$upper.random,
    pval    = ma_smd$pval.random %>% round(., digits = 10),
    ## Number of studies
    n_study = ma_smd$k,
    ## Number of observations
    n_obs   = ma_smd$n.e.pooled + ma_smd$n.c.pooled
  ) %>%
    dplyr::mutate(
      p.star  = case_when(pval < 0.001 ~ '***',
                        pval < 0.01 ~ '**',
                        pval < 0.05 ~ '*',
                        T ~ ''),
    )
  ma_result <- rbind(ma_result, ma_smd.df)


  
  ####' forest ----
  ####' https://insidethenumbers.netlify.app/post/meta-analysis/
  ####' https://www.rdocumentation.org/packages/meta/versions/6.5-0/topics/forest.meta
  if(show_raw_data_in_forest == T){
    leftcols_show = c("studlab", "n.e", "mean.e", "sd.e", "n.c", "mean.c", "sd.c")
    add_print.tau2 = T
    width_forestPlot = 27.5
    postfix_simplify = ''
  } else {
    leftcols_show = c("studlab")
    add_print.tau2 = F ## limited space causes text overlap
    width_forestPlot = 18.5
    postfix_simplify = 'simplified'
  }
  
  
  if (add_subgroup_analysis == T) {
    test.effect.subgroup.random_para = TRUE
    postfix_subgroup <- "_subgroup"
    height_cm <- height_cm + 10
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup <- ""
  }
  
  
  f <- paste0('./figures/', 'plot_forest_', mh_tool, '_', sub_ind_i, '_', today, 
              postfix_simplify, 
              postfix_subgroup, 
              '.png'); f
  png(filename = f, 
      # width = 3000, height = 3000, units = "px", pointsize = 22,
      width = width_forestPlot, height = height_cm/1.5, units = "cm", res = 100)
  
  
  forest.meta(ma_smd,
         # layout = "RevMan5",
         # sortvar = TE,
         prediction = F, ## prediction interval for the treatment effect in a future study
         col.predict="gray",
         addpred=TRUE, 
         print.tau2 = T,
         
         ##' specify which variables should be displayed on the left side of the forest plot. 
         leftcols = leftcols_show, 
         # leftlabs = c(),
         # lab.e = "Post-intervention",
         # lab.c = "Pre-intervention",
         
         # xlim = 's', # “s” to produce symmetric forest plots
         
         # print.byvar = FALSE, ## whether the name of the grouping variable should be printed in front of the group labels.
         # label.left = "loss",
         # label.right = "gain",
         digits=2,
         digits.sd = 2,
         digits.tau2 = 2,
         colgap = "0.4cm",
         # colgap.forest = "1cm",
         colgap.forest.left = '1.2cm',
         col.by = "black",
         col.square = "black",
         col.inside = "black",
         col.square.lines = "black",
         shade=TRUE,
         test.effect.subgroup.random = test.effect.subgroup.random_para,
         pooled.totals=T,
         overall = T,
         overall.hetstat = T)
  
  # forest(ma_smd, 
  #        addpred=TRUE, 
  #        header=TRUE, 
  #        # xlim=c(-1,1), 
  #        # slab = study_label, 
  #        digits.sd = 2,
  #        digits.tau2 = 2,
  #        shade=TRUE)
  
  # Add a title to the entire plot
  grid::grid.text(label = sub_ind_i, x = 0, y = .98, just = 'left', gp=gpar(cex=1, fontface='bold'))
  
  dev.off()
  
}



## save MA result 
fname <- paste0('./data/0302-MA-output/', paste('ma_result', mh_tool, '.rds', sep = '_')); fname
saveRDS(ma_result, file = fname)
```


### show overall effect

```{r}
source('./code/func_plot_ma.R')
library(ggpubr)

ma_result_panas <- readRDS("./data/0302-MA-output/ma_result_PANAS_.rds")
ma_result_poms  <- readRDS("./data/0302-MA-output/ma_result_POMS_.rds")

ma_result_all <- rbind(ma_result_panas, ma_result_poms)

p1 <- plot_effect_size_overall(data = ma_result_panas)
p2 <- plot_effect_size_overall(data = ma_result_poms)


ggarrange(p1 + rremove("x.title"), 
          p2, 
          labels = c("A", "B"), ncol = 1, nrow = 2,
          heights = c(0.4, 1),
          align = "v")

fname <- paste0(dir.fig, 'plot_es_combined', today, '.png'); fname
func_ggsave(fname, w = 6, h = 5.5, save_png = T)
```

**refs**
- http://www.sthda.com/english/articles/24-ggpubr-publication-ready-plots/81-ggplot2-easy-way-to-mix-multiple-graphs-on-the-same-page/
- https://rpkgs.datanovia.com/ggpubr/reference/rremove.html



## Using `metafor`

```{r eval=FALSE, include=FALSE}
library(metafor)

for (sub_ind_i in sub_indicator_selected) {
  
  exp_sub_mods_md2i <- exp_sub_mods_md2 %>%
    dplyr::filter(MH_indicator_o2 == sub_ind_i)
  
  dat1 <- metafor::escalc(
    data=exp_sub_mods_md2i,
    measure="SMD", 
    m1i=c_mean, sd1i=c_sd_r, n1i=c_n,
    m2i=e_mean, sd2i=e_sd_r, n2i=e_n)
  
  
  # Finally, a random-effects model can be fitted to these data with:
  res <- rma(yi, vi, data=dat1, digits=3)
  res
  ### fit equal- and random-effects models
  # rma(yi, vi, data=dat1, method="EE", digits=3)
  
  
  ### forest plot with extra annotations
  ###' https://wviechtb.github.io/metafor/reference/forest.default.html
  metafor::forest(
    x = res, 
    # atransf=exp, # transform the x-axis labels and annotations
    # at=log(c(0.05, 0.25, 1, 4)), xlim=c(-16,6),
    # ilab=cbind(tpos, tneg, cpos, cneg),
    # ilab.xpos=c(-9.5,-8,-6,-4.5),
    psize=1,
    cex=0.75, 
    header="Study label", 
    slab=study_label,
    showweights = T,
    mlab=sub_ind_i, 
    shade=TRUE)
  
  
  
  op <- par(cex=0.75, font=2)
  par(op)
  ### add text with Q-value, dfs, p-value, and I^2 statistic
  text(-16, -2, pos=4, cex=0.75, 
       bquote(paste("RE Model (Q = ", .(fmtx(res$QE, digits=2)),
                    ", df = ", .(res$k - res$p), ", ",
                    .(fmtp(res$QEp, digits=3, pname="p", add0=TRUE, sep=TRUE, equal=TRUE)), "; ",
                    I^2, " = ", .(fmtx(res$I2, digits=1)), "%)")))
  
  
  
  
  #### auto-report using reporter() function ----
  dir.report <- paste0('./figures/'); dir.report
  # metafor::reporter(res, dir = dir.report)
  
  ### save as PDF
  # reporter(res, format="pdf", 
  #          dir = paste0(dir.root, '/figures/'), 
  #          filename = 'report_metafor.PDF')
  #          
  # reporter(res, format="word")

  ### add an outlier
  # dat$yi[6] <- 2.5
  # res <- rma(yi, vi, data=dat)
  # reporter(res)
  
}
```



  There is no statistical reason why studies with change-from-baseline outcomes should not be combined in a meta-analysis with studies with post-intervention measurement outcomes when using the (unstandardized) MD method. [link](https://training.cochrane.org/handbook/current/chapter-10#section-10-5)
  In contrast, post-intervention value and change scores should not in principle be combined using standard meta-analysis approaches when the effect measure is an SMD. The SD when standardizing post-intervention values reflects between-person variability at a single point in time. The SD when standardizing change scores reflects variation in between-person changes over time, so will depend on both within-person and between-person variability
  
## Missing data
  This is often a problem when change-from-baseline outcomes are sought. We discuss imputation of missing SDs in Chapter 6, Section 6.5.2.8
  