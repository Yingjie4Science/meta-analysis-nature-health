---
title: "Untitled"
author: "Yingjie"
date: "`r Sys.Date()`"
output: html_document
---



```{r include=FALSE}
# install.packages("remotes")
# remotes::install_github("guido-s/meta", ref = "develop", build_vignettes = TRUE, force = TRUE)

library(meta)
packageVersion("meta")


##' an extra post fix for figure's version control
vv <- ""
vv <- "v2"
```



# Data

```{r}

# unique(exp_sub_mods_md$Tools)

## data extracted in Table option 1 ----
exp_sub_mods_md1 <- exp_sub_mods_md %>%
  dplyr::select(1:Notes_o1)


## data extracted in Table option 2 ----
exp_sub_mods_md2 <- exp_sub_mods_md %>%
  dplyr::select(1:buffers_unit, Other_covariates_o2:Notes_o2) %>%
  
  ## within group vs. between group 
  dplyr::mutate(subgroup_design = stringr::str_extract(string=subgroup_other_o2, pattern = "\\d{1}ba|\\d{1}aa") ) %>%
  dplyr::select(1:subgroup_other_o2, subgroup_design, everything()) %>%
  
  ## remove row without any data from table option 2
  dplyr::filter(!is.na(c_mean) & !is.na(e_mean) & !is.na(MH_indicator_o2)) %>%
  
  dplyr::select(1:n_participants, Control_N, c_n, Treatment_N, e_n, everything()) %>%
  # arrange(id, model_id) %>%
  as.data.frame()

##' to see the number of studies by sub_indicators
##' we might need to remove the ones with fewer case studies
unique(exp_sub_mods_md2$MH_indicator_o2) %>% sort()
stats_count_by_ind <- exp_sub_mods_md2 %>% count(MH_indicator_o2) 
stats_count_by_ind

stats_count_by_ind_selected <- stats_count_by_ind %>% dplyr::filter(n>8)
sub_indicator_selected <- unique(stats_count_by_ind_selected$MH_indicator_o2)
sub_indicator_selected


### This is a list manually selected for POMS  
# sub_indicator_selected <- c("Anger", "Anxiety", "Confusion", "Depression", "Fatigue", "Vigor", "TMD")


### remove irrelevant columns 
exp_sub_mods_md2fewCol <- exp_sub_mods_md2 %>%
  dplyr::select(-dplyr::starts_with("Control_"), 
                -dplyr::starts_with('Treatment_'),
                -c('c_sd'))
names(exp_sub_mods_md2fewCol)
```





# MA - SMD

## Using `meta`

### show study details
```{r}
library(meta)
library(grid)
# Use metcont to pool results.

show_raw_data_in_forest <- F

add_subgroup_analysis   <- T
subgroup_select <- 'subgroup_design' ## ?? [] need to fix NAs in the column -> revise `subgroup_selected`
# subgroup_select <- 'exposure_o2'
subgroup_select <- 'nature_type_o2'
# subgroup_select <- '' ## age group
# subgroup_select <- '' ## exposure duration 

n_group <- unique(exp_sub_mods_md2[subgroup_select]) %>% nrow()

ma_result.overall <- data.frame()
ma_result.subgroup <- data.frame()

for (sub_ind_i in sub_indicator_selected) {
  
  exp_sub_mods_md2i <- exp_sub_mods_md2 %>%
    dplyr::filter(MH_indicator_o2 == sub_ind_i) 
  
  if (add_subgroup_analysis == T) {
    exp_sub_mods_md2i <- exp_sub_mods_md2i %>%
      dplyr::mutate(subgroup_selected = !!sym(subgroup_select)) %>%
      dplyr::filter(!is.na(subgroup_selected)) %>%
      as.data.frame()
  } else {
    exp_sub_mods_md2i <- exp_sub_mods_md2i %>%
      dplyr::mutate(subgroup_selected = 'NULL') %>%
      as.data.frame()
  }
  

  height_cm <- nrow(exp_sub_mods_md2i)
  
  ma_smd <- meta::metacont(
    data = exp_sub_mods_md2i,
    n.e = e_n,
    n.c = c_n,
    mean.e = e_mean,
    mean.c = c_mean,
    sd.e = e_sd_r,
    sd.c = c_sd_r,
    studlab = paste0(`Study ID`, ' - ', model_id), #study_label,
    
    sm = "SMD", 
    method.smd = "Hedges",
    fixed = FALSE,
    random = TRUE,
    method.tau = "REML",
    hakn = TRUE, 
    subgroup = NULL,  ## Grouping results by a variable, default = NULL
    title = mh_tool)
  ma_smd
  
  ## update the MA by adding subgroup analysis
  if (add_subgroup_analysis == T) {
    ma_smd <- update(ma_smd, subgroup = subgroup_selected)
  }
  
  
  
  ## extract the overall effect size data to a dataframe =================================
  ### 1. overall model data
  ma_smd.df <- data.frame(
    tool = mh_tool, 
    ind_sub = sub_ind_i,
    subgroup = 'Overall',
    es.mean = ma_smd$TE.random,
    es.lower= ma_smd$lower.random,
    es.upper= ma_smd$upper.random,
    pval    = ma_smd$pval.random %>% round(., digits = 10),
    I2      = as.numeric(ma_smd$I2) %>% round(., digits = 2),
    p_subgroup = NA,
    ## Number of studies
    n_study = ma_smd$k.all,
    ## Number of observations
    n_obs   = ma_smd$n.e.pooled + ma_smd$n.c.pooled
  ) %>%
    dplyr::mutate(
      p.star  = case_when(pval < 0.001 ~ '***',
                        pval < 0.01 ~ '**',
                        pval < 0.05 ~ '*',
                        T ~ ''),
    )
  ma_result.overall <- rbind(ma_result.overall, ma_smd.df)
  
  ### 2. subgroup model data
  if (add_subgroup_analysis == T) {
    ma_smd.df.subgroup <- data.frame(
      tool = mh_tool, 
      ind_sub = sub_ind_i, 
      subgroup = names(ma_smd$TE.common.w),
      es.mean = as.numeric(ma_smd$TE.random.w),
      es.lower= as.numeric(ma_smd$lower.random.w),
      es.upper= as.numeric(ma_smd$upper.random.w),
      pval    = as.numeric(ma_smd$pval.random.w) %>% round(., digits = 10),
      I2      = as.numeric(ma_smd$I2.w) %>% round(., digits = 2),
      p_subgroup = as.numeric(ma_smd$pval.Q.b.random) %>% round(., digits = 10),
      ## Number of studies
      n_study = as.numeric(ma_smd$k.all.w),
      ## Number of observations
      n_obs   = NA
    ) %>%
      dplyr::mutate(
        p.star  = case_when(pval < 0.001 ~ '***',
                          pval < 0.01 ~ '**',
                          pval < 0.05 ~ '*',
                          T ~ ''),
      )
    ma_result.subgroup <- rbind(ma_result.subgroup, ma_smd.df.subgroup)
  }


  
  ##' forest plot ========================================================================
  ##'     https://insidethenumbers.netlify.app/post/meta-analysis/
  ##'     https://www.rdocumentation.org/packages/meta/versions/6.5-0/topics/forest.meta
  if(show_raw_data_in_forest == T){
    leftcols_show = c("studlab", "n.e", "mean.e", "sd.e", "n.c", "mean.c", "sd.c")
    add_print.tau2 = T
    width_forestPlot = 27.5
    postfix_simplify = ''
  } else {
    leftcols_show = c("studlab")
    add_print.tau2 = F ## limited space causes text overlap
    width_forestPlot = 18.5
    postfix_simplify = 'simplified'
  }
  
  
  if (add_subgroup_analysis == T) {
    test.effect.subgroup.random_para = TRUE
    postfix_subgroup <- paste0("_subgroup_", subgroup_select)
    height_cm <- height_cm + 10 + n_group
  } else {
    test.effect.subgroup.random_para = F
    postfix_subgroup <- ""
  }
  
  
  f <- paste0('./figures/', 'forest_', mh_tool, '/', sub_ind_i, '_', 
              postfix_simplify, 
              postfix_subgroup, '_', today, 
              '.png'); f
  png(filename = f, 
      # width = 3000, height = 3000, units = "px", pointsize = 22,
      width = width_forestPlot, height = height_cm/1.5, units = "cm", res = 100)
  
  
  meta::forest(ma_smd,
         # layout = "RevMan5",
         # sortvar = TE,
         prediction = F, ## prediction interval for the treatment effect in a future study
         col.predict="gray",
         addpred=TRUE, 
         print.tau2 = T,
         
         ##' specify which variables should be displayed on the left side of the forest plot. 
         leftcols = leftcols_show, 
         # leftlabs = c(),
         # lab.e = "Post-intervention",
         # lab.c = "Pre-intervention",
         
         # xlim = 's', # “s” to produce symmetric forest plots
         
         # print.byvar = FALSE, ## whether the name of the grouping variable should be printed in front of the group labels.
         # label.left = "loss",
         # label.right = "gain",
         digits=2,
         digits.sd = 2,
         digits.tau2 = 2,
         colgap = "0.2cm",
         # colgap.forest = "1cm",
         colgap.forest.left = '1.8cm',
         col.by = "black",
         col.square = "black",
         col.inside = "black",
         col.square.lines = "black",
         shade=TRUE,
         test.effect.subgroup.random = test.effect.subgroup.random_para,
         pooled.totals=T,
         overall = T,
         overall.hetstat = T)
  
  # forest(ma_smd, 
  #        addpred=TRUE, 
  #        header=TRUE, 
  #        # xlim=c(-1,1), 
  #        # slab = study_label, 
  #        digits.sd = 2,
  #        digits.tau2 = 2,
  #        shade=TRUE)
  
  # Add a title to the entire plot
  grid::grid.text(label = sub_ind_i, x = 0, y = .98, just = 'left', gp=gpar(cex=1, fontface='bold'))
  
  dev.off()
  
}



## save MA result 
cat('\n')
fname <- paste0('./data/0302-MA-output/', paste('ma_result.overall', mh_tool, '.rds', sep = '_')); fname
saveRDS(ma_result.overall, file = fname)

if (add_subgroup_analysis == T) {
  fname <- paste0('./data/0302-MA-output/', paste('ma_result.subgroup', mh_tool, subgroup_select, '.rds', sep = '_')); fname
  saveRDS(ma_result.subgroup, file = fname)
}
```


### show overall effect

```{r - overall}
source('./code/func_plot_ma.R')
library(ggpubr)

fs <- list.files(path = "./data/0302-MA-output/", 
                 pattern = '^ma_result.*_PANAS|^ma_result.*_POMS', 
                 full.names = T);
cat('\n This', length(fs), 'files will be included:\n')
print(fs)

ma_result_all <- data.frame()
for (f in fs) {
  d <- readRDS(file = f) 
  ma_result_all <- rbind(ma_result_all, d)
}
# ma_result_panas <- readRDS("./data/0302-MA-output/ma_result.overall_PANAS_.rds") 
# ma_result_poms  <- readRDS("./data/0302-MA-output/ma_result.overall_POMS_.rds") 
# ma_result.subgroup_panas <- readRDS("./data/0302-MA-output/ma_result.subgroup_PANAS_.rds") 
# ma_result.subgroup_poms  <- readRDS("./data/0302-MA-output/ma_result.subgroup_POMS_.rds") 



p1 <- ma_result_all %>%
  dplyr::filter(subgroup == 'Overall', tool == 'PANAS') %>%
  plot_effect_size_overall(data = ., subgroup = NULL)
p2 <- ma_result_all %>%
  dplyr::filter(subgroup == 'Overall', tool == 'POMS') %>%
  plot_effect_size_overall(data = .)


ggarrange(p1 + rremove("x.title"), 
          p2, 
          labels = c("A", "B"), ncol = 1, nrow = 2,
          heights = c(0.4, 1),
          align = "v")


## pool all data together 
ma_result_all %>%
  dplyr::filter(subgroup == 'Overall') %>%
  plot_effect_size_overall(data = ., 
                           color_var = 'tool', 
                           show_legend = T) +
  theme(legend.position = c(0.9, 0.8)) +
  guides(color = guide_legend(title="MH Tools"))



fname <- paste0(dir.fig, 'es_combined_PANAS_POMS_', today, vv, '.png'); fname
func_ggsave(fname, w = 6, h = 5.5, save_png = T)
```

### by group

```{r - table & numbers}
ma_result.subgroup_psubgroup <- ma_result_all %>%
  dplyr::filter(subgroup != 'Overall') %>%
  dplyr::distinct(tool, ind_sub, .keep_all = T)
```



```{r - plot}
source('./code/func_plot_ma.R')

##' color from https://developers.google.com/earth-engine/datasets/catalog/USGS_NLCD_RELEASES_2021_REL_NLCD#bands
nature_type_list <- c("Greenspace",               # '#68ab5f'	(Deciduous Forest)
                      "Greenspace - Forest/Tree", # '#1c5f2c'	
                      "Greenspace - Shrub/scrub", # '#ccb879'	
                      "Greenspace - Grassland",   # '#dfdfc2'
                      "Greenspace - Farmland",    # '#ab6c28'
                      "Greenspace - Park",        # 
                      "Greenspace - Garden",      # '#aaff00'
                      "Greenspace - Green alley/Roadside green", 
                      "Greenspace - Green roof/wall",# '#79ffd2'              (Shrub-Forest)
                      "Bluespace - Open water",      # '#466b9f'
                      "Bluespace - Wetland",         # '#b8d9eb'
                      "Bluespace - Sea",             # '#0000ff'
                      "Bluespace - Beach/coastline", # '#0000ff'
                      "Other"                        # '#000000'	
                      )
colors_nature_type <- c(
  '#68ab5f', # "Greenspace"
  '#1c5f2c', # "Greenspace - Forest/Tree"
  '#ccb879', # "Greenspace - Shrub/scrub"
  '#b2df8a', # "Greenspace - Grassland"
  '#ab6c28', # "Greenspace - Farmland"
  '#fb9a99', # "Greenspace - Park"
  '#aaff00', # "Greenspace - Garden" (forest disturbed before/at 2006)
  '#beaed4', # "Greenspace - Green alley/Roadside green"
  '#79ffd2', # "Greenspace - Green roof/wall"
  '#466b9f', # "Bluespace - Open water"
  '#b8d9eb', # "Bluespace - Wetland"
  '#0000ff', # "Bluespace - Sea"
  '#0000ff', # "Bluespace - Beach/coastline"
  '#000000'  # "Other"
  )

names(colors_nature_type) <- nature_type_list




p1_tool <- ma_result_all %>%
  data.table::as.data.table() %>%
  dplyr::filter(subgroup != 'Overall', tool == 'PANAS'); 

len <- length(unique(p1_tool$subgroup)); len
facet_decide <- ifelse(len >3, T, F)

## add named colors
element_list <- unique(p1_tool$subgroup); element_list
colors_nature_type_included1 <- colors_nature_type[element_list]; colors_nature_type_included1
# p1_tool$subgroup = factor(x = p1_tool$subgroup, levels = element_list_named)

p1 <- p1_tool %>%
  # dplyr::mutate(subgroup = factor(x = subgroup, levels = element_list_named)) %>%
  plot_effect_size_overall(data = .,
                           subgroup = 'subgroup', 
                           facet_bygroup = facet_decide, 
                           add_gradient_bg = F,
                           show_legend = F) +
  scale_colour_manual(values = colors_nature_type)



p2_tool <- ma_result_all %>%
  dplyr::filter(subgroup != 'Overall', tool == 'POMS') 

len <- length(unique(p2_tool$subgroup)); len
facet_decide <- ifelse(len >3, T, F)

## add named colors
element_list2 <- unique(p2_tool$subgroup); 
colors_nature_type_included2 <- colors_nature_type[element_list2]; colors_nature_type_included2

p2 <- p2_tool %>%
  # dplyr::mutate(subgroup = factor(x = subgroup, levels = element_list_named)) %>%
  plot_effect_size_overall(data = ., 
                           subgroup = 'subgroup', 
                           facet_bygroup = facet_decide, 
                           add_gradient_bg = F,
                           show_legend = T) + 
  theme(legend.position = c(0.8, 0.1)) +
  # It's recommended to use a named vector
  scale_colour_manual(values = colors_nature_type)
# p2



## create a legend that includes elements from both figures ------------------------------
set.seed(1) # for reproducibility
ls_element <- unique(c(element_list, element_list2))
ls <- unique(c(colors_nature_type_included1, colors_nature_type_included2))
n  <- length(ls); n

# generate 5 random points
tbl <- tibble(x = runif(n),
              y = runif(n),
              `Nature Type` = ls_element, 
              class = factor( LETTERS[1:n] ))

# print if x > 0.5
legend_plot <- ggplot(data = tbl,
            aes(x = x,
                y = y,
                color = `Nature Type`)) +
  geom_point(size = 2) +
  # scale_colour_discrete(drop = FALSE) +
  scale_colour_manual(values = colors_nature_type) +
  theme_bw() +
  theme(legend.spacing.y = unit(0, 'cm'),
        legend.spacing.x = unit(0, 'cm'),
        legend.key.size = unit(0.05, 'cm'),
        legend.title=element_text(size=7.5, face = 'bold'),
        legend.text=element_text(size=7),
            ) +
  guides(color = guide_legend(reverse=TRUE))
# legend_plot  
legend_made <- get_legend(legend_plot)



## 
p_comb <- 
  ggarrange(p1 + rremove("x.title"), 
            p2 + theme(legend.position = 'none'), 
            labels = c("A", "B"), ncol = 1, nrow = 2,
            heights = c(0.4, 1), 
            common.legend = F, 
            align = "v")
p_comb
fname <- paste0(dir.fig, 'es_combined_PANAS_POMS', postfix_subgroup, '_', today, vv, '.png'); fname
# func_ggsave(fname, w = 6, h = 5.5+1, save_png = T)


library(grid)
library(gridExtra)

fname <- gsub('.png', '_legend.png', fname); fname
png(filename = fname, width = 6, height = 5.5+1, units = 'in', res = 300)

grid.draw(p_comb)
sample_vp <- viewport(x = 1/3, y = 0, 
                      width = 1/3+0.2, height = 0.3,
                      just = c("left", "bottom")
                      )
pushViewport(sample_vp)
# grid.draw(roundrectGrob())
grid.draw(legend_made)
popViewport()

dev.off()


### the other way to combine plots -------------------------------------------------------
# fname <- gsub('.png', '2.png', fname); fname
# png(filename = fname, width = 6, height = 5.5+1, units = 'in', res = 300)
# library(grid)
# # Move to a new page
# grid.newpage()
# # Create layout : nrow = 3, ncol = 2
# pushViewport(viewport(layout = grid.layout(nrow = 4, ncol = 3)))
# # A helper function to define a region on the layout
# define_region <- function(row, col){
#   viewport(layout.pos.row = row, layout.pos.col = col)
# }
# # Arrange the plots
# print(p1 + rremove("x.title"), vp = define_region(row = 1, col = 1:2))   # Span over two columns
# print(p2, vp = define_region(row = 2:4, col = 1:3))
# print(legend_made, vp = define_region(row = 4, col = 2))
# dev.off()
```

**refs**
- http://www.sthda.com/english/articles/24-ggpubr-publication-ready-plots/81-ggplot2-easy-way-to-mix-multiple-graphs-on-the-same-page/
- https://rpkgs.datanovia.com/ggpubr/reference/rremove.html



## Using `metafor`

```{r eval=FALSE, include=FALSE}
library(metafor)

for (sub_ind_i in sub_indicator_selected) {
  
  exp_sub_mods_md2i <- exp_sub_mods_md2 %>%
    dplyr::filter(MH_indicator_o2 == sub_ind_i)
  
  dat1 <- metafor::escalc(
    data=exp_sub_mods_md2i,
    measure="SMD", 
    m1i=c_mean, sd1i=c_sd_r, n1i=c_n,
    m2i=e_mean, sd2i=e_sd_r, n2i=e_n)
  
  
  # Finally, a random-effects model can be fitted to these data with:
  res <- rma(yi, vi, data=dat1, digits=3)
  res
  ### fit equal- and random-effects models
  # rma(yi, vi, data=dat1, method="EE", digits=3)
  
  
  ### forest plot with extra annotations
  ###' https://wviechtb.github.io/metafor/reference/forest.default.html
  metafor::forest(
    x = res, 
    # atransf=exp, # transform the x-axis labels and annotations
    # at=log(c(0.05, 0.25, 1, 4)), xlim=c(-16,6),
    # ilab=cbind(tpos, tneg, cpos, cneg),
    # ilab.xpos=c(-9.5,-8,-6,-4.5),
    psize=1,
    cex=0.75, 
    header="Study label", 
    slab=study_label,
    showweights = T,
    mlab=sub_ind_i, 
    shade=TRUE)
  
  
  
  op <- par(cex=0.75, font=2)
  par(op)
  ### add text with Q-value, dfs, p-value, and I^2 statistic
  text(-16, -2, pos=4, cex=0.75, 
       bquote(paste("RE Model (Q = ", .(fmtx(res$QE, digits=2)),
                    ", df = ", .(res$k - res$p), ", ",
                    .(fmtp(res$QEp, digits=3, pname="p", add0=TRUE, sep=TRUE, equal=TRUE)), "; ",
                    I^2, " = ", .(fmtx(res$I2, digits=1)), "%)")))
  
  
  
  
  #### auto-report using reporter() function ----
  dir.report <- paste0('./figures/'); dir.report
  # metafor::reporter(res, dir = dir.report)
  
  ### save as PDF
  # reporter(res, format="pdf", 
  #          dir = paste0(dir.root, '/figures/'), 
  #          filename = 'report_metafor.PDF')
  #          
  # reporter(res, format="word")

  ### add an outlier
  # dat$yi[6] <- 2.5
  # res <- rma(yi, vi, data=dat)
  # reporter(res)
  
}
```



  There is no statistical reason why studies with change-from-baseline outcomes should not be combined in a meta-analysis with studies with post-intervention measurement outcomes when using the (unstandardized) MD method. [link](https://training.cochrane.org/handbook/current/chapter-10#section-10-5)
  In contrast, post-intervention value and change scores should not in principle be combined using standard meta-analysis approaches when the effect measure is an SMD. The SD when standardizing post-intervention values reflects between-person variability at a single point in time. The SD when standardizing change scores reflects variation in between-person changes over time, so will depend on both within-person and between-person variability
  
## Missing data
  This is often a problem when change-from-baseline outcomes are sought. We discuss imputation of missing SDs in Chapter 6, Section 6.5.2.8
  